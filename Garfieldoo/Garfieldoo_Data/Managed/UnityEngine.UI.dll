   border-radius: 0;
  }
  --cr-input-error-display: none;
  --cr-input-input: {
    border-bottom: 1px solid var(--paper-grey-800);
  }
  --cr-input-padding-end: 0;
  --cr-input-padding-start: 0;
  --cr-input-padding-bottom: 2px;
  --cr-input-padding-top: 2px;
  align-self: center;
  flex-grow: 1;
  font-size: 12px;
  margin-inline-end: 31px;
}

.sink-subtext {
  color: var(--paper-grey-600);
  padding-top: 8px;
}

.sink-text {
  flex-flow: row nowrap;
  line-height: normal;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 275px;
}
// Copyright 2015 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

/**
 * This Polymer element contains the entire media router interface. It handles
 * hiding and showing specific components.
 * @implements {MediaRouterContainerInterface}
 */
Polymer({
  is: 'media-router-container',

  properties: {
    /**
     * The list of available sinks.
     * @type {!Array<!media_router.Sink>}
     */
    allSinks: {
      type: Array,
      value: [],
      observer: 'reindexSinksAndRebuildSinksToShow_',
    },

    /**
     * The last promise in a chain that will be fulfilled when the current
     * animation has finished. It does not return a value; it is strictly a
     * synchronization mechanism.
     * @private {!Promise}
     */
    animationPromise_: {
      type: Object,
      value: function() {
        return Promise.resolve();
      },
    },

    /**
     * The list of CastModes to show.
     * @type {!Array<!media_router.CastMode>|undefined}
     */
    castModeList: {
      type: Array,
      observer: 'checkCurrentCastMode_',
    },

    /**
     * The ID of the Sink currently being launched.
     * @private {string}
     * TODO(crbug.com/616604): Use per-sink route creation state.
     */
    currentLaunchingSinkId_: {
      type: String,
      value: '',
    },

    /**
     * The current route.
     * @private {?media_router.Route|undefined}
     */
    currentRoute_: {
      type: Object,
    },

    /**
     * The current view to be shown.
     * @private {?media_router.MediaRouterView|undefined}
     */
    currentView_: {
      type: String,
      observer: 'currentViewChanged_',
    },

    /**
     * The URL to open when the device missing link is clicked.
     * @type {string|undefined}
     */
    deviceMissingUrl: {
      type: String,
    },

    /**
     * The height of the dialog.
     * @private {number}
     */
    dialogHeight_: {
      type: Number,
      value: 330,
    },

    /**
     * The time |this| element calls ready().
     * @private {number|undefined}
     */
    elementReadyTimeMs_: {
      type: Number,
    },

    /**
     * Animation player used for running filter transition animations.
     * @private {?Animation}
     */
    filterTransitionPlayer_: {
      type: Object,
      value: null,
    },

    /**
     * The URL to open when the cloud services pref learn more link is clicked.
     * @type {string|undefined}
     */
    firstRunFlowCloudPrefLearnMoreUrl: {
      type: String,
    },

    /**
     * The URL to open when the first run flow learn more link is clicked.
     * @type {string|undefined}
     */
    firstRunFlowLearnMoreUrl: {
      type: String,
    },

    /**
     * The header text for the sink list.
     * @type {string|undefined}
     */
    headerText: {
      type: String,
    },

    /**
     * The header text tooltip. This would be descriptive of the
     * source origin, whether a host name, tab URL, etc.
     * @type {string|undefined}
     */
    headerTextTooltip: {
      type: String,
    },

    /**
     * An animation player that is used for running dialog height adjustments.
     * @private {?Animation}
     */
    heightAdjustmentPlayer_: {
      type: Object,
      value: null,
    },

    /**
     * Whether the sink list is being hidden for animation purposes.
     * @private {boolean}
     */
    hideSinkListForAnimation_: {
      type: Boolean,
      value: false,
    },

    /**
     * Records whether the search input is focused when a window blur event is
     * received. This is used to handle search focus edge cases. See
     * |setSearchFocusHandlers_| for details.
     * @private {boolean}
     */
    isSearchFocusedOnWindowBlur_: {
      type: Boolean,
      value: false,
    },

    /**
     * Whether the search list is currently hidden.
     * @private {boolean}
     */
    isSearchListHidden_: {
      type: Boolean,
      value: true,
    },

    /**
     * The issue to show.
     * @type {?media_router.Issue}
     */
    issue: {
      type: Object,
      value: null,
      observer: 'maybeShowIssueView_',
    },

    /**
     * Whether the MR UI was just opened.
     * @private {boolean}
     */
    justOpened_: {
      type: Boolean,
      value: true,
    },

    /**
     * Whether the user's mouse is positioned over the dialog.
     * @private {boolean|undefined}
     */
    mouseIsPositionedOverDialog_: {
      type: Boolean,
    },

    /**
     * The ID of the route that is currently being created. This is set when
     * route creation is resolved but not ready for its controls to be
     * displayed.
     * @private {string|undefined}
     */
    pendingCreatedRouteId_: {
      type: String,
    },

    /**
     * The time the sink list was shown and populated with at least one sink.
     * This is reset whenever the user switches views or there are no sinks
     * available for display.
     * @private {number}
     */
    populatedSinkListSeenTimeMs_: {
      type: Number,
      value: -1,
    },

    /**
     * Pseudo sinks from MRPs that represent their ability to accept sink search
     * requests.
     * @private {!Array<!media_router.Sink>}
     */
    pseudoSinks_: {
      type: Array,
      value: [],
    },

    /**
     * Helps manage the state of creating a sink and a route from a pseudo sink.
     * @private {PseudoSinkSearchState|undefined}
     */
    pseudoSinkSearchState_: {
      type: Object,
    },

    /**
     * Whether the next character input should cause a filter action metric to
     * be sent.
     * @type {boolean}
     * @private
     */
    reportFilterOnInput_: {
      type: Boolean,
      value: false,
    },

    /**
     * The list of current routes.
     * @type {!Array<!media_router.Route>|undefined}
     */
    routeList: {
      type: Array,
      observer: 'rebuildRouteMaps_',
    },

    /**
     * Maps media_router.Route.id to corresponding media_router.Route.
     * @private {!Object<!string, !media_router.Route>|undefined}
     */
    routeMap_: {
      type: Object,
    },

    /**
     * Whether the search feature is enabled and we should show the search
     * input.
     * @private {boolean}
     */
    searchEnabled_: {
      type: Boolean,
      value: false,
      observer: 'searchEnabledChanged_',
    },

    /**
     * Search text entered by the user into the sink search input.
     * @private {string}
     */
    searchInputText_: {
      type: String,
      value: '',
      observer: 'searchInputTextChanged_',
    },

    /**
     * Sinks to display that match |searchInputText_|.
     * @private {!Array<!{sinkItem: !media_router.Sink,
     *                    substrings: Array<!Array<number>>}>|undefined}
     */
    searchResultsToShow_: {
      type: Array,
    },

    /**
     * The selected cast mode menu item. The item with this index is bolded in
     * the cast mode menu.
     * @private {number|undefined}
     */
    selectedCastModeMenuItem_: {
      type: Number,
      observer: 'updateSelectedCastModeMenuItem_',
    },

    /**
     * Whether to show the user domain of sinks associated with identity.
     * @type {boolean|undefined}
     */
    showDomain: {
      type: Boolean,
    },

    /**
     * Whether to show the first run flow.
     * @type {boolean|undefined}
     */
    showFirstRunFlow: {
      type: Boolean,
      observer: 'updateElementPositioning_',
    },

    /**
     * Whether to show the cloud preference setting in the first run flow.
     * @type {boolean|undefined}
     */
    showFirstRunFlowCloudPref: {
      type: Boolean,
    },

    /**
     * The cast mode shown to the user. Initially populated within
     * |rebuildSinksToShow_()|.
     * This value may be changed in one of the following ways:
     * 1) The user explicitly selected a cast mode.
     * 2) The user selected cast mode is no longer available for the associated
     *    WebContents. In this case, the container will reset to auto mode. Note
     *    that |userHasSelectedCastMode_| will switch back to false.
     * 3) The sink list changed, and the user had not explicitly selected a cast
     *    mode. If the sinks support exactly 1 cast mode, the container will
     *    switch to that cast mode. Otherwise, the container will reset to auto
     *    mode.
     * @private {number}
     */
    shownCastModeValue_: Number,

    /**
     * Max height for the sink list.
     * @private {number}
     */
    sinkListMaxHeight_: {
      type: Number,
      value: 0,
    },

    /**
     * Maps media_router.Sink.id to corresponding media_router.Sink.
     * @private {!Object<!string, !media_router.Sink>|undefined}
     */
    sinkMap_: {
      type: Object,
    },

    /**
     * Maps media_router.Sink.id to corresponding media_router.Route.
     * @private {!Object<!string, !media_router.Route>}
     */
    sinkToRouteMap_: {
      type: Object,
      value: {},
    },

    /**
     * Sinks to show for the currently selected cast mode.
     * @private {!Array<!media_router.Sink>|undefined}
     */
    sinksToShow_: {
      type: Array,
      observer: 'updateElementPositioning_',
    },

    /**
     * Whether the user has explicitly selected a cast mode.
     * @private {boolean}
     */
    userHasSelectedCastMode_: {
      type: Boolean,
      value: false,
    },

    /**
     * Whether the user has already taken an action.
     * @type {boolean}
     */
    userHasTakenInitialAction_: {
      type: Boolean,
      value: false,
    },
  },

  behaviors: [
    I18nBehavior,
  ],

  observers: [
    'maybeUpdateStartSinkDisplayStartTime_(currentView_, sinksToShow_)',
  ],

  ready: function() {
    this.elementReadyTimeMs_ = window.performance.now();
    this.showSinkList_();

    Polymer.RenderStatus.afterNextRender(this, function() {
      // Import the elements that aren't needed at startup. This reduces
      // initial load time. Delayed loading interferes with getting the
      // offsetHeight of the first-run-flow element in updateElementPositioning_
      // though, so we also make sure it is called after the last load.
      var that = this;
      var loadsRemaining = 3;
      var onload = function() {
        loadsRemaining--;
        if (loadsRemaining > 0) {
          return;
        }
        that.updateElementPositioning_();
        if (that.currentView_ == media_router.MediaRouterView.SINK_LIST) {
          that.putSearchAtBottom_();
        }
      };
      this.importHref(
          'chrome://resources/polymer/v1_0/neon-animation/' +
              'web-animations.html',
          onload);
      this.importHref(
          this.resolveUrl('../issue_banner/issue_banner.html'), onload);
      this.importHref(
          this.resolveUrl(
              '../media_router_search_highlighter/' +
              'media_router_search_highlighter.html'),
          onload);

      // If this is not on a Mac platform, remove the placeholder. See
      // onFocus_() for more details. ready() is only called once, so no need
      // to check if the placeholder exist before removing.
      if (!cr.isMac) {
        this.$$('#focus-placeholder').remove();
      }

      document.addEventListener('keydown', this.onKeydown_.bind(this), true);
      this.listen(this, 'focus', 'onFocus_');
      this.listen(this, 'header-height-changed', 'updateElementPositioning_');
      this.listen(this, 'header-or-arrow-click', 'toggleCastModeHidden_');
      this.listen(this, 'mouseleave', 'onMouseLeave_');
      this.listen(this, 'mouseenter', 'onMouseEnter_');

      // Turn off the spinner after 3 seconds, then report the current number of
      // sinks.
      this.async(function() {
        this.justOpened_ = false;
        // |pseudoSinks_| does not contain pseudo sinks without a domain, so it
        // cannot be used for calculating the number of real sinks.
        var realSinks = this.allSinks.filter(function(sink) {
          return !sink.isPseudoSink;
        });
        this.fire('report-sink-count', {
          sinkCount: realSinks.length,
        });
      }, 3000 /* 3 seconds */);

      // For Mac platforms, request data after a short delay after load. This
      // appears to speed up initial data load time on Mac.
      if (cr.isMac) {
        this.async(function() {
          this.fire('request-initial-data');
        }, 25 /* 0.025 seconds */);
      }
    });
  },

  /**
   * Fires an acknowledge-first-run-flow event and hides the first run flow.
   * This is call when the first run flow button is clicked.
   *
   * @private
   */
  acknowledgeFirstRunFlow_: function() {
    // Only set |userOptedIntoCloudServices| if the user was shown the cloud
    // services preferences option.
    var userOptedIntoCloudServices = this.showFirstRunFlowCloudPref ?
        this.$$('#first-run-cloud-checkbox').checked :
        undefined;
    this.fire('acknowledge-first-run-flow', {
      optedIntoCloudServices: userOptedIntoCloudServices,
    });

    this.showFirstRunFlow = false;
    this.showFirstRunFlowCloudPref = false;
  },

  /**
   * Fires a 'report-initial-action' event when the user takes their first
   * action after the dialog opens. Also fires a 'report-initial-action-close'
   * event if that initial action is to close the dialog.
   * @param {!media_router.MediaRouterUserAction} initialAction
   */
  maybeReportUserFirstAction: function(initialAction) {
    if (this.userHasTakenInitialAction_) {
      return;
    }

    this.fire('report-initial-action', {
      action: initialAction,
    });

    if (initialAction == media_router.MediaRouterUserAction.CLOSE) {
      var timeToClose = window.performance.now() - this.elementReadyTimeMs_;
      this.fire('report-initial-action-close', {
        timeMs: timeToClose,
      });
    }

    this.userHasTakenInitialAction_ = true;
  },

  get header() {
    return this.$['container-header'];
  },

  /**
   * Calls all the functions to set the UI to a given cast mode.
   * @param {!media_router.CastMode} castMode The cast mode to set things to.
   * @private
   */
  castModeSelected_(castMode) {
    this.selectCastMode(castMode.type);
    this.fire('cast-mode-selected', {castModeType: castMode.type});
    this.showSinkList_();
    this.maybeReportUserFirstAction(
        media_router.MediaRouterUserAction.CHANGE_MODE);
  },

  /**
   * Checks that the currently selected cast mode is still in the
   * updated list of available cast modes. If not, then update the selected
   * cast mode to the first available cast mode on the list.
   */
  checkCurrentCastMode_: function() {
    if (!this.castModeList.length) {
      return;
    }

    // If there is a forced mode make sure it is shown.
    if (this.findForcedCastMode_()) {
      this.rebuildSinksToShow_();
    }

    // If we are currently showing auto mode, then nothing needs to be done.
    // Otherwise, if the cast mode currently shown no longer exists (regardless
    // of whether it was selected by user), then switch back to auto cast mode.
    if (this.shownCastModeValue_ != media_router.CastModeType.AUTO &&
        !this.findCastModeByType_(this.shownCastModeValue_)) {
      this.setShownCastMode_(media_router.AUTO_CAST_MODE);
      this.rebuildSinksToShow_();
    }
  },

  /**
   * Compares two search match objects for sorting. Earlier and longer matches
   * are prioritized.
   *
   * @param {!{sinkItem: !media_router.Sink,
   *           substrings: Array<!Array<number>>}} resultA
   * Parameters in |resultA|:
   *   sinkItem - sink object.
   *   substrings - start-end index pairs of substring matches.
   * @param {!{sinkItem: !media_router.Sink,
   *           substrings: Array<!Array<number>>}} resultB
   * Parameters in |resultB|:
   *   sinkItem - sink object.
   *   substrings - start-end index pairs of substring matches.
   * @return {number} -1 if |resultA| should come before |resultB|, 1 if
   *     |resultB| should come before |resultA|, and 0 if they are considered
   *     equal.
   */
  compareSearchMatches_: function(resultA, resultB) {
    var substringsA = resultA.substrings;
    var substringsB = resultB.substrings;
    var numberSubstringsA = substringsA.length;
    var numberSubstringsB = substringsB.length;

    if (numberSubstringsA == 0 && numberSubstringsB == 0) {
      return 0;
    } else if (numberSubstringsA == 0) {
      return 1;
    } else if (numberSubstringsB == 0) {
      return -1;
    }

    var loopMax = Math.min(numberSubstringsA, numberSubstringsB);
    for (var i = 0; i < loopMax; ++i) {
      var [matchStartA, matchEndA] = substringsA[i];
      var [matchStartB, matchEndB] = substringsB[i];

      if (matchStartA < matchStartB) {
        return -1;
      } else if (matchStartA > matchStartB) {
        return 1;
      }

      if (matchEndA > matchEndB) {
        return -1;
      } else if (matchEndA < matchEndB) {
        return 1;
      }
    }

    if (numberSubstringsA > numberSubstringsB) {
      return -1;
    } else if (numberSubstringsA < numberSubstringsB) {
      return 1;
    }
    return 0;
  },

  /**
   * Returns a duration in ms from a distance in pixels using a default speed of
   * 1000 pixels per second.
   * @param {number} distance Number of pixels that will be traveled.
   * @private
   */
  computeAnimationDuration_: function(distance) {
    // The duration of the animation can be found by abs(distance)/speed, where
    // speed is fixed at 1000 pixels per second, or 1 pixel per millisecond.
    return Math.abs(distance);
  },

  /**
   * If there is a forced cast mode, returns that cast mode.  If |allSinks|
   * supports only a single cast mode, returns that cast mode.  Otherwise,
   * returns AUTO_MODE. Only called if |userHasSelectedCastMode_| is |false|.
   *
   * @return {!media_router.CastMode} The single cast mode supported by
   *                                  |allSinks|, or AUTO_MODE.
   */
  computeCastMode_: function() {
    /** @const */ var forcedMode = this.findForcedCastMode_();
    if (forcedMode) {
      return forcedMode;
    }

    var allCastModes = this.allSinks.reduce(function(castModesSoFar, sink) {
      // Ignore pseudo sinks in the cast mode computation.
      return castModesSoFar | (sink.isPseudoSink ? 0 : sink.castModes);
    }, 0);

    // This checks whether |castModes| does not consist of exactly 1 cast mode.
    if (!allCastModes || allCastModes & (allCastModes - 1)) {
      return media_router.AUTO_CAST_MODE;
    }

    var castMode = this.findCastModeByType_(allCastModes);
    if (castMode) {
      return castMode;
    }

    console.error('Cast mode ' + allCastModes + ' not in castModeList');
    return media_router.AUTO_CAST_MODE;
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @return {boolean} Whether or not to hide the cast mode list.
   * @private
   */
  computeCastModeListHidden_: function(view) {
    return view != media_router.MediaRouterView.CAST_MODE_LIST;
  },

  /**
   * @param {!media_router.CastMode} castMode The cast mode to determine an
   *     icon for.
   * @return {string} The icon to use.
   * @private
   */
  computeCastModeIcon_: function(castMode) {
    switch (castMode.type) {
      case media_router.CastModeType.PRESENTATION:
        return 'media-router:web';
      case media_router.CastModeType.TAB_MIRROR:
        return 'media-router:tab';
      case media_router.CastModeType.DESKTOP_MIRROR:
        return 'media-router:laptop';
      case media_router.CastModeType.LOCAL_FILE:
        return 'media-router:folder';
      default:
        return '';
    }
  },

  /**
   * @param {!Array<!media_router.CastMode>} castModeList The current list of
   *     cast modes.
   * @return {!Array<!media_router.CastMode>} The list of PRESENTATION cast
   *     modes.
   * @private
   */
  computePresentationCastModeList_: function(castModeList) {
    return castModeList.filter(function(mode) {
      return mode.type == media_router.CastModeType.PRESENTATION;
    });
  },

  /**
   * @param {!Array<!media_router.Sink>} sinksToShow The list of sinks.
   * @return {boolean} Whether or not to hide the 'devices missing' message.
   * @private
   */
  computeDeviceMissingHidden_: function(sinksToShow) {
    return sinksToShow.length != 0;
  },

  /**
   * @param {?Element} element Element to compute padding for.
   * @return {number} Computes the amount of vertical padding (top + bottom) on
   *     |element|.
   * @private
   */
  computeElementVerticalPadding_: function(element) {
    var paddingBottom, paddingTop;
    [paddingBottom, paddingTop] = this.getElementVerticalPadding_(element);
    return paddingBottom + paddingTop;
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @param {?media_router.Issue} issue The current issue.
   * @return {boolean} Whether or not to hide the header.
   * @private
   */
  computeHeaderHidden_: function(view, issue) {
    return view == media_router.MediaRouterView.ROUTE_DETAILS ||
        (view == media_router.MediaRouterView.SINK_LIST && !!issue &&
         issue.isBlocking);
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @param {string} headerText The header text for the sink list.
   * @return {string|undefined} The text for the header.
   * @private
   */
  computeHeaderText_: function(view, headerText) {
    switch (view) {
      case media_router.MediaRouterView.CAST_MODE_LIST:
        return this.i18n('selectCastModeHeaderText');
      case media_router.MediaRouterView.ISSUE:
        return this.i18n('issueHeaderText');
      case media_router.MediaRouterView.ROUTE_DETAILS:
        return this.currentRoute_ && this.sinkMap_[this.currentRoute_.sinkId] ?
            this.sinkMap_[this.currentRoute_.sinkId].name :
            '';
      case media_router.MediaRouterView.SINK_LIST:
      case media_router.MediaRouterView.FILTER:
        return this.headerText;
      default:
        return '';
    }
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @param {string} headerTooltip The tooltip for the header for the sink
   *     list.
   * @return {string} The tooltip for the header.
   * @private
   */
  computeHeaderTooltip_: function(view, headerTooltip) {
    return view == media_router.MediaRouterView.SINK_LIST ? headerTooltip : '';
  },

  /**
   * @param {string} currentLaunchingSinkId ID of the sink that is currently
   *     launching, or empty string if none exists.
   * @private
   */
  computeIsLaunching_: function(currentLaunchingSinkId) {
    return currentLaunchingSinkId != '';
  },

  /**
   * @param {?media_router.Issue} issue The current issue.
   * @return {string} The class for the issue banner.
   * @private
   */
  computeIssueBannerClass_: function(issue) {
    return !!issue && !issue.isBlocking ? 'non-blocking' : '';
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @param {?media_router.Issue} issue The current issue.
   * @return {boolean} Whether or not to show the issue banner.
   * @private
   */
  computeIssueBannerShown_: function(view, issue) {
    return !!issue &&
        (view == media_router.MediaRouterView.CAST_MODE_LIST ||
         view == media_router.MediaRouterView.SINK_LIST ||
         view == media_router.MediaRouterView.FILTER ||
         view == media_router.MediaRouterView.ISSUE);
  },

  /**
   * @param {!Array<!{sinkItem: !media_router.Sink,
   *                  substrings: Array<!Array<number>>}>} searchResultsToShow
   *     The sinks currently matching the search text.
   * @param {boolean} isSearchListHidden Whether the search list is hidden.
   * @return {boolean} Whether or not the 'no matches' message is hidden.
   * @private
   */
  computeNoMatchesHidden_: function(searchResultsToShow, isSearchListHidden) {
    return isSearchListHidden || this.searchInputText_.length == 0 ||
        searchResultsToShow.length != 0;
  },

  /**
   * @param {!Array<!media_router.CastMode>} castModeList The current list of
   *     cast modes.
   * @return {!Array<!media_router.CastMode>} The list of non-PRESENTATION cast
   *     modes. Also excludes LOCAL_FILE.
   * @private
   */
  computeShareScreenCastModeList_: function(castModeList) {
    return castModeList.filter(function(mode) {
      return mode.type == media_router.CastModeType.DESKTOP_MIRROR ||
          mode.type == media_router.CastModeType.TAB_MIRROR;
    });
  },

  /**
   * @param {!Array<!media_router.CastMode>} castModeList The current list of
   *     cast modes.
   * @return {!Array<!media_router.CastMode>} The list of local media cast
   *     modes.
   * @private
   */
  computeLocalMediaCastModeList_: function(castModeList) {
    return castModeList.filter(function(mode) {
      return mode.type == media_router.CastModeType.LOCAL_FILE;
    });
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @param {?media_router.Issue} issue The current issue.
   * @return {boolean} Whether or not to hide the route details.
   * @private
   */
  computeRouteDetailsHidden_: function(view, issue) {
    return view != media_router.MediaRouterView.ROUTE_DETAILS ||
        (!!issue && issue.isBlocking);
  },

  /**
   * Computes an array of substring indices that mark where substrings of
   * |searchString| occur in |sinkName|.
   *
   * @param {string} searchString Search string entered by user.
   * @param {string} sinkName Sink name being filtered.
   * @return {Array<!Array<number>>} Array of substring start-end (inclusive)
   *     index pairs if every character in |searchString| was matched, in order,
   *     in |sinkName|. Otherwise it returns null.
   * @private
   */
  computeSearchMatches_: function(searchString, sinkName) {
    var i = 0;
    var matchStart = -1;
    var matchEnd = -1;
    var matchPairs = [];
    for (var j = 0; i < searchString.length && j < sinkName.length; ++j) {
      if (searchString[i].toLocaleLowerCase() ==
          sinkName[j].toLocaleLowerCase()) {
        if (matchStart == -1) {
          matchStart = j;
        }
        ++i;
      } else if (matchStart != -1) {
        matchEnd = j - 1;
        matchPairs.push([matchStart, matchEnd]);
        matchStart = -1;
      }
    }
    if (matchStart != -1) {
      matchEnd = j - 1;
      matchPairs.push([matchStart, matchEnd]);
    }
    return (i == searchString.length) ? matchPairs : null;
  },

  /**
   * Computes whether the search results list should be hidden.
   * @param {!Array<!{sinkItem: !media_router.Sink,
   *                  substrings: Array<!Array<number>>}>} searchResultsToShow
   *     The sinks currently matching the search text.
   * @param {boolean} isSearchListHidden Whether the search list is hidden.
   * @return {boolean} Whether the search results list should be hidden.
   * @private
   */
  computeSearchResultsHidden_: function(
      searchResultsToShow, isSearchListHidden) {
    return isSearchListHidden || searchResultsToShow.length == 0;
  },

  /**
   * @param {!Array<!media_router.CastMode>} castModeList The current list of
   *     cast modes.
   * @return {boolean} Whether or not to hide the share screen subheading text.
   * @private
   */
  computeShareScreenSubheadingHidden_: function(castModeList) {
    return this.computeShareScreenCastModeList_(castModeList).length == 0;
  },

  /**
   * @param {!Array<!media_router.CastMode>} castModeList The current list of
   *     cast modes.
   * @return {boolean} Whether or not to hide the local media subheading text.
   * @private
   */
  computeLocalMediaSubheadingHidden_: function(castModeList) {
    return this.computeLocalMediaCastModeList_(castModeList).length == 0;
  },

  /**
   * @param {boolean} showFirstRunFlow Whether or not to show the first run
   *     flow.
   * @param {?media_router.MediaRouterView} currentView The current view.
   * @private
   */
  computeShowFirstRunFlow_: function(showFirstRunFlow, currentView) {
    return showFirstRunFlow &&
        currentView == media_router.MediaRouterView.SINK_LIST;
  },

  /**
   * @param {!media_router.Sink} sink The sink to determine an icon for.
   * @return {string} The icon to use.
   * @private
   */
  computeSinkIcon_: function(sink) {
    switch (sink.iconType) {
      case media_router.SinkIconType.CAST:
        return 'media-router:chromecast';
      case media_router.SinkIconType.CAST_AUDIO_GROUP:
        return 'media-router:speaker-group';
      case media_router.SinkIconType.CAST_AUDIO:
        return 'media-router:speaker';
      case media_router.SinkIconType.MEETING:
        return 'media-router:meeting';
      case media_router.SinkIconType.HANGOUT:
        return 'media-router:hangout';
      case media_router.SinkIconType.EDUCATION:
        return 'media-router:education';
      case media_router.SinkIconType.WIRED_DISPLAY:
        return 'media-router:tv';
      case media_router.SinkIconType.GENERIC:
        return 'media-router:tv';
      default:
        return 'media-router:tv';
    }
  },

  /**
   * @param {!string} sinkId A sink ID.
   * @param {!Object<!string, ?media_router.Route>} sinkToRouteMap
   *     Maps media_router.Sink.id to corresponding media_router.Route.
   * @return {string} The class for the sink icon.
   * @private
   */
  computeSinkIconClass_: function(sinkId, sinkToRouteMap) {
    return sinkToRouteMap[sinkId] ? 'sink-icon active-sink' : 'sink-icon';
  },

  /**
   * @param {!string} currentLaunchingSinkId The ID of the sink that is
   *     currently launching.
   * @param {!string} sinkId A sink ID.
   * @return {boolean} |true| if given sink is currently launching.
   * @private
   */
  computeSinkIsLaunching_: function(currentLaunchingSinkId, sinkId) {
    return currentLaunchingSinkId == sinkId;
  },

  /**
   * @param {!Array<!media_router.Sink>} sinksToShow The list of sinks.
   * @return {boolean} Whether or not to hide the sink list.
   * @private
   */
  computeSinkListHidden_: function(sinksToShow) {
    return sinksToShow.length == 0;
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @param {?media_router.Issue} issue The current issue.
   * @return {boolean} Whether or not to hide entire the sink list view.
   * @private
   */
  computeSinkListViewHidden_: function(view, issue) {
    return (view != media_router.MediaRouterView.SINK_LIST &&
            view != media_router.MediaRouterView.FILTER) ||
        (!!issue && issue.isBlocking);
  },

  /**
   * Returns whether the sink domain for |sink| should be hidden.
   * @param {!media_router.Sink} sink
   * @return {boolean} |true| if the domain should be hidden.
   * @private
   */
  computeSinkDomainHidden_: function(sink) {
    return !this.showDomain || this.isEmptyOrWhitespace_(sink.domain);
  },

  /**
   * Computes which portions of a sink name, if any, should be highlighted when
   * displayed in the filter view. Any substrings matching the search text
   * should be highlighted.
   *
   * The order the strings are combined is plainText[0] highlightedText[0]
   * plainText[1] highlightedText[1] etc.
   *
   * @param {!{sinkItem: !media_router.Sink,
   *           substrings: !Array<!Array<number>>}} matchedItem
   * Parameters in matchedItem:
   *   sinkItem - Original !media_router.Sink from the sink list.
   *   substrings - List of index pairs denoting substrings of sinkItem.name
   *       that match |searchInputText_|.
   * @return {!{highlightedText: !Array<string>, plainText: !Array<string>}}
   *   highlightedText - Array of strings that should be displayed highlighted.
   *   plainText - Array of strings that should be displayed normally.
   * @private
   */
  computeSinkMatchingText_: function(matchedItem) {
    if (!matchedItem.substrings) {
      return {highlightedText: [null], plainText: [matchedItem.sinkItem.name]};
    }
    var lastMatchIndex = -1;
    var nameIndex = 0;
    var sinkName = matchedItem.sinkItem.name;
    var highlightedText = [];
    var plainText = [];
    for (var i = 0; i < matchedItem.substrings.length; ++i) {
      var [matchStart, matchEnd] = matchedItem.substrings[i];
      if (lastMatchIndex + 1 < matchStart) {
        plainText.push(sinkName.substring(lastMatchIndex + 1, matchStart));
      } else {
        plainText.push(null);
      }
      highlightedText.push(sinkName.substring(matchStart, matchEnd + 1));
      lastMatchIndex = matchEnd;
    }
    if (lastMatchIndex + 1 < sinkName.length) {
      highlightedText.push(null);
      plainText.push(sinkName.substring(lastMatchIndex + 1));
    }
    return {highlightedText: highlightedText, plainText: plainText};
  },

  /**
   * Returns the subtext to be shown for |sink|. Only called if
   * |computeSinkSubtextHidden_| returns false for the same |sink| and
   * |sinkToRouteMap|.
   * @param {!media_router.Sink} sink
   * @param {!Object<!string, ?media_router.Route>} sinkToRouteMap
   * @return {?string} The subtext to be shown.
   * @private
   */
  computeSinkSubtext_: function(sink, sinkToRouteMap) {
    var route = sinkToRouteMap[sink.id];
    if (route && !this.isEmptyOrWhitespace_(route.description)) {
      return route.description;
    }

    return sink.description;
  },

  /**
   * Returns whether the sink subtext for |sink| should be hidden.
   * @param {!media_router.Sink} sink
   * @param {!Object<!string, ?media_router.Route>} sinkToRouteMap
   * @return {boolean} |true| if the subtext should be hidden.
   * @private
   */
  computeSinkSubtextHidden_: function(sink, sinkToRouteMap) {
    if (!this.isEmptyOrWhitespace_(sink.description)) {
      return false;
    }

    var route = sinkToRouteMap[sink.id];
    return !route || this.isEmptyOrWhitespace_(route.description);
  },

  /**
   * @param {boolean} justOpened Whether the MR UI was just opened.
   * @return {boolean} Whether or not to hide the spinner.
   * @private
   */
  computeSpinnerHidden_: function(justOpened) {
    return !justOpened;
  },

  /**
   * Computes the height of the sink list view element when search results are
   * being shown.
   *
   * @param {?Element} deviceMissing No devices message element.
   * @param {?Element} noMatches No search matches element.
   * @param {?Element} results Search results list element.
   * @param {number} searchOffsetHeight Search input container element height.
   * @param {number} maxHeight Max height of the list elements.
   * @return {number} The height of the sink list view when search results are
   *     being shown.
   * @private
   */
  computeTotalSearchHeight_: function(
      deviceMissing, noMatches, results, searchOffsetHeight, maxHeight) {
    var contentHeight = deviceMissing.offsetHeight +
        ((noMatches.hasAttribute('hidden')) ? results.offsetHeight :
                                              noMatches.offsetHeight);
    return Math.min(contentHeight, maxHeight) + searchOffsetHeight;
  },

  /**
   * Updates element positioning when the view changes and possibly triggers
   * reporting of a user filter action. If there is no filter text, it defers
   * the reporting until some text is entered, but otherwise it reports the
   * filter action here.
   * @param {?media_router.MediaRouterView} currentView The current view of the
   *     dialog.
   * @param {?media_router.MediaRouterView} previousView The previous
   *     |currentView|.
   * @private
   */
  currentViewChanged_: function(currentView, previousView) {
    if (currentView == media_router.MediaRouterView.FILTER) {
      this.reportFilterOnInput_ = true;
      this.maybeReportFilter_();
    }
    this.updateElementPositioning_();

    if (previousView == media_router.MediaRouterView.ROUTE_DETAILS) {
      media_router.browserApi.onMediaControllerClosed();
      if (this.$$('route-details')) {
        this.$$('route-details').onClosed();
      }
    }
  },

  /**
   * Filters all sinks based on fuzzy matching to the currently entered search
   * text.
   * @param {string} searchInputText The currently entered search text.
   * @private
   */
  filterSinks_: function(searchInputText) {
    if (searchInputText.length == 0) {
      this.searchResultsToShow_ = this.sinksToShow_.map(function(item) {
        return {sinkItem: item, substrings: null};
      });
      return;
    }

    var searchResultsToShow = [];
    for (var i = 0; i < this.sinksToShow_.length; ++i) {
      var matchSubstrings = this.computeSearchMatches_(
          searchInputText, this.sinksToShow_[i].name);
      if (!matchSubstrings) {
        continue;
      }
      searchResultsToShow.push(
          {sinkItem: this.sinksToShow_[i], substrings: matchSubstrings});
    }
    searchResultsToShow.sort(this.compareSearchMatches_);

    var pendingPseudoSink = (this.pseudoSinkSearchState_) ?
        this.pseudoSinkSearchState_.getPseudoSink() :
        null;
    // We may need to add pseudo sinks to the filter results. A pseudo sink will
    // be shown if there is no real sink with the same icon and name exactly
    // matching the filter text. The map() call transforms any pseudo sink
    // objects that will be shown to the search result format, where we know
    // that the entire sink name will be a match.
    //
    // The exception to this is when there is a pending pseudo sink search. Then
    // the pseudo sink for the search will be treated like a real sink because
    // it will actually be in |sinksToShow_| until a real sink is returned by
    // search. So the filter here shouldn't treat it like a pseudo sink.
    searchResultsToShow =
        this.pseudoSinks_
            .filter(function(pseudoSink) {
              return (!pendingPseudoSink ||
                      pseudoSink.id != pendingPseudoSink.id) &&
                  !searchResultsToShow.find(function(searchResult) {
                    return searchResult.sinkItem.name == searchInputText &&
                        searchResult.sinkItem.iconType == pseudoSink.iconType;
                  });
            })
            .map(function(pseudoSink) {
              pseudoSink.name = searchInputText;
              return {
                sinkItem: pseudoSink,
                substrings: [[0, searchInputText.length - 1]]
              };
            })
            .concat(searchResultsToShow);
    this.searchResultsToShow_ = searchResultsToShow;
  },

  /**
   * Helper function to locate the CastMode object with the given type in
   * castModeList.
   *
   * @param {number} castModeType Type of cast mode to look for.
   * @return {media_router.CastMode|undefined} CastMode object with the given
   *     type in castModeList, or undefined if not found.
   * @private
   */
  findCastModeByType_: function(castModeType) {
    return this.castModeList.find(function(element, index, array) {
      return element.type == castModeType;
    });
  },

  /**
   * Helper function to locate the position in the |castModeList| of the
   * CastMode object with the given type.
   *
   * @param {number} castModeType Type of cast mode to look for.
   * @return {number} index of the given type, or -1 if not found.
   * @private
   */
  findCastModeIndexByType_: function(castModeType) {
    return this.castModeList
        .map(function(element) {
          return element.type;
        })
        .indexOf(castModeType);
  },


  /**
   * Helper function to return a forced CastMode, if any.
   *
   * @return {media_router.CastMode|undefined} CastMode object with
   *     isForced = true, or undefined if not found.
   * @private
   */
  findForcedCastMode_: function() {
    return this.castModeList &&
        this.castModeList.find(element => element.isForced);
  },

  /**
   * @param {?Element} element Element to compute padding for.
   * @return {!Array<number>} Array containing the element's bottom padding
   *     value and the element's top padding value, in that order.
   * @private
   */
  getElementVerticalPadding_: function(element) {
    var style = window.getComputedStyle(element);
    return [
      parseInt(style.getPropertyValue('padding-bottom'), 10) || 0,
      parseInt(style.getPropertyValue('padding-top'), 10) || 0
    ];
  },

  /**
   * Retrieves the first run flow cloud preferences text, if it exists. On
   * non-officially branded builds, the string is not defined.
   *
   * @return {string} Cloud preferences text.
   */
  getFirstRunFlowCloudPrefText_: function() {
    return loadTimeData.valueExists('firstRunFlowCloudPrefText') ?
        this.i18n('firstRunFlowCloudPrefText') :
        '';
  },

  /**
   * @param {?media_router.Route} route Route to get the sink for.
   * @return {?media_router.Sink} Sink associated with |route| or
   *     undefined if we don't have data for the sink.
   */
  getSinkForRoute_: function(route) {
    return route ? this.sinkMap_[route.sinkId] : null;
  },

  /**
   * @param {?Element} element Conditionally-templated element to check.
   * @return {boolean} Whether |element| is considered present in the document
   *     as a conditionally-templated element. This does not check the |hidden|
   *     attribute.
   */
  hasConditionalElement_: function(element) {
    return !!element &&
        (!element.style.display || element.style.display != 'none');
  },

  /**
   * Returns whether given string is undefined, null, empty, or whitespace only.
   * @param {?string} str String to be tested.
   * @return {boolean} |true| if the string is undefined, null, empty, or
   *     whitespace.
   * @private
   */
  isEmptyOrWhitespace_: function(str) {
    return str === undefined || str === null || (/^\s*$/).test(str);
  },

  /**
   * Reports a user filter action if |searchInputText_| is not empty and the
   * filter action hasn't been reported since the view changed to the filter
   * view.
   * @private
   */
  maybeReportFilter_: function() {
    if (this.reportFilterOnInput_ && this.searchInputText_.length != 0) {
      this.reportFilterOnInput_ = false;
      this.fire('report-filter');
    }
  },

  /**
   * Updates |currentView_| if the dialog had just opened and there's
   * only one local route.
   */
  maybeShowRouteDetailsOnOpen: function() {
    var localRoute = null;
    for (var i = 0; i < this.routeList.length; i++) {
      var route = this.routeList[i];
      if (!route.isLocal) {
        continue;
      }
      if (!localRoute) {
        localRoute = route;
      } else {
        // Don't show route details if there are more than one local route.
        localRoute = null;
        break;
      }
    }

    if (localRoute) {
      this.showRouteDetails_(localRoute);
    }
    this.fire('show-initial-state', {currentView: this.currentView_});
  },

  /**
   * Updates |currentView_| if there is a new blocking issue or a blocking
   * issue is resolved. Clears any pending route creation properties if the
   * issue corresponds with |pendingCreatedRouteId_|.
   *
   * @param {?media_router.Issue} issue The new issue, or null if the
   *                              blocking issue was resolved.
   * @private
   */
  maybeShowIssueView_: function(issue) {
    if (!!issue) {
      if (issue.isBlocking) {
        this.currentView_ = media_router.MediaRouterView.ISSUE;
      } else if (this.currentView_ == media_router.MediaRouterView.SINK_LIST) {
        // Make space for the non-blocking issue in the sink list.
        this.updateElementPositioning_();
      }
    } else if (this.currentView_ == media_router.MediaRouterView.ISSUE) {
      // Switch back to the sink list if the issue was cleared and it was
      // showing an issue. It is expected that the only way to clear an issue is
      // by user action; the IssueManager (C++ side) does not clear issues in
      // the UI.
      this.showSinkList_();
    }

    if (!!this.pendingCreatedRouteId_ && !!issue &&
        issue.routeId == this.pendingCreatedRouteId_) {
      this.resetRouteCreationProperties_(false);
    }
  },

  /**
   * If an element in the search results list has keyboard focus when we are
   * transitioning from the filter view to the sink list view, give focus to the
   * same sink in the sink list. Otherwise we leave the keyboard focus where it
   * is.
   * @private
   */
  maybeUpdateFocusOnFilterViewExit_: function() {
    var searchSinks =
        this.$$('#search-results').querySelectorAll('.selectable-item');
    var focusedElem = Array.prototype.find.call(searchSinks, function(sink) {
      return sink.matches(':focus');
    });
    if (!focusedElem) {
      return;
    }
    var focusedSink =
        this.$$('#searchResults').itemForElement(focusedElem).sinkItem;
    setTimeout(function() {
      var sinkListPaperMenu = this.$$('#sink-list-paper-menu');
      var sinks = sinkListPaperMenu.children;
      var sinkList = this.$$('#sinkList');
      for (var i = 0; i < sinks.length; i++) {
        if (sinkList.itemForElement(sinks[i]).id == focusedSink.id) {
          sinkListPaperMenu.selectIndex(i);
          break;
        }
      }
    }.bind(this));
  },

  /**
   * May update |populatedSinkListSeenTimeMs_| depending on |currentView| and
   * |sinksToShow|.
   * Called when |currentView_| or |sinksToShow_| is updated.
   *
   * @param {?media_router.MediaRouterView} currentView The current view of the
   *                                        dialog.
   * @param {!Array<!media_router.Sink>} sinksToShow The sinks to display.
   * @private
   */
  maybeUpdateStartSinkDisplayStartTime_: function(currentView, sinksToShow) {
    if (currentView == media_router.MediaRouterView.SINK_LIST &&
        sinksToShow.length != 0) {
      // Only set |populatedSinkListSeenTimeMs_| if it has not already been set.
      if (this.populatedSinkListSeenTimeMs_ == -1) {
        this.populatedSinkListSeenTimeMs_ = window.performance.now();
      }
    } else {
      // Reset |populatedSinkListLastSeen_| if the sink list isn't being shown
      // or if there aren't any sinks available for display.
      this.populatedSinkListSeenTimeMs_ = -1;
    }
  },

  /**
   * Animates the transition from the filter view, where the search field is at
   * the top of the list, to the sink list view, where the search field is at
   * the bottom of the list.
   *
   * If this is called while another animation is in progress, it queues itself
   * to be run at the end of the current animation.
   *
   * @param {!function()} resolve Resolves the animation promise that is waiting
   *     on this animation.
   * @private
   */
  moveSearchToBottom_: function(resolve) {
    var deviceMissing = this.$['device-missing'];
    var list = this.$$('#sink-list');
    var resultsContainer = this.$$('#search-results-container');
    var search = this.$$('#sink-search');
    var view = this.$['sink-list-view'];

    var hasList = this.hasConditionalElement_(list);
    var initialHeight = view.offsetHeight;
    // Force the view height to be max dialog height.
    view.style['overflow'] = 'hidden';

    var searchInitialOffsetHeight = search.offsetHeight;
    var searchInitialPaddingBottom, searchInitialPaddingTop;
    [searchInitialPaddingBottom, searchInitialPaddingTop] =
        this.getElementVerticalPadding_(search);
    var searchPadding = searchInitialPaddingBottom + searchInitialPaddingTop;
    var searchHeight = search.offsetHeight - searchPadding;
    var searchFinalPaddingBottom, searchFinalPaddingTop;
    [searchFinalPaddingBottom, searchFinalPaddingTop] =
        this.getElementVerticalPadding_(search);
    var searchFinalOffsetHeight =
        searchHeight + searchFinalPaddingBottom + searchFinalPaddingTop;

    var resultsInitialTop = 0;
    var finalHeight = 0;
    // Get final view height ahead of animation.
    if (hasList) {
      list.style['position'] = 'absolute';
      list.style['opacity'] = '0';
      this.hideSinkListForAnimation_ = false;
      finalHeight += list.offsetHeight;
      list.style['position'] = 'relative';
    } else {
      resultsInitialTop +=
          deviceMissing.offsetHeight + searchInitialOffsetHeight;
      finalHeight += deviceMissing.offsetHeight;
    }

    var searchInitialTop = hasList ? 0 : deviceMissing.offsetHeight;
    var searchFinalTop = hasList ? list.offsetHeight - search.offsetHeight :
                                   deviceMissing.offsetHeight;
    resultsContainer.style['position'] = 'absolute';

    var duration =
        this.computeAnimationDuration_(searchFinalTop - searchInitialTop);
    var timing = {duration: duration, easing: 'ease-in-out', fill: 'forwards'};

    // This GroupEffect does the reverse of |moveSearchToTop_|. It fades the
    // sink list in while sliding the search input and search results list down.
    // The dialog height is also adjusted smoothly to the sink list height.
    var deviceMissingEffect = new KeyframeEffect(
        deviceMissing,
        [
          {'marginBottom': searchInitialOffsetHeight},
          {'marginBottom': searchFinalOffsetHeight}
        ],
        timing);
    var listEffect =
        new KeyframeEffect(list, [{'opacity': '0'}, {'opacity': '1'}], timing);
    var resultsEffect = new KeyframeEffect(
        resultsContainer,
        [
          {
            'top': resultsInitialTop + 'px',
            'paddingTop': resultsContainer.style['padding-top']
          },
          {'top': '100%', 'paddingTop': '0px'}
        ],
        timing);
    var searchEffect = new KeyframeEffect(
        search,
        [
          {
            'top': searchInitialTop + 'px',
            'marginTop': '0px',
            'paddingBottom': searchInitialPaddingBottom + 'px',
            'paddingTop': searchInitialPaddingTop + 'px'
          },
          {
            'top': '100%',
            'marginTop': '-' + searchFinalOffsetHeight + 'px',
            'paddingBottom': searchFinalPaddingBottom + 'px',
            'paddingTop': searchFinalPaddingTop + 'px'
          }
        ],
        timing);
    var viewEffect = new KeyframeEffect(
        view,
        [
          {'height': initialHeight + 'px', 'paddingBottom': '0px'}, {
            'height': finalHeight + 'px',
            'paddingBottom': searchFinalOffsetHeight + 'px'
          }
        ],
        timing);
    var player = document.timeline.play(new GroupEffect(
        hasList ?
            [listEffect, resultsEffect, searchEffect, viewEffect] :
            [deviceMissingEffect, resultsEffect, searchEffect, viewEffect]));

    var that = this;
    var finalizeAnimation = function() {
      view.style['overflow'] = '';
      that.putSearchAtBottom_();
      that.filterTransitionPlayer_.cancel();
      that.filterTransitionPlayer_ = null;
      that.isSearchListHidden_ = true;
      resolve();
    };

    player.finished.then(finalizeAnimation);
    this.filterTransitionPlayer_ = player;
  },

  /**
   * Animates the transition from the sink list view, where the search field is
   * at the bottom of the list, to the filter view, where the search field is at
   * the top of the list.
   *
   * If this is called while another animation is in progress, it queues itself
   * to be run at the end of the current animation.
   *
   * @param {!function()} resolve Resolves the animation promise that is waiting
   *     on this animation.
   * @private
   */
  moveSearchToTop_: function(resolve) {
    var deviceMissing = this.$['device-missing'];
    var list = this.$$('#sink-list');
    var noMatches = this.$$('#no-search-matches');
    var results = this.$$('#search-results');
    var resultsContainer = this.$$('#search-results-container');
    var search = this.$$('#sink-search');
    var view = this.$['sink-list-view'];

    // Set the max height for the results list before it's shown.
    results.style.maxHeight = this.sinkListMaxHeight_ + 'px';

    // Saves current search container |offsetHeight| which includes bottom
    // padding.
    var searchInitialOffsetHeight = search.offsetHeight;
    var hasList = this.hasConditionalElement_(list);
    var searchInitialTop = hasList ?
        list.offsetHeight - searchInitialOffsetHeight :
        deviceMissing.offsetHeight;
    var searchFinalTop = hasList ? 0 : deviceMissing.offsetHeight;
    var searchInitialPaddingBottom, searchInitialPaddingTop;
    [searchInitialPaddingBottom, searchInitialPaddingTop] =
        this.getElementVerticalPadding_(search);
    var searchPadding = searchInitialPaddingBottom + searchInitialPaddingTop;
    var searchHeight = search.offsetHeight - searchPadding;
    var searchFinalPaddingBottom, searchFinalPaddingTop;
    [searchFinalPaddingBottom, searchFinalPaddingTop] =
        this.getElementVerticalPadding_(search);
    var searchFinalOffsetHeight =
        searchHeight + searchFinalPaddingBottom + searchFinalPaddingTop;

    // Omitting |search.offsetHeight| because it is handled by view animation
    // separately.
    var initialHeight =
        hasList ? list.offsetHeight : deviceMissing.offsetHeight;
    view.style['overflow'] = 'hidden';

    var resultsPadding = this.computeElementVerticalPadding_(results);
    var finalHeight = this.computeTotalSearchHeight_(
        deviceMissing, noMatches, results, searchFinalOffsetHeight,
        this.sinkListMaxHeight_ + resultsPadding);

    var duration =
        this.computeAnimationDuration_(searchFinalTop - searchInitialTop);
    var timing = {duration: duration, easing: 'ease-in-out', fill: 'forwards'};

    // This GroupEffect will cause the sink list to fade out while the search
    // input and search results list slide up. The dialog will also resize
    // smoothly to the new search result list height.
    var deviceMissingEffect = new KeyframeEffect(
        deviceMissing,
        [
          {'marginBottom': searchInitialOffsetHeight},
          {'marginBottom': searchFinalOffsetHeight}
        ],
        timing);
    var listEffect =
        new KeyframeEffect(list, [{'opacity': '1'}, {'opacity': '0'}], timing);
    var resultsEffect = new KeyframeEffect(
        resultsContainer,
        [
          {'top': '100%', 'paddingTop': '0px'}, {
            'top': searchFinalTop + 'px',
            'paddingTop': searchFinalOffsetHeight + 'px'
          }
        ],
        timing);
    var searchEffect = new KeyframeEffect(
        search,
        [
          {
            'top': '100%',
            'marginTop': '-' + searchInitialOffsetHeight + 'px',
            'paddingBottom': searchInitialPaddingBottom + 'px',
            'paddingTop': searchInitialPaddingTop + 'px'
          },
          {
            'top': searchFinalTop + 'px',
            'marginTop': '0px',
            'paddingBottom': searchFinalPaddingBottom + 'px',
            'paddingTop': searchFinalPaddingTop + 'px'
          }
        ],
        timing);
    var viewEffect = new KeyframeEffect(
        view,
        [
          {
            'height': initialHeight + 'px',
            'paddingBottom': searchInitialOffsetHeight + 'px'
          },
          {'height': finalHeight + 'px', 'paddingBottom': '0px'}
        ],
        timing);
    var player = document.timeline.play(new GroupEffect(
        hasList ?
            [listEffect, resultsEffect, searchEffect, viewEffect] :
            [deviceMissingEffect, resultsEffect, searchEffect, viewEffect]));

    var that = this;
    var finalizeAnimation = function() {
      // When we are moving the search results up into view, the user may type
      // more text or delete text which may change the height of the search
      // results list. In this case, the dialog height that the animation ends
      // on will now be wrong. In order to correct this smoothly,
      // |putSearchAtTop_| will queue another animation just to adjust the
      // dialog height.
      //
      // The |filterTransitionPlayer_| will hold all of the animated elements in
      // their final keyframe state until it is canceled or another player
      // overrides it because we used |fill: 'forwards'| in all of the effects.
      // So unlike |moveSearchToBottom_|, we don't know for sure whether we want
      // to cancel |filterTransitionPlayer_| after |putSearchAtTop_| because
      // another animation may have been run to correct the dialog height.
      //
      // If |putSearchAtTop_| has to adjust the dialog height, it also queues
      // itself to run again when that animation is finished. When the height is
      // finally correct at the end of an animation, it will cancel
      // |filterTransitionPlayer_| itself.
      that.putSearchAtTop_(resolve);
    };

    player.finished.then(finalizeAnimation);
    this.filterTransitionPlayer_ = player;
  },

  /**
   * Handles a cast mode selection. Updates |headerText|, |headerTextTooltip|,
   * and |shownCastModeValue_|.
   *
   * @param {!Event} event The event object.
   * @private
   */
  onCastModeClick_: function(event) {
    // The clicked cast mode can come from one of three lists,
    // presentationCastModeList, shareScreenCastModeList, and
    // localMediaCastModeList.
    var clickedMode =
        this.$$('#presentationCastModeList').itemForElement(event.target) ||
        this.$$('#shareScreenCastModeList').itemForElement(event.target) ||
        this.$$('#localMediaCastModeList').itemForElement(event.target);

    if (!clickedMode) {
      return;
    }

    // If the user selects LOCAL_FILE, some additional steps are required
    // (selecting the file), before the cast mode has been officially
    // selected.
    if (clickedMode.type == media_router.CastModeType.LOCAL_FILE) {
      this.selectLocalMediaFile_();
    } else {
      this.castModeSelected_(clickedMode);
    }
  },

  /**
   * Handles a change-route-source-click event. Sets the currently launching
   * sink to be the current route's sink and shows the sink list.
   *
   * @param {!Event} event The event object.
   * Parameters in |event|.detail:
   *   route - route to modify.
   *   selectedCastMode - cast mode to use for the new source.
   * @private
   */
  onChangeRouteSourceClick_: function(event) {
    /** @type {{route: !media_router.Route, selectedCastMode: number}} */
    var detail = event.detail;
    this.currentLaunchingSinkId_ = detail.route.sinkId;
    var sink = this.sinkMap_[detail.route.sinkId];
    this.showSinkList_();
    this.maybeReportUserFirstAction(
        media_router.MediaRouterUserAction.REPLACE_LOCAL_ROUTE);
  },

  /**
   * Handles a close-route event. Shows the sink list and starts a timer to
   * close the dialog if there is no click within three seconds.
   *
   * @param {!Event} event The event object.
   * Parameters in |event|.detail:
   *   route - route to close.
   * @private
   */
  onCloseRoute_: function(event) {
    /** @type {{route: media_router.Route}} */
    var detail = event.detail;
    this.showSinkList_();
    this.startTapTimer_();

    if (detail.route.isLocal) {
      this.maybeReportUserFirstAction(
          media_router.MediaRouterUserAction.STOP_LOCAL);
    }
  },

  /**
   * Handles response of previous create route attempt.
   *
   * @param {string} sinkId The ID of the sink to which the Media Route was
   *     creating a route.
   * @param {?media_router.Route} route The newly created route that
   *     corresponds to the sink if route creation succeeded; null otherwise.
   * @param {boolean} isForDisplay Whether or not |route| is for display.
   */
  onCreateRouteResponseReceived: function(sinkId, route, isForDisplay) {
    // The provider will handle sending an issue for a failed route request.
    if (!route) {
      this.resetRouteCreationProperties_(false);
      this.fire('report-resolved-route', {
        outcome: media_router.MediaRouterRouteCreationOutcome.FAILURE_NO_ROUTE
      });
      return;
    }

    // Check that |sinkId| exists and corresponds to |currentLaunchingSinkId_|.
    if (!this.sinkMap_[sinkId] || this.currentLaunchingSinkId_ != sinkId) {
      this.fire('report-resolved-route', {
        outcome:
            media_router.MediaRouterRouteCreationOutcome.FAILURE_INVALID_SINK
      });
      return;
    }

    // Regardless of whether the route is for display, it was resolved
    // successfully.
    this.fire(
        'report-resolved-route',
        {outcome: media_router.MediaRouterRouteCreationOutcome.SUCCESS});

    if (isForDisplay) {
      this.showRouteDetails_(route);
      this.startTapTimer_();
      this.resetRouteCreationProperties_(true);
    } else {
      this.pendingCreatedRouteId_ = route.id;
    }
  },

  /**
   * Sets up the LOCAL_FILE cast mode for display after a specific file has been
   * selected.
   *
   * @param {string} fileName The name of the file that has been selected.
   */
  onFileDialogSuccess(fileName) {
    /** @const */ var mode =
        this.findCastModeByType_(media_router.CastModeType.LOCAL_FILE);

    if (!mode) {
      return;
    }

    this.castModeSelected_(mode);
    this.headerText =
        loadTimeData.getStringF('castLocalMediaSelectedFileTitle', fileName);

    this.updateSelectedCastModeMenuItem_();
  },

  /**
   * Called when a focus event is triggered.
   *
   * @param {!Event} event The event object.
   * @private
   */
  onFocus_: function(event) {
    // If the focus event was automatically fired by Polymer, remove focus from
    // the element. This prevents unexpected focusing when the dialog is
    // initially loaded. This only happens on mac.
    if (cr.isMac && !event.sourceCapabilities) {
      // Adding a focus placeholder element is part of the workaround for
      // handling unexpected focusing, which only happens once on dialog open.
      // Since the placeholder is focus-enabled as denoted by its tabindex
      // value, the focus will not appear in other elements.
      var placeholder = this.$$('#focus-placeholder');
      // Check that the placeholder is the currently focused element. In some
      // tests, other elements are non-user-triggered focused.
      if (placeholder && this.shadowRoot.activeElement == placeholder) {
        event.path[0].blur();
        // Remove the placeholder since we have no more use for it.
        placeholder.remove();
      }
    }
  },

  /**
   * Called when a keydown event is fired.
   * @param {!Event} e Keydown event object for the event.
   */
  onKeydown_: function(e) {
    // The ESC key may be pressed with a combination of other keys. It is
    // handled on the C++ side instead of the JS side on non-mac platforms,
    // which uses toolkit-views. Handle the expected behavior on all platforms
    // here.
    if (e.key == media_router.KEY_ESC && !e.shiftKey && !e.ctrlKey &&
        !e.altKey && !e.metaKey) {
      // When searching, allow ESC as a mechanism to leave the filter view.
      if (this.currentView_ == media_router.MediaRouterView.FILTER) {
        // If the user tabbed to an item in the search results, or otherwise has
        // an item in the list focused, focus will seem to vanish when we
        // transition back to the sink list. Instead we should move focus to the
        // appropriate item in the sink list.
        this.maybeUpdateFocusOnFilterViewExit_();
        this.showSinkList_();
        e.preventDefault();
      } else {
        this.fire('close-dialog', {
          pressEscToClose: true,
        });
      }
    }
  },

  /**
   * Called when a mouseleave event is triggered.
   *
   * @private
   */
  onMouseLeave_: function() {
    this.mouseIsPositionedOverDialog_ = false;
  },

  /**
   * Called when a mouseenter event is triggered.
   *
   * @private
   */
  onMouseEnter_: function() {
    this.mouseIsPositionedOverDialog_ = true;
  },

  /**
   * Called when a search has completed up to route creation. |sinkId|
   * identifies the sink that should be in |allSinks|, if a sink was found.
   *
   * @param {string} sinkId The ID of the sink that is the result of the
   *     currently pending search.
   */
  onReceiveSearchResult: function(sinkId) {
    this.pseudoSinkSearchState_.receiveSinkResponse(sinkId);
    this.currentLaunchingSinkId_ =
        this.pseudoSinkSearchState_.checkForRealSink(this.allSinks);
    this.rebuildSinksToShow_();
    // If we're in filter view, make sure the |sinksToShow_| change is picked
    // up.
    if (this.currentView_ == media_router.MediaRouterView.FILTER) {
      this.filterSinks_(this.searchInputText_);
    }
  },

  /**
   * Called when the connection to the route controller is invalidated. Switches
   * from route details view to the sink list view.
   */
  onRouteControllerInvalidated: function() {
    if (this.currentView_ == media_router.MediaRouterView.ROUTE_DETAILS) {
      this.currentRoute_ = null;
      this.showSinkList_();
    }
  },

  /**
   * Called when a sink is clicked.
   *
   * @param {!Event} event The event object.
   * @private
   */
  onSinkClick_: function(event) {
    var clickedSink =
        (this.currentView_ == media_router.MediaRouterView.FILTER) ?
        this.$$('#searchResults').itemForElement(event.target).sinkItem :
        this.$$('#sinkList').itemForElement(event.target);
    this.showOrCreateRoute_(clickedSink);
    this.fire('sink-click', {index: event['model'].index});
  },

  /**
   * Sets the positioning of the sink list, search input, and search results so
   * that everything is in the correct state for the sink list view.
   *
   * @private
   */
  putSearchAtBottom_: function() {
    var search = this.$$('#sink-search');
    if (!this.hasConditionalElement_(search)) {
      return;
    }
    var deviceMissing = this.$['device-missing'];
    var list = this.$$('#sink-list');
    var resultsContainer = this.$$('#search-results-container');
    var view = this.$['sink-list-view'];
    search.style['top'] = '';
    if (resultsContainer) {
      resultsContainer.style['position'] = '';
      resultsContainer.style['padding-top'] = '';
      resultsContainer.style['top'] = '';
    }
    this.hideSinkListForAnimation_ = false;
    var hasList = this.hasConditionalElement_(list);
    if (hasList) {
      search.style['margin-top'] = '-' + search.offsetHeight + 'px';
      view.style['padding-bottom'] = search.offsetHeight + 'px';
      list.style['opacity'] = '';
    } else {
      var bottomMargin = 12;
      deviceMissing.style['margin-bottom'] =
          (search.offsetHeight + bottomMargin) + 'px';
      search.style['margin-top'] = '';
      view.style['padding-bottom'] = '';
    }
  },

  /**
   * Sets the positioning of the sink list, search input, and search results so
   * that everything is in the correct state for the filter view.
   *
   * If the user was searching while the |moveSearchToTop_| animation was
   * happening then the dialog height that animation ends at could be different
   * than the current height of the search results. If this is the case, this
   * function first spawns a new animation that smoothly corrects the height
   * problem. This is iterative, but once we enter a call where the heights
   * match up, the elements will become static again.
   *
   * @param {!function()} resolve Resolves the animation promise that is waiting
   *     on this animation.
   * @private
   */
  putSearchAtTop_: function(resolve) {
    var deviceMissing = this.$['device-missing'];
    var list = this.$$('#sink-list');
    var noMatches = this.$$('#no-search-matches');
    var results = this.$$('#search-results');
    var resultsContainer = this.$$('#search-results-container');
    var search = this.$$('#sink-search');
    var view = this.$['sink-list-view'];

    // Set the max height for the results list before it's shown.
    results.style.maxHeight = this.sinkListMaxHeight_ + 'px';

    // If there is a height mismatch between where the animation calculated the
    // height should be and where it is now because the search results changed
    // during the animation, correct it with... another animation.
    var resultsPadding = this.computeElementVerticalPadding_(results);
    var finalHeight = this.computeTotalSearchHeight_(
        deviceMissing, noMatches, results, search.offsetHeight,
        this.sinkListMaxHeight_ + resultsPadding);
    if (finalHeight != view.offsetHeight) {
      var viewEffect = new KeyframeEffect(
          view,
          [
            {'height': view.offsetHeight + 'px'},
            {'height': finalHeight + 'px'}
          ],
          {
            duration:
                this.computeAnimationDuration_(finalHeight - view.offsetHeight),
            easing: 'ease-in-out',
            fill: 'forwards'
          });
      var player = document.timeline.play(viewEffect);
      if (this.heightAdjustmentPlayer_) {
        this.heightAdjustmentPlayer_.cancel();
      }
      this.heightAdjustmentPlayer_ = player;
      player.finished.then(this.putSearchAtTop_.bind(this, resolve));
      return;
    }

    var hasList = this.hasConditionalElement_(list);
    search.style['margin-top'] = '';
    deviceMissing.style['margin-bottom'] = search.offsetHeight + 'px';
    var searchFinalTop = hasList ? 0 : deviceMissing.offsetHeight;
    var resultsPaddingTop = hasList ? search.offsetHeight + 'px' : '0px';
    search.style['top'] = searchFinalTop + 'px';
    this.hideSinkListForAnimation_ = true;
    resultsContainer.style['position'] = 'relative';
    resultsContainer.style['padding-top'] = resultsPaddingTop;
    resultsContainer.style['top'] = '';

    view.style['overflow'] = '';
    view.style['padding-bottom'] = '';
    if (this.filterTransitionPlayer_) {
      this.filterTransitionPlayer_.cancel();
      this.filterTransitionPlayer_ = null;
    }

    if (this.heightAdjustmentPlayer_) {
      this.heightAdjustmentPlayer_.cancel();
      this.heightAdjustmentPlayer_ = null;
    }

    resolve();
  },

  /**
   * Queues a call to |moveSearchToBottom_| by adding it as a continuation to
   * |animationPromise_| and updating |animationPromise_|.
   */
  queueMoveSearchToBottom_: function() {
    var oldPromise = this.animationPromise_;
    var that = this;
    this.animationPromise_ = new Promise(function(resolve) {
      oldPromise.then(that.moveSearchToBottom_.bind(that, resolve));
    });
  },

  /**
   * Queues a call to |moveSearchToTop_| by adding it as a continuation to
   * |animationPromise_| and updating |animationPromise_|. The new promise will
   * not resolve until |putSearchAtTop_| is finished, including any potential
   * dialog height adjustment animations.
   */
  queueMoveSearchToTop_: function() {
    var oldPromise = this.animationPromise_;
    var that = this;
    this.animationPromise_ = new Promise(function(resolve) {
      oldPromise.then(function() {
        that.isSearchListHidden_ = false;
        setTimeout(that.moveSearchToTop_.bind(that, resolve));
      });
    });
  },

  /**
   * Queues a call to |putSearchAtTop_| by adding it as a continuation to
   * |animationPromise_| and updating |animationPromise_|.
   */
  queuePutSearchAtTop_: function() {
    var that = this;
    var oldPromise = this.animationPromise_;
    this.animationPromise_ = new Promise(function(resolve) {
      oldPromise.then(that.putSearchAtTop_.bind(that, resolve));
    });
  },

  /**
   * Called when |routeList| is updated. Rebuilds |routeMap_| and
   * |sinkToRouteMap_|.
   *
   * @private
   */
  rebuildRouteMaps_: function() {
    this.routeMap_ = {};

    // Rebuild |sinkToRouteMap_| with a temporary map to avoid firing the
    // computed functions prematurely.
    var tempSinkToRouteMap = {};

    // We expect that each route in |routeList| maps to a unique sink.
    this.routeList.forEach(function(route) {
      this.routeMap_[route.id] = route;
      tempSinkToRouteMap[route.sinkId] = route;
    }, this);

    // If there is route creation in progress, check if any of the route ids
    // correspond to |pendingCreatedRouteId_|. If so, the newly created route
    // is ready to be displayed; switch to route details view.
    if (this.currentLaunchingSinkId_ != '' &&
        this.pendingCreatedRouteId_ != '') {
      var route = tempSinkToRouteMap[this.currentLaunchingSinkId_];
      if (route && this.pendingCreatedRouteId_ == route.id) {
        this.showRouteDetails_(route);
        this.startTapTimer_();
        this.resetRouteCreationProperties_(true);
      }
    } else {
      // If |currentRoute_| is no longer active, clear |currentRoute_|. Also
      // switch back to the SINK_PICKER view if the user is currently in the
      // ROUTE_DETAILS view.
      if (this.currentRoute_) {
        this.currentRoute_ = this.routeMap_[this.currentRoute_.id] || null;
      }
      if (!this.currentRoute_ &&
          this.currentView_ == media_router.MediaRouterView.ROUTE_DETAILS) {
        this.showSinkList_();
      }
    }

    this.sinkToRouteMap_ = tempSinkToRouteMap;
    this.rebuildSinksToShow_();
  },

  /**
   * Rebuilds the list of sinks to be shown for the current cast mode.
   * A sink should be shown if it is compatible with the current cast mode, or
   * if the sink is associated with a route.  The resulting list is sorted by
   * name.
   */
  rebuildSinksToShow_: function() {
    var updatedSinkList = this.allSinks.filter(function(sink) {
      return !sink.isPseudoSink;
    }, this);

    if (this.pseudoSinkSearchState_) {
      var pendingPseudoSink = this.pseudoSinkSearchState_.getPseudoSink();
      // Here we will treat the pseudo sink that launched the search as a real
      // sink until one is returned by search. This way it isn't possible to
      // ever reach a UI state where there is no spinner being shown in the sink
      // list but |currentLaunchingSinkId_| is non-empty (thereby preventing any
      // other sink from launching).
      if (pendingPseudoSink.id == this.currentLaunchingSinkId_) {
        updatedSinkList.unshift(pendingPseudoSink);
      }
    }
    // If user did not select a cast mode, then:
    // - If there is a forced cast mode, it is shown.
    // - If all sinks support only a single cast mode, then the cast mode is
    //   switched to that mode.
    // - Otherwise, the cast mode becomes AUTO mode.
    if (!this.userHasSelectedCastMode_) {
      this.setShownCastMode_(this.computeCastMode_());
    }

    // Non-AUTO modes may show a subset of sinks based on compatibility with the
    // shown value.
    if (this.shownCastModeValue_ != media_router.CastModeType.AUTO) {
      updatedSinkList = updatedSinkList.filter(function(element) {
        return (element.castModes & this.shownCastModeValue_) ||
            this.sinkToRouteMap_[element.id];
      }, this);
    }

    // When there's an updated list of sinks, append any new sinks to the end
    // of the existing list. This prevents sinks randomly jumping around the
    // dialog, which can surprise users / lead to inadvertently casting to the
    // wrong sink.
    if (this.sinksToShow_) {
      for (var i = this.sinksToShow_.length - 1; i >= 0; i--) {
        var index = updatedSinkList.findIndex(function(updatedSink) {
          return this.sinksToShow_[i].id == updatedSink.id;
        }.bind(this));
        if (index < 0) {
          // Remove any sinks that are no longer discovered.
          this.sinksToShow_.splice(i, 1);
        } else {
          // If the sink exists, move it from |updatedSinkList| to
          // |sinksToShow_| in the same position, as the cast modes or other
          // fields may have been updated.
          this.sinksToShow_[i] = updatedSinkList[index];
          updatedSinkList.splice(index, 1);
        }
      }

      updatedSinkList = this.sinksToShow_.concat(updatedSinkList);
    }
    this.sinksToShow_ = updatedSinkList;
  },

  /**
   * Called when |allSinks| is updated.
   *
   * @private
   */
  reindexSinksAndRebuildSinksToShow_: function() {
    this.sinkMap_ = {};

    this.allSinks.forEach(function(sink) {
      if (!sink.isPseudoSink) {
        this.sinkMap_[sink.id] = sink;
      }
    }, this);

    if (this.pseudoSinkSearchState_) {
      this.currentLaunchingSinkId_ =
          this.pseudoSinkSearchState_.checkForRealSink(this.allSinks);
    }
    this.pseudoSinks_ = this.allSinks.filter(function(sink) {
      return sink.isPseudoSink && !!sink.domain;
    });
    this.rebuildSinksToShow_();
    this.searchEnabled_ = this.searchEnabled_ || this.pseudoSinks_.length > 0 ||
        this.sinksToShow_.length >= media_router.MINIMUM_SINKS_FOR_SEARCH;
    this.filterSinks_(this.searchInputText_ || '');
    if (this.currentView_ != media_router.MediaRouterView.FILTER) {
      // This code is in the unique position of seeing |animationPromise_| as
      // null on startup. |allSinks| is initialized before |animationPromise_|
      // and this listener runs when |allSinks| is initialized.
      if (this.animationPromise_) {
        this.animationPromise_ =
            this.animationPromise_.then(this.putSearchAtBottom_.bind(this));
      } else {
        this.putSearchAtBottom_();
      }
    } else {
      this.queuePutSearchAtTop_();
    }
  },

  /**
   * Resets the properties relevant to creating a new route. Fires an event
   * indicating whether or not route creation was successful.
   * Clearing |currentLaunchingSinkId_| hides the spinner indicating there is
   * a route creation in progress and show the device icon instead.
   * @param {boolean} creationSuccess Whether route creation succeeded.
   *
   * @private
   */
  resetRouteCreationProperties_: function(creationSuccess) {
    this.pseudoSinkSearchState_ = null;
    this.currentLaunchingSinkId_ = '';
    this.pendingCreatedRouteId_ = '';
    // If it was a search that failed we need to refresh the filtered sinks now
    // that |pseudoSinkSearchState_| is null.
    if (!creationSuccess &&
        this.currentView_ == media_router.MediaRouterView.FILTER) {
      this.filterSinks_(this.searchInputText_);
    }

    this.fire('report-route-creation', {success: creationSuccess});
  },

  /**
   * Responds to a click on the search button by toggling sink filtering.
   */
  searchButtonClick_: function() {
    // Redundancy needed because focus() only fires event if input is not
    // already focused. In the case that user typed text, hit escape, then
    // clicks the search button, a focus event will not fire and so its event
    // handler from ready() will not run.
    this.showSearchResults_();
    this.$$('#sink-search-input').focus();
  },

  /**
   * Initializes the position of the search input if search becomes enabled.
   * @param {boolean} searchEnabled The new value of |searchEnabled_|.
   * @private
   */
  searchEnabledChanged_: function(searchEnabled) {
    if (searchEnabled) {
      this.async(function() {
        this.setSearchFocusHandlers_();
        this.putSearchAtBottom_();
      });
    }
  },

  /**
   * Filters the sink list when the input text changes and shows the search
   * results if |searchInputText| is not empty.
   * @param {string} searchInputText The currently entered search text.
   * @private
   */
  searchInputTextChanged_: function(searchInputText) {
    this.filterSinks_(searchInputText);
    if (searchInputText.length != 0) {
      this.showSearchResults_();
      this.maybeReportFilter_();
    }
  },

  /**
   * Sets the selected cast mode to the one associated with |castModeType|,
   * and rebuilds sinks to reflect the change.
   * @param {number} castModeType The type of the selected cast mode.
   */
  selectCastMode: function(castModeType) {
    var castMode = this.findCastModeByType_(castModeType);
    if (castMode && castModeType != this.shownCastModeValue_) {
      this.setShownCastMode_(castMode);
      this.userHasSelectedCastMode_ = true;
      this.rebuildSinksToShow_();
    }
  },

  /**
   * Fires the command to open a file dialog.
   *
   * @private
   */
  selectLocalMediaFile_() {
    this.fire('select-local-media-file');
  },

  /**
   * Sets various focus and blur event handlers to handle showing search results
   * when the search input is focused.
   * @private
   */
  setSearchFocusHandlers_: function() {
    var searchInput = this.$$('#sink-search-input');
    var that = this;

    // The window can see a blur event for two important cases: the window is
    // actually losing focus or keyboard focus is wrapping from the end of the
    // document to the beginning. To handle both cases, we save whether the
    // search input was focused during the window blur event.
    //
    // When the search input receives focus, it could be as part of window
    // focus. If the search input was also focused on window blur, it shouldn't
    // show search results if they aren't already being shown. Otherwise,
    // focusing the search input should activate the FILTER view by calling
    // |showSearchResults_()|.
    window.addEventListener('blur', function() {
      that.isSearchFocusedOnWindowBlur_ =
          that.shadowRoot.activeElement == searchInput;
    });
    searchInput.addEventListener('focus', function() {
      if (!that.isSearchFocusedOnWindowBlur_) {
        that.showSearchResults_();
      }
    });
  },

  /**
   * Updates the shown cast mode, and updates the header text fields
   * according to the cast mode. If |castMode| type is AUTO, then set
   * |userHasSelectedCastMode_| to false.
   *
   * @param {!media_router.CastMode} castMode
   */
  setShownCastMode_: function(castMode) {
    if (this.shownCastModeValue_ == castMode.type) {
      return;
    }

    this.shownCastModeValue_ = castMode.type;
    this.headerText = castMode.description;
    this.headerTextTooltip = castMode.host || '';
    if (castMode.type == media_router.CastModeType.AUTO) {
      this.userHasSelectedCastMode_ = false;
    }
  },

  /**
   * Shows the cast mode list.
   *
   * @private
   */
  showCastModeList_: function() {
    this.currentView_ = media_router.MediaRouterView.CAST_MODE_LIST;
  },

  /**
   * Creates a new route if there is no route to the |sink| . Otherwise,
   * shows the route details.
   *
   * @param {!media_router.Sink} sink The sink to use.
   * @private
   */
  showOrCreateRoute_: function(sink) {
    var route = this.sinkToRouteMap_[sink.id];
    if (route) {
      this.showRouteDetails_(route);
      this.fire('navigate-sink-list-to-details');
      this.maybeReportUserFirstAction(
          media_router.MediaRouterUserAction.STATUS_REMOTE);
    } else if (this.currentLaunchingSinkId_ == '') {
      // Allow one launch at a time.
      var selectedCastModeValue =
          this.shownCastModeValue_ == media_router.CastModeType.AUTO ?
          sink.castModes & -sink.castModes :
          this.shownCastModeValue_;
      if (sink.isPseudoSink) {
        this.pseudoSinkSearchState_ = new PseudoSinkSearchState(sink);
        this.fire('search-sinks-and-create-route', {
          id: sink.id,
          name: sink.name,
          domain: sink.domain,
          selectedCastMode: selectedCastModeValue
        });
      } else {
        this.fire('create-route', {
          sinkId: sink.id,
          // If user selected a cast mode, then we will create a route using
          // that cast mode. Otherwise, the UI is in "auto" cast mode and will
          // use the preferred cast mode compatible with the sink. The preferred
          // cast mode value is the least significant bit on the bitset.
          selectedCastModeValue: selectedCastModeValue
        });

        var timeToSelectSink =
            window.performance.now() - this.populatedSinkListSeenTimeMs_;
        this.fire('report-sink-click-time', {timeMs: timeToSelectSink});
      }
      this.currentLaunchingSinkId_ = sink.id;
      if (sink.isPseudoSink) {
        this.rebuildSinksToShow_();
      }

      this.maybeReportUserFirstAction(
          media_router.MediaRouterUserAction.START_LOCAL);
    }
  },

  /**
   * Shows the route details.
   *
   * @param {!media_router.Route} route The route to show.
   * @private
   */
  showRouteDetails_: function(route) {
    this.currentRoute_ = route;
    this.currentView_ = media_router.MediaRouterView.ROUTE_DETAILS;
    if (route.supportsWebUiController) {
      media_router.browserApi.onMediaControllerAvailable(route.id);
    }
    if (this.$$('route-details')) {
      this.$$('route-details').onOpened();
    }
  },

  /**
   * Shows the search results.
   *
   * @private
   */
  showSearchResults_: function() {
    if (this.currentView_ != media_router.MediaRouterView.FILTER) {
      this.currentView_ = media_router.MediaRouterView.FILTER;
      this.queueMoveSearchToTop_();
    }
  },

  /**
   * Shows the sink list.
   *
   * @private
   */
  showSinkList_: function() {
    if (this.currentView_ == media_router.MediaRouterView.FILTER) {
      this.queueMoveSearchToBottom_();
      this.currentView_ = media_router.MediaRouterView.SINK_LIST;
    } else {
      this.currentView_ = media_router.MediaRouterView.SINK_LIST;
      this.putSearchAtBottom_();
    }
  },

  /**
   * Starts a timer which fires a close-dialog event if the user's mouse is
   * not positioned over the dialog after three seconds.
   *
   * @private
   */
  startTapTimer_: function() {
    var id = setTimeout(function() {
      if (!this.mouseIsPositionedOverDialog_) {
        this.fire('close-dialog', {
          pressEscToClose: false,
        });
      }
    }.bind(this), 3000 /* 3 seconds */);
  },

  /**
   * Toggles |currentView_| between CAST_MODE_LIST and SINK_LIST.
   *
   * @private
   */
  toggleCastModeHidden_: function() {
    if (this.currentView_ == media_router.MediaRouterView.CAST_MODE_LIST) {
      this.showSinkList_();
    } else if (this.currentView_ == media_router.MediaRouterView.SINK_LIST) {
      this.showCastModeList_();
      this.fire('navigate-to-cast-mode-list');
    }
  },

  /**
   * Update the position-related styling of some elements.
   *
   * @private
   */
  updateElementPositioning_: function() {
    // Ensures that conditionally templated elements have finished stamping.
    this.async(function() {
      var headerHeight = this.header.offsetHeight;
      // Unlike the other elements whose heights are fixed, the first-run-flow
      // element can have a fractional height. So we use getBoundingClientRect()
      // to avoid rounding errors.
      var firstRunFlowHeight = this.$$('#first-run-flow') &&
              this.$$('#first-run-flow').style.display != 'none' ?
          this.$$('#first-run-flow').getBoundingClientRect().height :
          0;
      var issueHeight = this.$$('#issue-banner') &&
              this.$$('#issue-banner').style.display != 'none' ?
          this.$$('#issue-banner').offsetHeight :
          0;
      var search = this.$$('#sink-search');
      var hasSearch = this.hasConditionalElement_(search);
      var searchHeight = hasSearch ? search.offsetHeight : 0;
      var searchPadding =
          hasSearch ? this.computeElementVerticalPadding_(search) : 0;

      this.header.style.marginTop = firstRunFlowHeight + 'px';
      this.$['content'].style.marginTop =
          firstRunFlowHeight + headerHeight + 'px';

      var sinkList = this.$$('#sink-list');
      var sinkListPadding =
          sinkList ? this.computeElementVerticalPadding_(sinkList) : 0;

      this.sinkListMaxHeight_ = this.dialogHeight_ - headerHeight -
          firstRunFlowHeight - issueHeight - searchHeight + searchPadding -
          sinkListPadding;

      // Limit the height of the dialog to ten items, including search.
      var sinkItemHeight = 41;
      var maxSinkItems = hasSearch ? 9 : 10;
      this.sinkListMaxHeight_ =
          Math.min(sinkItemHeight * maxSinkItems, this.sinkListMaxHeight_);
      if (sinkList) {
        sinkList.style.maxHeight = this.sinkListMaxHeight_ + 'px';
      }
    });
  },

  /**
   * Update the max dialog height and update the positioning of the elements.
   *
   * @param {number} height The max height of the Media Router dialog.
   */
  updateMaxDialogHeight: function(height) {
    this.dialogHeight_ = height;
    this.updateElementPositioning_();
  },

  /**
   * Sets the selected cast mode menu item to be in sync with the current cast
   * mode.
   * @private
   */
  updateSelectedCastModeMenuItem_: function() {
    /** @const */ var curIndex =
        this.findCastModeIndexByType_(this.shownCastModeValue_);
    if (this.selectedCastModeMenuItem_ != curIndex) {
      this.selectedCastModeMenuItem_ = curIndex;
    }
  },
});
<link rel="import" href="chrome://resources/html/polymer.html">

<link rel="import" href="chrome://resources/cr_elements/icons.html">
<link rel="import" href="chrome://resources/html/i18n_behavior.html">
<link rel="import" href="chrome://resources/polymer/v1_0/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../icons/media_router_icons.html">
<dom-module id="media-router-header">
  <link rel="import" type="css" href="../../media_router_common.css">
  <link rel="import" type="css" href="media_router_header.css">
  <template>
    <div id="header" class$="[[view]]">
      <div id="main-container">
        <template is="dom-if" if="[[computeBackButtonShown_(view)]]">
          <div id="back-button-container">
            <paper-icon-button id="back-button" icon="[[arrowDropIcon_]]"
                on-tap="onBackButtonClick_" title="[[i18n('backButtonTitle')]]">
            </paper-icon-button>
          </div>
        </template>
        <div id="header-and-arrow-container" on-tap="onHeaderOrArrowClick_">
          <span id="header-text" title="[[tooltip]]">
              [[headingText]]</span>
          <div id="arrow-drop-container">
            <paper-icon-button icon="[[computeArrowDropIcon_(view)]]"
                id="arrow-drop-icon" disabled$="[[arrowDropIconDisabled]]"
                hidden$="[[computeArrowDropIconHidden_(view)]]"
                title="[[computeArrowDropTitle_(view)]]">
            </paper-icon-button>
          </div>
        </div>
        <div id="close-button-container">
          <paper-icon-button icon="cr:close" id="close-button"
              on-tap="onCloseButtonClick_" title="[[i18n('closeButtonTitle')]]">
          </paper-icon-button>
        </div>
      </div>
      <template is="dom-if" if="[[showEmail]]">
        <div id="user-email-container">[[userEmail]]</div>
      </template>
    </div>
  </template>
<script src="media_router_header.js"></script>
</dom-module>
/* Copyright 2015 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

#arrow-drop-container {
  flex-grow: 1;
}

#arrow-drop-icon {
  height: var(--navigation-icon-button-size);
  width: var(--navigation-icon-button-size);
}

#back-button {
  height: var(--navigation-icon-button-size);
  width: var(--navigation-icon-button-size);
}

#back-button-container {
  padding-inline-end: 4px;
}

#close-button {
  height: 31px;
  margin-inline-start: auto;
  width: 31px;
}

#close-button-container {
  margin-inline-start: auto;
  padding-inline-end: 16px;
  padding-inline-start: 24px;
}

#header {
  align-items: center;
  color: white;
  padding-inline-start: 8px;
}

#header-and-arrow-container {
  display: flex;
  overflow: hidden;
  white-space: nowrap;
}

#header-text {
  font-size: 1.175em;
  line-height: 36px;
  margin: 0 8px;
  overflow: hidden;
  padding-inline-end: 4px;
  text-overflow: ellipsis;
}

.issue {
  background-color: var(--paper-red-700);
}

paper-icon-button {
  display: inline-block;
}

#main-container {
  display: flex;
  padding-top: 10px;
}

.cast-mode-list,
.filter,
.route-details,
.sink-list {
  background-color: var(--paper-blue-700);
}

#user-email-container {
  bottom: 0;
  font-size: 0.917em;
  left: auto;
  padding-bottom: 12px;
  padding-inline-start: 8px;
  position: absolute;
}
// Copyright 2015 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// This Polymer element is used as a header for the media router interface.
Polymer({
  is: 'media-router-header',

  properties: {
    /**
     * The name of the icon used as the back button. This is set once, when
     * the |this| is ready.
     * @private {string|undefined}
     */
    arrowDropIcon_: {
      type: String,
    },

    /**
     * Whether or not the arrow drop icon should be disabled.
     * @type {boolean}
     */
    arrowDropIconDisabled: {
      type: Boolean,
      value: false,
    },

    /**
     * The header text to show.
     * @type {string|undefined}
     */
    headingText: {
      type: String,
    },

    /**
     * The height of the header when it shows the user email.
     * @private {number}
     */
    headerWithEmailHeight_: {
      type: Number,
      readOnly: true,
      value: 62,
    },

    /**
     * The height of the header when it doesn't show the user email.
     * @private {number}
     */
    headerWithoutEmailHeight_: {
      type: Number,
      readOnly: true,
      value: 52,
    },

    /**
     * Whether to show the user email in the header.
     * @type {boolean|undefined}
     */
    showEmail: {
      type: Boolean,
      observer: 'maybeChangeHeaderHeight_',
    },

    /**
     * The text to show in the tooltip.
     * @type {string|undefined}
     */
    tooltip: {
      type: String,
    },

    /**
     * The user email if they are signed in.
     * @type {string|undefined}
     */
    userEmail: {
      type: String,
    },

    /**
     * The current view that this header should reflect.
     * @type {?media_router.MediaRouterView|undefined}
     */
    view: {
      type: String,
      observer: 'updateHeaderCursorStyle_',
    },
  },

  behaviors: [
    I18nBehavior,
  ],

  ready: function() {
    this.$$('#header').style.height = this.headerWithoutEmailHeight_ + 'px';
  },

  attached: function() {
    // isRTL() only works after i18n_template.js runs to set <html dir>.
    // Set the back button icon based on text direction.
    this.arrowDropIcon_ = isRTL() ? 'cr:arrow-forward' : 'cr:arrow-back';
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @return {string} The icon to use.
   * @private
   */
  computeArrowDropIcon_: function(view) {
    return view == media_router.MediaRouterView.CAST_MODE_LIST ?
        'cr:arrow-drop-up' :
        'cr:arrow-drop-down';
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @return {boolean} Whether or not the arrow drop icon should be hidden.
   * @private
   */
  computeArrowDropIconHidden_: function(view) {
    return view != media_router.MediaRouterView.SINK_LIST &&
        view != media_router.MediaRouterView.CAST_MODE_LIST;
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @return {string} The title text for the arrow drop button.
   * @private
   */
  computeArrowDropTitle_: function(view) {
    return view == media_router.MediaRouterView.CAST_MODE_LIST ?
        this.i18n('viewDeviceListButtonTitle') :
        this.i18n('viewCastModeListButtonTitle');
  },

  /**
   * @param {?media_router.MediaRouterView} view The current view.
   * @return {boolean} Whether or not the back button should be shown.
   * @private
   */
  computeBackButtonShown_: function(view) {
    return view == media_router.MediaRouterView.ROUTE_DETAILS ||
        view == media_router.MediaRouterView.FILTER;
  },

  /**
   * Returns whether given string is undefined, null, empty, or whitespace only.
   * @param {?string} str String to be tested.
   * @return {boolean} |true| if the string is undefined, null, empty, or
   *     whitespace.
   * @private
   */
  isEmptyOrWhitespace_: function(str) {
    return str === undefined || str === null || (/^\s*$/).test(str);
  },

  /**
   * Handles a click on the back button by firing a back-click event.
   *
   * @private
   */
  onBackButtonClick_: function() {
    this.fire('back-click');
  },

  /**
   * Handles a click on the close button by firing a close-button-click event.
   *
   * @private
   */
  onCloseButtonClick_: function() {
    this.fire('close-dialog', {
      pressEscToClose: false,
    });
  },

  /**
   * Handles a click on the arrow button by firing an arrow-click event.
   *
   * @private
   */
  onHeaderOrArrowClick_: function() {
    if (this.view == media_router.MediaRouterView.SINK_LIST ||
        this.view == media_router.MediaRouterView.CAST_MODE_LIST) {
      this.fire('header-or-arrow-click');
    }
  },

  /**
   * Updates header height to accomodate email text. This is called on changes
   * to |showEmail| and will return early if the value has not changed.
   *
   * @param {boolean} newValue The new value of |showEmail|.
   * @param {boolean} oldValue The previous value of |showEmail|.
   * @private
   */
  maybeChangeHeaderHeight_: function(newValue, oldValue) {
    if (oldValue == newValue) {
      return;
    }

    // Ensures conditional templates are stamped.
    this.async(function() {
      var currentHeight = this.offsetHeight;

      this.$$('#header').style.height =
          this.showEmail && !this.isEmptyOrWhitespace_(this.userEmail) ?
          this.headerWithEmailHeight_ + 'px' :
          this.headerWithoutEmailHeight_ + 'px';

      // Only fire if height actually changed.
      if (currentHeight != this.offsetHeight) {
        this.fire('header-height-changed');
      }
    });
  },

  /**
   * Updates the cursor style for the header text when the view changes. When
   * the drop arrow is also shown, the header text is also clickable.
   *
   * @param {?media_router.MediaRouterView} view The current view.
   * @private
   */
  updateHeaderCursorStyle_: function(view) {
    this.$$('#header-text').style.cursor =
        view == media_router.MediaRouterView.SINK_LIST ||
            view == media_router.MediaRouterView.CAST_MODE_LIST ?
        'pointer' :
        'auto';
  },
});
/* Copyright 2016 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

.highlight {
  font-weight: bold;
}
<link rel="import" href="chrome://resources/html/polymer.html">
<dom-module id="media-router-search-highlighter">
  <link rel="import" type="css" href="media_router_search_highlighter.css">
  <template>
    <span id="text" dir="auto"></span>
  </template>
</dom-module>
<script src="media_router_search_highlighter.js"></script>
// Copyright 2016 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// This Polymer element displays text that needs sections of it highlighted.
// This is useful, for example, for displaying which portions of a string were
// matched by some filter text.
Polymer({
  is: 'media-router-search-highlighter',

  properties: {
    /**
     * The text that this element should display, split it into highlighted and
     * normal text. The displayed text will alternate between plainText and
     * highlightedText.
     *
     * Example: You have a sink with the name 'living room'.
     * When your seach text is 'living', the resulting arrays will be:
     *     plainText: [null, ' room'], highlightedText: ['living', null]
     *
     * When your search text is 'room', the resulting arrays will be:
     *     plainText: ['living ', null], highlightedText: [null, 'room']
     *
     * null corresponds to an empty string when the arrays are being combined.
     * So both examples reproduce the text 'living room', but with different
     * words highlighted.
     * @type {{highlightedText: !Array<?string>,
     *         plainText: !Array<?string>}|undefined}
     */
    data: {
      type: Object,
      observer: 'dataChanged_',
    },

    /**
     * The text that this element is displaying as a plain string. The primary
     * purpose for this property is to make getting this element's textContent
     * easy for testing.
     * @type {string|undefined}
     */
    text: {
      type: String,
      readOnly: true,
      notify: false,
    },
  },

  /**
   * Update the element text if |data| changes.
   *
   * The order the strings are combined is plainText[0] highlightedText[0]
   * plainText[1] highlightedText[1] etc.
   *
   * @param {{highlightedText: !Array<?string>, plainText: !Array<?string>}}
   *    data
   * Parameters in |data|:
   *   highlightedText - Array of strings that should be displayed highlighted.
   *   plainText - Array of strings that should be displayed normally.
   */
  dataChanged_: function(data) {
    if (!data || !data.highlightedText || !data.plainText) {
      return;
    }

    var text = '';
    for (var i = 0; i < data.highlightedText.length; ++i) {
      if (data.plainText[i]) {
        text += HTMLEscape(/** @type {!string} */ (data.plainText[i]));
      }
      if (data.highlightedText[i]) {
        text += '<span class="highlight">' +
            HTMLEscape(/** @type {!string} */ (data.highlightedText[i])) +
            '</span>';
      }
    }
    this.$.text.innerHTML = text;
    this._setText(this.$.text.textContent);
  },
});
<link rel="import" href="chrome://resources/html/polymer.html">

<link rel="import" href="chrome://resources/cr_elements/cr_checkbox/cr_checkbox.html">
<link rel="import" href="chrome://resources/cr_elements/cr_slider/cr_slider.html">
<link rel="import" href="chrome://resources/html/md_select_css.html">
<link rel="import" href="chrome://resources/html/i18n_behavior.html">
<link rel="import" href="chrome://resources/polymer/v1_0/iron-iconset-svg/iron-iconset-svg.html">

<iron-iconset-svg name="route-controls" size="24">
<svg><defs>
  <g id="play-arrow"><path d="M8 5v14l11-7z"></path></g>
  <g id="pause"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></g>
  <g id="volume-off"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></g>
  <g id="volume-up"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></g>
</defs></svg>
</iron-iconset-svg>

<dom-module id="route-controls">
  <link rel="import" type="css" href="../../media_router_common.css">
  <link rel="import" type="css" href="route_controls.css">
  <template>
    <style include="md-select"></style>
    <div id="media-controls">
      <div class="ellipsis" id="route-description"
           title="[[routeDescription_]]">
        [[routeDescription_]]
      </div>
      <div class="ellipsis" id="route-title" title="[[routeStatus.title]]"
           hidden$="[[!shouldShowRouteStatusTitle_]]">
        [[routeStatus.title]]
      </div>
      <div>
        <div id="route-time-controls" hidden="[[!routeStatus.canSeek]]">
          <cr-slider
              aria-valuetext$="[[getTimeSliderValueText_(displayedCurrentTime_)]]"
              dir="ltr"
              id="route-time-slider"
              on-dragging-changed="onSeekingChanged_"
              on-cr-slider-value-changed="onSeekSliderValueChanged_"
              min="0" max="[[routeStatus.duration]]"
              title="[[i18n('seekTitle')]]"
              value="[[displayedCurrentTime_]]"></cr-slider>
          <div id="timeline">
            <span id="current-time"
                  aria-label$="[[getCurrentTimeLabel_(displayedCurrentTime_)]]">
              [[getFormattedTime_(displayedCurrentTime_)]]
            </span>
            <span id="duration"
                  aria-label$="[[getDurationLabel_(routeStatus.duration)]]">
              [[getFormattedTime_(routeStatus.duration)]]
            </span>
          </div>
        </div>
        <div id="play-pause-volume-hangouts-controls">
          <span id="button-holder" dir="ltr">
            <paper-icon-button
                id="route-play-pause-button"
                hidden="[[!routeStatus.canPlayPause]]"
                disabled="[[!routeStatus.canPlayPause]]"
                icon="[[getPlayPauseIcon_(routeStatus)]]"
                title="[[getPlayPauseTitle_(routeStatus)]]"
                on-click="onPlayPause_"></paper-icon-button>
            <paper-icon-button
                id="route-volume-button"
                hidden="[[!routeStatus.canMute]]"
                disabled="[[!routeStatus.canMute]]"
                icon="[[getMuteUnmuteIcon_(routeStatus)]]"
                title="[[getMuteUnmuteTitle_(routeStatus)]]"
                on-click="onMuteUnmute_"></paper-icon-button>
          </span>
          <span id="volume-holder" hidden="[[!routeStatus.canSetVolume]]">
            <cr-slider
                aria-valuetext$="[[getVolumeSliderValueText_(displayedVolume_)]]"
                id="route-volume-slider"
                disabled="[[!routeStatus.canSetVolume]]"
                on-cr-slider-value-changed="onVolumeChanged_"
                on-dragging-changed="onVolumeDraggingChanged_"
                title="[[i18n('volumeTitle')]]"></cr-slider>
          </span>
          <div id="hangouts-local-present-controls"
               hidden="[[!routeStatus.hangoutsExtraData]]">
            <cr-checkbox
                checked="[[hangoutsLocalPresent_]]"
                id="hangouts-local-present-checkbox"
                on-change="onHangoutsLocalPresentChange_"
                tabindex="0">
              <span id='hangouts-local-present-checkbox-title'>
                [[i18n('hangoutsLocalPresentTitle')]]
              </span>
              <span id="hangouts-local-present-checkbox-subtitle">
                [[i18n('hangoutsLocalPresentSubtitle')]]
              </span>
            </cr-checkbox>
          </div>
        </div>
        <div id="mirroring-fullscreen-video-controls"
            hidden="[[!routeStatus.mirroringExtraData]]">
          [[i18n('fullscreenVideosDropdownTitle')]]
          <select class="md-select"
              id="mirroring-fullscreen-video-dropdown"
              on-change="onFullscreenVideoDropdownChange_">
            <option value="[[FullscreenVideoOption_.REMOTE_SCREEN]]">
              [[i18n('fullscreenVideosRemoteScreen')]]
            </option>
            <option value="[[FullscreenVideoOption_.BOTH_SCREENS]]">
              [[i18n('fullscreenVideosBothScreens')]]
            </option>
          </select>
        </div>
      </div>
    </div>
  </template>
<script src="route_controls.js"></script>
</dom-module>
/* Copyright 2017 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

#button-holder {
  float: left;
}

#current-time {
  left: 20px;
  position: absolute;
}

#duration {
  position: absolute;
  right: 20px;
}

:host-context([dir='rtl']) #play-pause-volume-hangouts-controls {
  transform: scaleX(-1);
}

:host-context([dir='rtl']) #route-play-pause-button {
  transform: scaleX(-1);
}

:host-context([dir='rtl']) #volume-holder {
  transform: scaleX(-1);
}

#media-controls {
  font-size: 1.25em;
  margin: 0 8px;
}

#play-pause-volume-hangouts-controls {
  display: block;
  margin-top: 13px;
  overflow: hidden;
}

#route-description {
  margin: 15px 8px 3px 8px;
  width: 90%;
}

#route-time-controls {
  display: block;
  margin-top: 3px;
  overflow: hidden;
}

#route-time-slider {
  --cr-slider-active-color: rgb(16, 16, 16);
  --cr-slider-container-color: rgba(16, 16, 16, .24);
  --cr-slider-knob-color: rgb(16, 16, 16);
  width: 100%;
}

#route-title {
  color: rgb(125, 125, 125);
  margin: 3px 8px;
}

#route-volume-slider {
  --cr-slider-active-color: rgb(33, 150, 243);
  --cr-slider-container-color: rgba(16, 16, 16, .24);
  --cr-slider-knob-color: rgb(16, 16, 16);
  width: 100%;
}

#timeline {
  font-size: 0.75em;
}

#volume-holder {
  display: block;
  overflow: hidden;
  padding: 0.3em 0;
}

#hangouts-local-present-controls {
  cursor: pointer;
  display: inline-block;
  float: right;
  padding-top: 10.5px;
  white-space: nowrap;
}

#hangouts-local-present-checkbox {
  --cr-checkbox-label-container: {
    padding-inline-start: 14px;
  }
  align-items: start;
}

#hangouts-local-present-checkbox-subtitle {
  display: block;
  font-size: 0.8em;
  margin-top: 2px;
  width: 249px;
}

#mirroring-fullscreen-video-controls {
  display: inline-block;
  font-size: 0.8em;
  margin: 15px 8px 3px 8px;
  vertical-align: middle;
}

#mirroring-fullscreen-video-dropdown {
  margin-inline-start: 8px;
  width: auto;
}
// Copyright 2017 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

/**
 * This Polymer element shows media controls for a route that is currently cast
 * to a device.
 * @implements {RouteControlsInterface}
 */
Polymer({
  is: 'route-controls',

  properties: {
    /**
     * Set of possible options for playing fullscreen videos when mirroring.
     * @private {!Object}
     */
    FullscreenVideoOption_: {
      type: Object,
      value: {
        // Play on remote screen only.
        REMOTE_SCREEN: 'remote_screen',
        // Play on both remote and local screens.
        BOTH_SCREENS: 'both_screens'
      }
    },

    /**
     * The current time displayed in seconds, before formatting.
     * @private {number}
     */
    displayedCurrentTime_: {
      type: Number,
      value: 0,
    },

    /**
     * The volume shown in the volume control, between 0 and 1.
     * @private {number}
     */
    displayedVolume_: {
      type: Number,
      value: 0,
    },

    /**
     * True if the Hangouts route is currently using local present mode.
     * Valid for Hangouts routes only.
     * @private {boolean}
     */
    hangoutsLocalPresent_: {
      type: Boolean,
      value: false,
    },

    /**
     * The timestamp for when the initial media status was loaded.
     * @private {number}
     */
    initialLoadTime_: {
      type: Number,
      value: 0,
    },

    /**
     * Set to true when the user is dragging the seek bar. Updates for the
     * current time from the browser will be ignored when set to true.
     * @private {boolean}
     */
    isSeeking_: {
      type: Boolean,
      value: false,
    },

    /**
     * Set to true when the user is dragging the volume bar. Volume updates from
     * the browser will be ignored when set to true.
     * @private
     */
    isVolumeChanging_: {
      type: Boolean,
      value: false,
    },

    /**
     * The timestamp for when the controller last submitted a seek request.
     * @private
     */
    lastSeekByUser_: {
      type: Number,
      value: 0,
    },

    /**
     * The timestamp for when |routeStatus| was last updated.
     * @private
     */
    lastStatusUpdate_: {
      type: Number,
      value: 0,
    },

    /**
     * The timestamp for when the controller last submitted a volume change
     * request.
     * @private
     */
    lastVolumeChangeByUser_: {
      type: Number,
      value: 0,
    },

    /**
     * Keep in sync with media remoting individual user setting.
     * @private
     */
    mediaRemotingEnabled_: {
      type: Boolean,
      value: true,
    },

    /**
     * The route currently associated with this controller.
     * @type {?media_router.Route|undefined}
     */
    route: {
      type: Object,
      observer: 'onRouteUpdated_',
    },

    /**
     * The route description to display. Uses the media route description if
     * none is provided by the media route status object.
     * @private {string}
     */
    routeDescription_: {
      type: String,
      value: '',
    },

    /**
     * The timestamp for when the route details view was opened.
     * @type {number}
     */
    routeDetailsOpenTime: {
      type: Number,
      value: 0,
    },

    /**
     * The status of the media route shown.
     * @type {!media_router.RouteStatus}
     */
    routeStatus: {
      type: Object,
      observer: 'onRouteStatusChange_',
      value: new media_router.RouteStatus(),
    },

    /**
     * The ID of the timer currently set to increment the current time of the
     * media, or 0 if the current time is not being incremented.
     * @private {number}
     */
    timeIncrementsTimeoutId_: {
      type: Number,
      value: 0,
    },

    /**
     * Whether the controls should show the media title.
     * @private {boolean}
     */
    shouldShowRouteStatusTitle_: {
      type: Boolean,
      value: false,
    },
  },

  behaviors: [
    I18nBehavior,
  ],

  /**
   * Called by Polymer when the element loads. Registers the element to be
   * notified of route status updates.
   */
  ready: function() {
    media_router.ui.setRouteControls(
        /** @type {RouteControlsInterface} */ (this));
  },

  /**
   * Current time can be incremented if the media is playing, and either the
   * duration is 0 or current time is less than the duration.
   * @return {boolean}
   * @private
   */
  canIncrementCurrentTime_: function() {
    return !this.isSeeking_ &&
        this.routeStatus.playState === media_router.PlayState.PLAYING &&
        (this.routeStatus.duration === 0 ||
         this.displayedCurrentTime_ < this.routeStatus.duration);
  },

  /**
   * Creates an accessibility label for the element showing the media's current
   * time.
   * @param {number} displayedCurrentTime
   * @return {string}
   * @private
   */
  getCurrentTimeLabel_: function(displayedCurrentTime) {
    return `${
              this.i18n('currentTimeLabel')
            } ${this.getFormattedTime_(displayedCurrentTime)}`;
  },

  /**
   * Creates an accessibility label for the element showing the media's
   * duration.
   * @param {number} duration
   * @return {string}
   * @private
   */
  getDurationLabel_: function(duration) {
    return `${this.i18n('durationLabel')} ${this.getFormattedTime_(duration)}`;
  },

  /**
   * Converts a number representing an interval of seconds to a string with
   * HH:MM:SS format.
   * @param {number} timeInSec Must be non-negative. Intervals longer than 100
   *     hours get truncated silently.
   * @return {string}
   * @private
   */
  getFormattedTime_: function(timeInSec) {
    if (timeInSec < 0) {
      return '';
    }
    var hours = Math.floor(timeInSec / 3600);
    var minutes = Math.floor(timeInSec / 60) % 60;
    var seconds = Math.floor(timeInSec) % 60;
    // Show the hours only if it is nonzero.
    return (hours ? ('0' + hours).substr(-2) + ':' : '') +
        ('0' + minutes).substr(-2) + ':' + ('0' + seconds).substr(-2);
  },

  /**
   * @param {!media_router.RouteStatus} routeStatus
   * @return {string} The value for the icon attribute of the mute/unmute
   *     button.
   * @private
   */
  getMuteUnmuteIcon_: function(routeStatus) {
    return routeStatus.isMuted ? 'route-controls:volume-off' :
                                 'route-controls:volume-up';
  },

  /**
   * @param {!media_router.RouteStatus} routeStatus
   * @return {string} Localized title for the mute/unmute button.
   * @private
   */
  getMuteUnmuteTitle_: function(routeStatus) {
    return routeStatus.isMuted ? this.i18n('unmuteTitle') :
                                 this.i18n('muteTitle');
  },

  /**
   * @param {!media_router.RouteStatus} routeStatus
   * @return {string}The value for the icon attribute of the play/pause button.
   * @private
   */
  getPlayPauseIcon_: function(routeStatus) {
    return routeStatus.playState === media_router.PlayState.PAUSED ?
        'route-controls:play-arrow' :
        'route-controls:pause';
  },

  /**
   * @param {!media_router.RouteStatus} routeStatus
   * @return {string} Localized title for the play/pause button.
   * @private
   */
  getPlayPauseTitle_: function(routeStatus) {
    return routeStatus.playState === media_router.PlayState.PAUSED ?
        this.i18n('playTitle') :
        this.i18n('pauseTitle');
  },

  /**
   * @return {string} Text representing the current position on the seek slider.
   * @private
   */
  getTimeSliderValueText_: function(displayedCurrentTime) {
    if (!this.routeStatus) {
      return '';
    }
    return `${
              this.getFormattedTime_(displayedCurrentTime)
            } / ${this.getFormattedTime_(this.routeStatus.duration)}`;
  },

  /**
   * @param {number} volume
   * @return {string} The volume as a percentage.
   * @private
   */
  getVolumeSliderValueText_: function(volume) {
    return String(Math.round(volume * 100)) + '%';
  },

  /**
   * Checks whether the media is still playing, and if so, sends a media status
   * update incrementing the current time and schedules another call for a
   * second later.
   * @private
   */
  maybeIncrementCurrentTime_: function() {
    if (this.canIncrementCurrentTime_()) {
      var updatedCurrentTime = this.routeStatus.currentTime +
          Math.floor((Date.now() - this.lastStatusUpdate_) / 1000);
      this.displayedCurrentTime_ = this.routeStatus.duration === 0 ?
          updatedCurrentTime :
          Math.min(updatedCurrentTime, this.routeStatus.duration);
      if (this.routeStatus.duration === 0 ||
          this.displayedCurrentTime_ < this.routeStatus.duration) {
        this.timeIncrementsTimeoutId_ =
            setTimeout(() => this.maybeIncrementCurrentTime_(), 1000);
      }
    } else {
      this.timeIncrementsTimeoutId_ = 0;
    }
  },

  /**
   * Called when the "smooth motion" box for Hangouts is changed by the user.
   * @param {!{target: !HTMLElement}} e
   * @private
   */
  onHangoutsLocalPresentChange_: function(e) {
    media_router.browserApi.setHangoutsLocalPresent(e.target.checked);
  },

  /**
   * Called when the user toggles the mute status of the media. Sends a mute or
   * unmute command to the browser.
   * @private
   */
  onMuteUnmute_: function() {
    media_router.browserApi.setCurrentMediaMute(!this.routeStatus.isMuted);
  },

  /**
   * Called when the user toggles between playing and pausing the media. Sends a
   * play or pause command to the browser.
   * @private
   */
  onPlayPause_: function() {
    if (this.routeStatus.playState === media_router.PlayState.PAUSED) {
      media_router.browserApi.playCurrentMedia();
    } else {
      media_router.browserApi.pauseCurrentMedia();
    }
  },

  /**
   * Updates seek and volume bars if the user is not currently dragging on
   * them.
   * @param {!media_router.RouteStatus} newRouteStatus
   * @private
   */
  onRouteStatusChange_: function(newRouteStatus) {
    this.lastStatusUpdate_ = Date.now();
    if (this.shouldAcceptCurrentTimeUpdates_()) {
      this.displayedCurrentTime_ = newRouteStatus.currentTime;
    }
    if (this.shouldAcceptVolumeUpdates_()) {
      const volume = Math.round(newRouteStatus.volume * 100);
      this.$['route-volume-slider'].value = volume;
      this.displayedVolume_ = volume / 100;
    }
    if (!this.initialLoadTime_) {
      this.initialLoadTime_ = Date.now();
      media_router.browserApi.reportWebUIRouteControllerLoaded(
          this.initialLoadTime_ - this.routeDetailsOpenTime);
    }
    this.stopIncrementingCurrentTime_();
    if (this.canIncrementCurrentTime_()) {
      this.timeIncrementsTimeoutId_ =
          setTimeout(() => this.maybeIncrementCurrentTime_(), 1000);
    }
    this.hangoutsLocalPresent_ = !!newRouteStatus.hangoutsExtraData &&
        newRouteStatus.hangoutsExtraData.localPresent;
    if (newRouteStatus.mirroringExtraData) {
      // Manually update the selected value on the
      // mirroring-fullscreen-video-dropdown dropbox.
      // TODO(imcheng): Avoid doing this by wrapping the dropbox in a Polymer
      // template, or introduce <paper-dropdown-menu> to the Polymer library.
      this.$['mirroring-fullscreen-video-dropdown'].value =
          newRouteStatus.mirroringExtraData.mediaRemotingEnabled ?
          this.FullscreenVideoOption_.REMOTE_SCREEN :
          this.FullscreenVideoOption_.BOTH_SCREENS;
    }
    this.shouldShowRouteStatusTitle_ = !!newRouteStatus.title &&
        newRouteStatus.title != '' &&
        newRouteStatus.title != this.routeDescription_;
  },

  /**
   * Called when the route is updated. Updates the description shown if it has
   * not been provided by status updates.
   * @param {?media_router.Route} route
   * @private
   */
  onRouteUpdated_: function(route) {
    if (!route) {
      this.stopIncrementingCurrentTime_();
    }
    if (route) {
      this.routeDescription_ = route.description;
    }
  },

  /** @private */
  updateTime_: function() {
    this.stopIncrementingCurrentTime_();
    this.displayedCurrentTime_ = this.$['route-time-slider'].value;
    if (!this.isSeeking_) {
      media_router.browserApi.seekCurrentMedia(this.displayedCurrentTime_);
      this.lastSeekByUser_ = Date.now();
    }
  },

  /**
   * @param {!{detail: {value: boolean}}} e
   * @private
   */
  onSeekingChanged_: function(e) {
    this.isSeeking_ = e.detail.value;
    this.updateTime_();
  },

  /** @private */
  onSeekSliderValueChanged_: function() {
    this.updateTime_();
  },

  /** @private */
  updateVolume_: function() {
    this.lastVolumeChangeByUser_ = Date.now();
    const volume = this.$['route-volume-slider'].value / 100;
    if (volume == this.displayedVolume_) {
      return;
    }
    this.displayedVolume_ = volume;
    media_router.browserApi.setCurrentMediaVolume(volume);
  },

  /**
   * Called when the user updates volume with the slider.
   * @private
   */
  onVolumeChanged_: function() {
    /** @const */ var currentTime = Date.now();
    // We limit the frequency of volume change requests during dragging to
    // limit the number of Mojo calls to the component extension.
    if (currentTime - this.lastVolumeChangeByUser_ < 300) {
      return;
    }
    this.updateVolume_();
  },

  /**
   * @param {!{detail: {value: boolean}}} e
   * @private
   */
  onVolumeDraggingChanged_: function(e) {
    if (!!this.isVolumeChanging_ == !!e.detail.value) {
      return;
    }
    this.isVolumeChanging_ = e.detail.value;
    if (!this.isVolumeChanging_) {
      this.updateVolume_();
    }
  },

  /**
   * Called when the value on the mirroring-fullscreen-video-dropdown dropdown
   * menu changes.
   * @param {!Event} e
   * @private
   */
  onFullscreenVideoDropdownChange_: function(e) {
    /** @const */ var dropdownValue =
        this.$['mirroring-fullscreen-video-dropdown'].value;
    media_router.browserApi.setMediaRemotingEnabled(
        dropdownValue == this.FullscreenVideoOption_.REMOTE_SCREEN);
  },

  /**
   * Resets the route controls. Called when the route details view is closed.
   */
  reset: function() {
    this.routeStatus = new media_router.RouteStatus();
    media_router.ui.setRouteControls(null);
  },

  /**
   * @return {boolean} Whether external current time updates should be reflected
   *     on the seek slider.
   * @private
   */
  shouldAcceptCurrentTimeUpdates_: function() {
    // Ignore external updates immediately after internal updates, because it's
    // likely to just be internal updates coming back from the device, and could
    // make the slider knob jump around.
    return !this.isSeeking_ && Date.now() - this.lastSeekByUser_ > 1000;
  },

  /**
   * @return {boolean} Whether external volume updates should be reflected on
   *     the volume slider.
   * @private
   */
  shouldAcceptVolumeUpdates_: function() {
    // Ignore external updates immediately after internal updates, because it's
    // likely to just be internal updates coming back from the device, and could
    // make the slider knob jump around.
    return !this.isVolumeChanging_ &&
        Date.now() - this.lastVolumeChangeByUser_ > 1000;
  },

  /**
   * If it is currently incrementing the current time shown, then stops doing
   * so.
   * @private
   */
  stopIncrementingCurrentTime_: function() {
    if (this.timeIncrementsTimeoutId_) {
      clearTimeout(this.timeIncrementsTimeoutId_);
      this.timeIncrementsTimeoutId_ = 0;
    }
  }
});
<link rel="import" href="chrome://resources/html/polymer.html">
<link rel="import" href="chrome://resources/html/i18n_behavior.html">
<link rel="import" href="chrome://resources/polymer/v1_0/paper-button/paper-button.html">
<link rel="import" href="../route_controls/route_controls.html">
<dom-module id="route-details">
  <link rel="import" type="css" href="../../media_router_common.css">
  <link rel="import" type="css" href="route_details.css">
  <template>
    <div class="ellipsis" id="route-description"
         title="[[routeDescription_]]"
         hidden$="[[shouldShowWebUiControls_(route)]]">
      [[routeDescription_]]
    </div>
    <template is="dom-if" if="[[shouldShowWebUiControls_(route)]]">
      <route-controls id="route-controls"
          route-details-open-time="[[openTime_]]"
          route="[[route]]"></route-controls>
    </template>
    <div id="route-action-buttons" class="layout">
      <paper-button flat class="route-button button"
          id="start-casting-to-route-button"
          hidden$="[[computeCastButtonHidden_(route, changeRouteSourceAvailable_)]]"
          on-tap="startCastingToRoute_">
        <span>[[i18n('startCastingButtonText')]]</span>
      </paper-button>
      <paper-button flat class="route-button button"
          id="close-route-button"
          on-tap="closeRoute_">
        <span>[[i18n('stopCastingButtonText')]]</span>
      </paper-button>
    <div>
  </template>
<script src="route_details.js"></script>
</dom-module>
/* Copyright 2015 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

#route-action-buttons {
  @apply --layout-horizontal;
  @apply --layout-end-justified;
  margin: 0 10px;
  padding: 0;
  white-space: nowrap;
}

.route-button {
  background-color: white;
  line-height: 12px;
  margin: 12px 0;
  text-align: end;
}

#route-description {
  font-size: 1.2em;
  line-height: 1.5em;
  margin-top: 16px;
  padding-inline-end: var(--dialog-padding-end);
  padding-inline-start: 44px;
}
// Copyright 2015 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// This Polymer element shows information from media that is currently cast
// to a device.
Polymer({
  is: 'route-details',

  properties: {
    /**
     * Description of the current casting activity, e.g. "Casting YouTube".
     * @private {string|undefined}
     */
    routeDescription_: {
      type: String,
    },

    /**
     * Whether the external container will accept change-route-source-click
     * events.
     * @private {boolean}
     */
    changeRouteSourceAvailable_: {
      type: Boolean,
      computed: 'computeChangeRouteSourceAvailable_(route, sink,' +
          'isAnySinkCurrentlyLaunching, shownCastModeValue)',
    },

    /**
     * Whether a sink is currently launching in the container.
     * @type {boolean}
     */
    isAnySinkCurrentlyLaunching: {
      type: Boolean,
      value: false,
    },

    /**
     * The timestamp for when the route details view was opened. We initialize
     * the value in a function so that the value is set when the element is
     * loaded, rather than at page load.
     * @private {number}
     */
    openTime_: {
      type: Number,
      value: function() {
        return Date.now();
      },
    },

    /**
     * The route to show.
     * @type {?media_router.Route|undefined}
     */
    route: {
      type: Object,
      observer: 'onRouteChange_',
    },

    /**
     * The cast mode shown to the user. Initially set to auto mode. (See
     * media_router.CastMode documentation for details on auto mode.)
     * @type {number}
     */
    shownCastModeValue: {
      type: Number,
      value: media_router.AUTO_CAST_MODE.type,
    },

    /**
     * Sink associated with |route|.
     * @type {?media_router.Sink}
     */
    sink: {
      type: Object,
      value: null,
    },
  },

  behaviors: [
    I18nBehavior,
  ],

  /**
   * Fires a close-route event. This is called when the button to close
   * the current route is clicked.
   *
   * @private
   */
  closeRoute_: function() {
    this.fire('close-route', {route: this.route});
  },

  /**
   * @param {?media_router.Route|undefined} route
   * @param {boolean} changeRouteSourceAvailable
   * @return {boolean} Whether to show the button that allows casting to the
   *     current route or the current route's sink.
   */
  computeCastButtonHidden_: function(route, changeRouteSourceAvailable) {
    if (route === undefined || changeRouteSourceAvailable === undefined) {
      return false;
    }

    return !((route && route.canJoin) || changeRouteSourceAvailable);
  },

  /**
   * @param {?media_router.Route|undefined} route The current route for the
   *     route details view.
   * @param {?media_router.Sink|undefined} sink Sink associated with |route|.
   * @param {boolean} isAnySinkCurrentlyLaunching Whether a sink is launching
   *     now.
   * @param {number} shownCastModeValue Currently selected cast mode value or
   *     AUTO if no value has been explicitly selected.
   * @return {boolean} Whether the change route source function should be
   *     available when displaying |currentRoute| in the route details view.
   *     Changing the route source should not be available when the currently
   *     selected source that would be cast is the same as the route's current
   *     source.
   * @private
   */
  computeChangeRouteSourceAvailable_: function(
      route, sink, isAnySinkCurrentlyLaunching, shownCastModeValue) {
    if (isAnySinkCurrentlyLaunching || !route || !sink) {
      return false;
    }
    if (!route.currentCastMode) {
      return true;
    }
    var selectedCastMode =
        this.computeSelectedCastMode_(shownCastModeValue, sink);
    return (selectedCastMode != 0) &&
        (selectedCastMode != route.currentCastMode);
  },

  /**
   * @param {number} castMode User selected cast mode or AUTO.
   * @param {?media_router.Sink} sink Sink to which we will cast.
   * @return {number} The selected cast mode when |castMode| is selected in the
   *     dialog and casting to |sink|.  Returning 0 means there is no cast mode
   *     available to |sink| and therefore the start-casting-to-route button
   *     will not be shown.
   */
  computeSelectedCastMode_: function(castMode, sink) {
    // |sink| can be null when there is a local route, which is shown in the
    // dialog, but the sink to which it is connected isn't in the current set of
    // sinks known to the dialog.  This can happen, for example, with DIAL
    // devices.  A route is created to a DIAL device, but opening the dialog on
    // a tab that only supports mirroring will not show the DIAL device.  The
    // route will be shown in route details if it is the only local route, so
    // you arrive at this function with a null |sink|.
    if (!sink) {
      return 0;
    }
    if (castMode == media_router.CastModeType.AUTO) {
      return sink.castModes & -sink.castModes;
    }
    return castMode & sink.castModes;
  },

  /**
   * Called when the route details view is closed. Resets route-controls.
   */
  onClosed: function() {
    if (this.$$('route-controls')) {
      this.$$('route-controls').reset();
    }
  },

  /**
   * Called when the route details view is opened.
   */
  onOpened: function() {
    if (this.$$('route-controls')) {
      media_router.ui.setRouteControls(
          /** @type {RouteControlsInterface} */ (this.$$('route-controls')));
    }
  },

  /**
   * Updates |routeDescription_| for the default view.
   * @param {?media_router.Route} route
   * @private
   */
  onRouteChange_: function(route) {
    this.routeDescription_ = route ? route.description : '';
  },

  /**
   * @param {?media_router.Route} route
   * @return {boolean} Whether the WebUI route controller should be shown
   *     instead of the default route description element.
   * @private
   */
  shouldShowWebUiControls_: function(route) {
    return !!route && !!route.supportsWebUiController;
  },

  /**
   * Fires a join-route-click event if the current route is joinable, otherwise
   * it fires a change-route-source-click event, which changes the source of the
   * current route. This may cause the current route to be closed and a new
   * route to be started. This is called when the button to start casting to the
   * current route is clicked.
   *
   * @private
   */
  startCastingToRoute_: function() {
    if (this.route.canJoin) {
      this.fire('join-route-click', {route: this.route});
    } else {
      this.fire('change-route-source-click', {
        route: this.route,
        selectedCastMode:
            this.computeSelectedCastMode_(this.shownCastModeValue, this.sink)
      });
    }
  },
});
// Copyright 2016 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

/**
 * This class holds state that is relevant to the search process from the UI's
 * perspective. It primarily handles the spinner logic while waiting for a
 * search to complete. The spinner first needs to start on the pseudo sink, but
 * when a real sink arrives to replace it the spinner should transfer to the
 * real sink.
 *
 * Additionally, this class provides a method for
 * onCreateRouteResponseReceived() that maps the pseudo sink ID that started the
 * search to the real sink that was produced by the search. This helps check
 * whether a received route is valid.
 *
 * @param {!media_router.Sink} pseudoSink Pseudo sink that started the search.
 * @constructor
 */
var PseudoSinkSearchState = function(pseudoSink) {
  /**
   * Pseudo sink that started the search.
   * @private {!media_router.Sink}
   */
  this.pseudoSink_ = pseudoSink;

  /**
   * The ID of the sink that is found by search.
   * @private {string}
   */
  this.realSinkId_ = '';

  /**
   * Whether we have received a sink in the sink list with ID |realSinkId_|.
   * @private {boolean}
   */
  this.hasRealSink_ = false;
};

/**
 * Record the real sink ID returned from the Media Router.
 * @param {string} sinkId Real sink ID that is the result of the search.
 */
PseudoSinkSearchState.prototype.receiveSinkResponse = function(sinkId) {
  this.realSinkId_ = sinkId;
};

/**
 * Checks whether we have a sink in |sinkList| that is our search result then
 * computes the value for |currentLaunchingSinkId_| based on the state of the
 * search. It should be the pseudo sink ID until the real sink arrives, then the
 * real sink ID.
 * @param {!Array<!media_router.Sink>} sinkList List of all sinks to check.
 * @return {string} New value for |currentLaunchingSinkId_|.
 */
PseudoSinkSearchState.prototype.checkForRealSink = function(sinkList) {
  if (!this.hasRealSink_) {
    this.hasRealSink_ = !!this.realSinkId_ && sinkList.some(function(sink) {
      return (sink.id == this.realSinkId_);
    }, this);
    return !this.hasRealSink_ ? this.pseudoSink_.id : this.realSinkId_;
  }
  return this.realSinkId_;
};

/**
 * Returns the pseudo sink for the current search. This is used to enforce
 * freezing its name in filter view and displaying it in the sink list view.
 * @return {!media_router.Sink}
 */
PseudoSinkSearchState.prototype.getPseudoSink = function() {
  return this.pseudoSink_;
};
<!DOCTYPE HTML>
<html dir="$i18n{textdirection}" lang="$i18n{language}">
<head>
  <meta charset="utf-8">
  <title>Google Cast</title>
  <link rel="stylesheet" href="cast.css">
  <link rel="shortcut icon" href="cast_favicon.ico">
  <script src="chrome://resources/js/load_time_data.js"></script>
  <script src="strings.js"></script>
  <script src="cast.js"></script>
</head>
<body>
  <extensionview></extensionview>
</body>
</html>
/* Copyright 2016 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

body,
extensionview,
html  {
  border: 0;
  height: 100%;
  margin: 0;
  padding: 0;
  width: 100%;
}

extensionview {
  overflow: hidden;
  position: absolute;
}
// Copyright 2016 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

window.addEventListener('load', function init() {
  const extensionView = document.querySelector('extensionview');

  /**
   * @param {string} str
   * @return {!Array<string>}
   */
  const splitUrlOnHash = function(str) {
    str = str || '';
    const pos = str.indexOf('#');
    return (pos !== -1) ? [str.substr(0, pos), str.substr(pos + 1)] : [str, ''];
  };

  new MutationObserver(function() {
    const newHash = splitUrlOnHash(extensionView.getAttribute('src'))[1];
    const oldHash = window.location.hash.substr(1);
    if (newHash !== oldHash) {
      window.location.hash = newHash;
    }
  }).observe(extensionView, {attributes: true});

  window.addEventListener('hashchange', function() {
    const newHash = window.location.hash.substr(1);
    const extensionViewSrcParts =
        splitUrlOnHash(extensionView.getAttribute('src'));
    if (newHash !== extensionViewSrcParts[1] && newHash.startsWith('offers')) {
      extensionView.load(extensionViewSrcParts[0] + '#' + newHash);
    }
  });

  extensionView.load(
      'chrome-extension://' + loadTimeData.getString('extensionId') +
          '/cast_setup/index.html#offers');
});
    @@     (@  F          (  n@       (	  P       (  Y  (   @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                y$ fY33                        3Pacbbbccb'c bbmbbbbbbbbbXbb
b<bbbbbbbbbb/b b b
b
b
b
b
b
b
bbbbbbbbbbcbR5         K{$  pU?-  


M   ?w! $zVF/  


		A di/QN/  


		f,|N?CS{+  


		~-10X6	_q'  


	22N+zr$%pf" 


	32l NY5Y
		31y13}?JH
		21t4
 bw' c}4
			21[' UQ/g"
			21d=S~,RR





		2D1HE?1	-\Q +{=
	




		21
!Cts) Np*




				21$3Kl<	-|P



				2N1VYdoS \{3


				21^  GW	


				21f$3~5


		21a& .qT 

		21Z#&gs-




		21G	-fE

				21a62m]#



		

21f?Dzo-


			


21uY>#|*V<	



		2x1~}ubS?*}%GtH



		2$1(()%~(FmO



				2x 1~"->UtR



				2$1*-29ANaxQ 	

				2x1M

				21wC




		21h5



		21P*	



		21d;	



		21hD&
	



		21eE)		



		21lT<'



			21wdO:+




			2S1TSVRIC=6*



			22



			32



			32

						2-}

							
~-!!f f$#B""#"!!  A+&P##$$$""""N    $'&6(R'a'b'a%a%a%a%a%a%a%a%a%a%a%a%a"a"a"a"a a a a a a a a a a aaaaaaaaaaaaaaaaaaaaaaaabaR6 $                @636666666666666((((((((((((666666((((((((((((((((((($(+                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (       @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ()K)(((((f(((((P    HmPA/s}PSN' N. T CrNpJO< N /8N=N#uNb/NO
qbNt<z2y N|7KNWcNmN=NQNa7PP    PP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (      0                                                                                                                                                                                                                                                                                                                                  ;YYY YYYYdYYYYY(YY	Y	Y	YYYY<    Ha)
IM#@9
| o		{z^ R
	{{wIF
	{{D


	{{JL
	{{#
		{{]#}B

		{~{1`!
	{{

	{{[
	{{[
		{K{N<%
		{
		"L ! J    ->(Y(Y(Y%Y%Y%Y"Y"Y Y Y YYYYYYYYYY=                                                                                                                                                                                                                                                                                                    (                                                                                                                                                                     ..@c 	.*=c 3n';	=.iYa
	$p 
d$

	VN.[0
	3
	~
	~P
	%0$"  /                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      PNG

   IHDR         J~s   aIDATx=
@DRkIcXY`+^4[ x	5;H|P"J<JoF|A\~1~    IENDB`PNG

   IHDR         J~s   cIDATx@pu9 @r l3kcsur ^X4PwO!`DH|PWk>|5/.z@U;    IENDB`RIFFzp  WEBPVP8Lmp  /HlI$(=(:"??QGd"CdIz2 	! ~\*x.QFC[mS-~6xsxM9N|&3AR@/oN|?^=k~ 8}qvszG.U1iAi,IRF0rkEk	.sIPd&moZtKQNEQZe:$IR\|y)aHH
ZO@?Q @	I)a !Q#Q)"c/\ @@ .NH]RJU-}ry`  p	 @DS~Y<6YJL86l6-i.	|?RG:P|Q&}i:}oz:/KL tVi=i*6[YxzNmZ;n&!mHi6<GE9IBH< zmgF6$N3$i:H5:$e+~	;$!0xIl9>@<.~:6,cE_CSVu6 b7	: FW7`OF?Qzn?sPAt11\m6IrQ)e&x! 3vl]}E& ( OMHRd1fyfp)@`7Y95> 	l6mQjH=[h'87 5>$~2 Cm&m3Im8Ohz?$I"=x?l1`%M.$fVa@@Xck {( m#Adqm$=_bvI$Y*YU"^gaw~.|EI!y:u0 AiH {$Iu<i&1s F
?Zo!7tB:p:m,HOL^S|#;Wx=7wnM9>oL}m:Nlk]1#%I?l:n T>p{3_><8lxd,z&?OjB\2Y/Mkwek)8/?ux:]>t|sl]x,Qxz%q;?;&|~7-EcQ{O	D]5!/uJ\KyC$#CmyM{^zax:g?qOM
IusVch2"j!?Dy2$/|~>,f 2B'$ hn_cGh` P+A; &G[[mS("&O~n|~kmfHnPO=+BRWwa"G)aEO]EFPG$<O3H!jq8I~ <hMo__M?	E~=yqVw_?_?E%68|	8;Ff?_&	S[33__?O?))_Y;o?bXu8W)rgy?u=W?GGD?li<3OS)Bs>?g[O	___d_YHoA?i_|ipR/rr/%?}p}vO#?|4s[P$-'m.CG=?{{s>>P\oYZ=q~oec%o|:{ZNl0k>-q3{0:8=y6m-B.f~l^5|m#f37g 9n<7_|SY6aDHi1c[6.wlch'g7FuB$gfB$g2}
r`N)2c38w^kS`[;^(3uvOccg	BiIl:tmP4xZ=0($(IL^6~$!S{kL<mXLk8{6y 3IhEqzv4coKR+c3$.b)yN:0mw)e6FrbnRAFL^lvoB	0\2kmv{()J^5fkYeIY93Zcs}Uz*EgvsZ;1Z&q[KrYw{lc]mYh7w6f7J)R{4l>LM?s` JR*k7ym5o9aD.U+Fg/ZYXiacTZCk:jeFk4f>WK*W<4y#3l[sb|zdmlKGc/]J'b_hZJOa1p))fbB3M{+O3;3BU6;f13Y|,RBl.8sa`Haaf(^n[	y1pvamf^RT|3:g{J>81j59"Q%Re?rDu;]n%,8cck^YBbgs%%mmGjqIX9eH^UBg<Jae79Co#aaelM$$Yf3NrJtg1{`wxq:-*-"0ck67a\19^()`{cok_SZ)RoeyF1`q6!.KE6Q53eBg]!(Df["QyaE061@RGo0xl`/PJ|9R>v60.'z!B"zis5bf0K 9Y8svM64a!5d-=qqr0Bc,glqe97DtmG-3br99YB{,w1]:/v;.$O=}kG|j9/?hru`?~>y/!.`H 4|Q.,} @ HAq! a1&/C6N4^,@f Bt<!NAdIdB``%,Dy"SP d#I?)-^P0Teang`jn!2jDB|T r87#dnmfr$ }F2g=T\}fqm$;mXn/d>"zM>[V+JzY8K3w?+KsCw@gi=tC5>K93Q?tdEy==+6NmimsZf,n1'L&~').\n%X>GG:-EeumC=:}Xj'eL1>k -8['v<B |V|NL~_b#:1>h>;fs'5iC{n}MZ-58TRo>\QPpp\>'$ W32#vkU!.; &*CZ:qket rq=O=GxE vUS	Hru-  qUGz:z%z%v*5`i~kDx`v(o]8u'*3*xF`hm3eyD-@25MAqOCN|4xL^bF_5kXi[A4;m	f7][|m(<	CL;u4)4Hg$IGY0	uz`';M6tba`PB 5lGv;mR l.YK)f<bRpuhM]kxp_sZaay$U 0kt~cXz EJCsrU~VWSa9 &!H'fvcfzy.HL"3' 	AGiQdq UNqx=
rXc$kixOg#XfP14!W`_@'yTOB@az`=`-v<
@jC%4q>d=6c~l,030	$M8 mKi).}jm>{kg*SR Y!<s\O3L0cHRIEZ&YS9K7j
5/ f@ TP?rU6]c}8cb:3uvXjK63H3jA0~M
`A.w(q$z$  s ~Alc465U+eGq(%R6=`ETy
h n
]Ic0e
`@6#4QjlrjP_ At+81DMfa>mmVc6#Z<g$3l pI	Q7L!+3(+Z>N/Q
wzi'!ub8<p,F$.z!0O{;Dqd$BL]fB`/|]^C'x0c%bc(5&fOgu-9szjnr0|)@<y~J=mxOBPH=lt lgksO2=d ilwY/lagk-P[L<NK I{,#1&P|xQ~( %`jOgWH&G'W,$IBIR&1n	`+5uy&6jooq.  `x oZG!)@Z0psB!$,na\ZIlLvkvM;yx4K	uVh	E*d@F6le=HH9%{?M$$H\ND ;=0@,:UyHU>p( ^}K,c"$tui"|]4D+f HL>&SN\Te H  Z
xH( -t*59I(vKE C|:9M 3JTl_DBZ8Ma[Y?kZe1A/<vM>G@$thfQ mD[
bVxxX zxaAnqee4Zn}QQ- A<9&6`jx>PXPnjq()E1+kU :G\>#.ut[c1cL>3=J	ZV:*LC:+J%B7
sQ1
VgDoZ>/|[[yO3Ob4q[dj)ds0`#QQ2cAlj2S;0yoQpQ?~+ZSE0Nj6+S11o61jieZ_WSkf9**WYFfiez0)yleN#2s;bk>`PT#f9ag}hK(rib5-_n'sy6FYz*y|_?PVYM=r_adhFfrf%lKbrq`qRqg:^2wV6=JA1[h]]~><pej>t(d\(c3,HQ(@#^/XveIihm	m`i2sT%)Vz:*@`hF,0*:p?8lke{yCY;\NMc`R*E3z>op'_GcDCkC%d8dB.1s,e3EnkW4mqARdZFkia2kKo=Zg @_h*nP&o7)YfQx>]3?w8D.u-=6/v`TrRRsm=NC*V:"tr)t&2&W]Se0sm*im#tRf6&z#irj?HrGP$@t f:(EBRH,):m[fw("D8^ttnwX3Gh<TJ80"z2F!Oi9@l	#kb3d.M;MJ3lHuzG
==^B
[q|TN@(-=R:Rr6Yez0(m>Z`vE%E*o8n6xb=6	WqSA)c5Af30 W5eA)*y4FB2?j~.=Tlnq&:SB	531K.}36,Z#Azw$z(Wac#Pyl7guK@)/	
sMv1#O1s)Klf `yP<5z?oPp[l"$"IY&p.N[|CkE/ #"*nqYPBX.I{\x `/sB=01QPT9Ts!787   A}V!)%ZB,S9A#= lH#`j0Ea&mT	3L.	9!sp\yDfIU
|UB|,=,x`@g*i%~<'UL2kGAQ8j0/	nD!"c,v
9$ wR@m @<3[X>z 
 +	P +_=W4_*ARpH	 NlcS DD+mgG%2 a JxU*G@AG90l&M:<h>{g_lv}uy{Nd%,g0'<=dkr4	hTP1|gkb.y1]/_kzX?R //k5{iT_aVJ4\!>E?:ho#	_V[IypwOvsOq	>rlge[Y,dVtmHt4}?0s+?-LcD{SEP>xO,5w|@{>_9KOlPt,y%Qaz3R>i] Vnke6N>GLfGG}!qOYOc\vWv\XW=n.)dJ~H?sh|f;'}d@yb$bUWvfu`+l`QY9whpO'+r	~t_hv5[17,5f}\Dmm
"/|UX[ 9Zk4.<@gX}UAXjdQA]{BH\g,sK*vyjCyOXV`QTheQc buk?&R+}[W""@lt2M hU(Y"R
-:3[	paQq.0* NP@B>9J^O%=0i^_O=gZrYOh''^jB-J %hJ<!P[_zzieKD)7Y:svx@3!eua]+Y@45{+/. nu]i=Zg"kS.<ga J%gVq"| @ptJwcz:la*4p>{'L@CVt,P WyCC# 0qi])kzCWX	 	') >/7^%/? %gtzxqq}2 @H(/V.qe~^Jt/"P.@:ZX aaR9@\gm=5B{L\$K}bJ[B;[56a Ex[8@\tWO+@YJAw&Cq?B]r4w^m)\pFY5ka^/=]!0)Ke#,j=JG:YNW!U[,~DN5+8 Yr@}(>N]2dP*mdN>$>j	ex,x6Eb-[(Ac6Pk<
iA4cf p9S3K"vD5^"3/Dj?anvhFrSjqfH^@e-5lH.T-
nq(>fMOtN.JAUW`gCI\9Q%]\/J&ytV,Bx(juTla1-omPc\__<6XvlMgkuT)2cKI>z).Cp]uu~Zz|s453xd7Nn)|T6% l9Spzsk]jy+tJ
7c};WaD45&v,}|M>[,ESet>Eed}-yYPi^e@LAy$jD^	0KStCA[S*	,p1))*#Cu&>!s0` 6<QB,=T>r~@&r
?xD>`k':jHp@B#-%da,VKyA[LCrFpZF_&{YbN B6j[@,2 &}EDu9u,DBZl)gks+I+_?< |%u~<&wM|?~W7yG?Bs3<39ggy3~vk;`mfcc~thGRoA;`ND{4?{89c3~~3c^w'c8g?Kv^m?L39?K3>%f?K6^y3C?J|6;Yt<y0&;XY:6`d}f0}g>.?Gwyc~7^m+uQ3EPII,W@T@ HA[4@@_F3B#fdYk$qS`AcQ*\|L$x@+K$6F1YhLD ?@9 VJ<(H$+-)k g-X;\I8+4;tDUlF5`fvf3;qC4!  =D%##Kli7q&sr>JPj!lEY@/k6(m$+W^>T1E#|,$p(g140
X &,ffq!5i iXq	*@7&dOh X
 @H623!f@\j+dVuu!,:q
UrF)X[QB@0iXX1'*;<b{>8;# &QJX@OZlg@7ca@{{a$fWT; V@ xP"hyK_6RX7 .\[h)gIY0U#63bXjq* !!ibL"q-H	*%KxA	0K@Di4c2>FRQJ<Guen?a?ohQh :Be!"QHH\d=Y2p5p[~TAY~R zn^5v!ULA@<;;Oj*Ph8&A4!Ygs:LeiL&=?x\ZB`Xp	WEv=2UP78 K0!7@V,OXT@Kt)WZz~l X`afRThsg.\+4a*aAH@uzjhtHEsVR
V2K~f6YX4nZM2\w`c<x<3L[w5?XX[X5v42Fea?,i\qE/hdH{cVYE0JxuB:;7b"Fy'X8[PF{o<)jy/nDg</0,O2z1 |dW,O" [ZgC)/Ec5Bp*-I;9%3;ZSeaS<@hSS&bca)5w3}=	d;)(WfVz<~qv|ebo
WfdUKfaZQ3 `?8[#P@9{84q1hu~0!FkTT1=  iMfo224`FT6*	T]h9]7q/6PcB 4 Aq6&+jbQ4.>r`Xb<7e6^#iLWf@UL:R4foW?[Pks'5qj a?p&4(yog6e
c5O>MxSeLs:&0TI*4Nm;\Q6	@e	Eaq93Rf2d\A\ \%0 Sx[*{w&=c_kILVVN-WZ23R4xsug^NX4_kxlBH0-hcsZ3N,'xcTzf(82&uvTmRY#M) xvc*O NfI  PFfRvj w.?v5e),@oH	Y=L)X{U".R@a[@  4m '	]Zf{eLxnrQ3"(Q -[TPTsv|!\8W]~>i<lKQK"R/%GO(xr]k4fnZ[l!Dp) h6 XURW5ED5h`  A:0~^dR!'r*p _V#kQ{Na1\. 8"]($b]H<WnQpS. ?sa 66KiK!S|A91Q
Lx)R2q_=LRD2xHE8cP^JKPJqy`K)?VJdL$bpbf2_J4PpZ	(OL~TNqnb1QQ d ;KY,sR2'fFR/2eH!ed+S]Xb:	'8L|e2NE8!V^+[DKp _:05|*Fj/cV[uu`@h<I\:3Z^S;3kSb$@!
F4
 v#e]i$#])lukH
17 (S :`q1xE <zj")XQ*cmu	PJmi~Vkn
~nb6 @H[7HH&%PS<EcC^T,8/ h'%018]{N@X[QJt%79#/06udaaAY9KJKJ %@40oj+
6!  (UPxMJZ(a/,B@(% t J{NPYa
!rg |qFJDRRkamI<B	%l"v b 10du1Ff2 je-9|JB e85	.G	})$YMv%$J [2rF 4Clf82:T!A2]3BlKf),#rr O2bg! @F*b J1Kn@YAkHBP\Q 80X<fPse)tkri1W0H@	(d9aQktI Ypv6	6bW5
<#.V@zNsO 44<tg`ay\eY
92BtDr2?OrhC^3r-D4!%Ez^.as?n~+ 68[>?G?xsno/|;~>yg_w ebW9Q}XF,S/no|t{?<\`>(ogpsvsGGo!mu>,?EI72,[>9Z9%:]m~96[tj.tgk0~L9]/.$__5kx>q?/s"%hPe|6~g>e^g_v0f?'zk)-9(g`dg/>1aryn^gt3'f1aN,#w"xas }Y20im;3\h68,h`1P.pY"f1"mq93fd`i98evw^TPL0f}E1J@.%ocHa7F$$
c3GTJ.0b?'t0Mg!hYgf	^
il@l//%mYMmA3sT$of09:MsBa3f8YBnv" ~k-^6 QY/
}C1:h3Vu73So^/e_56f&$.(&f`Fyg7Ze\<aZ}mUol.cyhG`MX/6)uY>v_9d|lx.Wyp(Gvki8\\.m^6y\{f-2`d;cG{i6{:qq]1zp8>2{k}c{fr#^ca~NX:a][^wgqnbf;cZnCK0ps=h&CC\}yE<.]{y_uo1!k9s1kX"1#)WH:c68lfys=wY+^Z'r|q{etP.nw-6OGqz.{y<*a}c`vw-s
86{q]pxu2sK^_k]u\]qUb/{y\Eapl[&[9eVr^7{ul#Jp8:ZwkM}*w6l?;kzvl3zy=&R^m6Gl<T`_r|.uf1[3bNZLD`Ycvci/Wx}ra0
z=mLc!qoo~l
a_udm,Mkp4JrRc>s`sdd-F~i(J%a9ll61:DdN/p.=x#86q5hFhR\{B=X&h-$FuP?2D\^g8P.iQ/u!]S+zl{qvZuS[J
L6ZCL/(ARJ"aGom6a#,7D5^|N}i^|lV{0^_o%J).cic;zol|9uRHJrys]\3llyK$<`o!Izm{8_4NL0DGH>lrqlZC|}RFjW_l(76l>\\\c|xri^kFbT}6pOhq(Dy]+}|ss~JfL$Io.=l}qtE/d/Hq,|AB3|;|b033roqPln$$,`{+b=ci0ow^IcoEI0/}Gx%b^D>Di$QHf[uz_{a}"t1oa0sM;3mf}Ey5m>p0=fy_k#g1e|qoYvD:AMEa%^.UIVKVmc;buzDs)Xr5Y~X0fX3f.\6c!KryvXZqwt7sC`d}A>'d9gTHgpQ1q	rP~EoAp3#P&}cOIJs*3bay>e<-nk-2.NK-?;3qR.^\v$6]Z+{v?`n9lcc1Uh3$9{5scp!yFmac{EvK[_{}^D'>M.#79^x}H:z6%{8]'h^on#kl6,\Ksl^]]28kw=^K~paFr~cpfOoX/[umRw5p<Kz]R31R~Q-'K}|>>f9J([6\_<_m=5=8|&99Qt{yvgs1CqG|//Rvr"88.zk6{e3^zyF6gnkMlfifvU1DeXMnC8s2/$9jbd*2{uE?N'31SP\m868^[u/TWh;_&fisAzy{u/3V\\9O|uU3ptcsc\$bp6tbT.\$%]W6sP(.=6>9c^gB_@U#Iw ^Dll6AJ}$Mi-W
fFHQ>rB_AGD3wG[_:1`H(_Z|&ydy=H>D(zv^4C ^)EVb~|
T,JQ[ S@sG^#K7el:c}1<EDGAVD^=/.|JVy +aH:(?-uenK^d frZi?}sKxC	=lH!@^ A~xScN.KOR=o>GN,<[2J ,%{"m|\GsW}yX8Q
aLSb' T]eK,9KBO	l5^c%?.{P'`6rC&iYX]j5L{a/=z\>Yr]f|c4[Vk?,v4=ut`() #ZB{z8><\-0s={M6):-.hlDH`IWoqzMmxJ{B}R{?>\rU?F5T*{i)'F;y!}<.6vo)H.lqmE\>KWHM!th{< S[ v0.[o1"7W?<|tHVMPxDq0DHqE"Fa\GRbIAOG5!dg(nBI,1FssV_}$DCkFniTxnbocr1?5y@!*epkt >nBK :7$2W~E77o[[-Ch(*exhCE#AD ?+G[:l[a&BZ[4b& c!ne),Pn:"8J_ayk~h&J^f;W23%|03~r^2LHPms$Du&Vs#xBg~ciH W$,M1ZlQ`}W'o[Q-vgtA(ByxAZGQ;M50km"Y#;UK!7quha#!tv-!Z	 v! eY5"cxd63?dv
8*9X~1	ZknuF[_oke4S#1KoKTG\*"k9nv?ug EdciUl|!$;6Rrmvn@+wh:;py1[!p?~:{kzjPnJo"9j]! ;3zvf0P[E<Ch]+0>@b?>6Gd@_-!NQe 4=(b ()t\G;$vB(qz{koX_%jZgA qW^.-tM:8G9a^<O?.<\z<)cD[s6\\B3cvA],q ^g	7[+;awOYMh^0' rG#</(m]!@we=:Eq	.Mm@[lbyK>n[ml/4>ZP!M\FN^"K]*5bSU$Zc`Gh+i-<4&)Q?7;XMhbg^@|% 4G\|7;]7%X4pAr?v{\R;h9MtiXY4Fwd-O6iB Ux-PESo|ccZs{s,B+!)w$fg BteMwS{%AL[:9"5(n-Sk[@WK$A $)

hqF\p@[v)2,kT hX@m22F`4*3_BR]	ltY~1>Zq^ALYF%5Hb^oyonz [7}$!$[g|1W!APOxB$'d&nLu1lzT
cP|}yCPHgW;'	(xe3t 6+j q'/ p{_xIYG
@B 0hV-@cpkCoW~Mnwk aROHnr@BW@4OX@	<9PT!,C<c{@2dN_vnZ#8sRD!t0{+\S	(Ah<
j+hvxkq!rAY>2))
[sK3.dC!Ahb5 o]$Qf&
|[%NYZIweDy< Fa.2oh%[GF8cwqr B?<8I`2Q3N%Y\Kp]l@qL,dvj(0!Q!@'rhJl<AS"-CHdF+7?_JafML[%b
K=|E 1O2dH>A@LiCH  7@4CM|T{;vYl4HljwCvAc~'i32QU,XS&d$|&	$ ja `'.S'lS)4dguV[H>q`/rV'7Z2&dG#@)L'@r
- h$A	@@30pA _yYGIZWFtFBHYlMUHMDh4ZB`P5I@h	!r*."x.M~F|;0a=7@&j$D%< Pvf>HijHG  d%E0vEP|@P$iya wAqCHBC Z$d@2!`YHnNww<w?W6oyW7Gv8@5 @HIe0J[6uX%4cEZguoyfx )3Zr`&,XQzpgdPmDQ-brWEG#Ar8t3 xL.LV@'v,PHle		X|~<?g]JD65__*[ [D vY	;YYJ#]IzDA$ ~bRVOCqTFct3 7l  "830[nb76&dtM!/$Z;|RW&`a*}g`F 1TvYL7)eDV?(qR~ogW@/iv,;u5e1%mo#9%"N$<[M};#?Nnj(HaB *(v_lL|]NSCS7A mFmXkxf4G.@pj6 .L/.E#~8v/(XCqP
3??@{$ Kwq$G?<&EzZ4NHsg43\H-\zf]b(K/1/D1jU%n"RG[n5o#.wvf|^9kkeQa.3j^\QTom>]HpE\WJ/P^~bi6x7[9PVlc1eZo]oZRgVS^cz+"(gujOgFxm^@$?*G5KhfnwL])w
q.k>RJ>#7/<Qb =
`b,c~qv5^DG6o	=_t':14PhJ:Ah}
f[\zdg.B7ZYak8r'9r=JXN\Om$+#n-GDaA`$I[US^_{A: }JeaQ*GhU `('oQ&2),r[h vjC8l;5iVk2A:e/_{=m'P/9A7vY5r87/4)5,!`oZoP=[6xQ 
Bk{S@&e9'zk11TP=#*,"*97]Wa4;h
q}~F3R_ZbUI-z^sU?Ts=f>9g`QE|a	t59'`m0s(n)#@\h2mi*ijFk]`00_eNo(C<$M	 {4[e$icZVjbg>H:i:mrGNl7qGvOUu%>^XhkL/S)4tYz L\-&[h{i1B6{m'USXxD^2v[suWYf	=fFLS3`y;'h;\J8)^`[2A>g{W{HUS$7@rzAfv4lTm9Bm`+f0v[ctluwKDv;Q(U#_f,nObv2bme;rt
Me7	XPrm+7mwie5=lEq 0ZvJpUjbgsgk;FVvPx1![(v7-Xf?[em#ZZkr_#5]+1ZL Qhotjh[;'	Y^hSs:{'wA^AXI)5hMtHF;?0h9e'AN:{stTut/l<ndVhv:Jqs$5eU3yDAn? RO/[!zc?;sEv_ X2~u.QXoRvu[bkW(ybhdMNw}sY/MAp'i
=ikN:p=0AV $G/.#83Rv8])g:o9=C}QKi"7ALPtjh+RR| f$.y!yi[q>Q~	Gvpi(|MIh;ETA8HVv[@5*sZtWknW7oVQE,4=!ZYHS%;f{P
kZ>_ljL;-l4w-hK7jX/@:)c"3
Xgd&H.5ruzSBhq;0EsvQ~t?Qf@nL2yjE$j-n&dDuy;5yo[4M{tZhNvRTukaf)$uMXk	  t1+6tA/8xn'zc:r4F8y6 ~<]k>  v
eym	X>F0k+l. SpqujmvH0b] g3oPu2`12[0WGLMjs^V;s
-smm<W`jS2jCse.KklM{!,aw	s o/BL4=6-Cw={5pYhu?o0)TB+-_h?JU7E}QHW>e]/_>EHGw(>h,	}$_;?28mfgNIE];Go;(/]^>WeV&C6z})zrF[AG[Gi#mFN~jGNK,DbBc9m/dLQhh0+~HH-lg7-&+_hjl`rB
x0Bm6~HvtN,0yYM|}-qGu:&yA{s7{v%4?SLir<f_DQ^$nou*|yFAscmz&9k<?ri76Dc%k_;(y	#4eY]}d67eLofvC~"W21M6M43#cesLc&Tg[9wd-chZg>Pd~0fn%4jqyC1lt||GeYEr8'J&22M&MwAAkXX,sNt6sWZoirZk`-3m[>lwJhy2tn9`;<jZl6LM0fkpYMc2>%$Sn0jGZYd	wElgQ3e2|Sy?w'+'vh>'RrC#[cv5Y5BAurDQcB/`:dDbC|$ZcsXi7!0WsuXZN3}swXtXkv:6)F6"C>f/uDI%gY-b?3_!h|0&51H>.EDwS/C;wAZZ.vj>`Y/T4}0aX,F76kG_enNtDGJZ.[P;@t#0{cre]oFlZ|m[\Gk
OA,--=TIcYk|h_2zY/<B:7#]]>U]'5eA/J<7sZ;"I-L:uou%wAB}H,3EG,y,u)kx~d5{|Ic-#N/b*}ahhtsa\rsJli%`ek/1V{dhE~cn(oV[5rgbm:-H2fqC#O&q3s'YM%&%},Z2G1d/XtBe(/Z4MmyjSL\l3'b,zh\e'sW?~||#sA;]2*).gh;Mnmn!h*saevgr53{sJ Yj/n0sV^]h\ks`B7r i4l5,q8e?1Yhna6c{'\z,4["fa7D(57'aR\k`mfXVKgB3I%vxf17-\%Dew,'i ny0cAD+^/Te0)JKzjl{3i!{4;
	r Q68=6dfLkoBp&os`\ta589{ZGQPsm M[>p[,/<JgCib;5dU%-NmZA9K8m(*oDGQyN3ly`>mR	)'yMZMn)-[#yi4LwDxxj
O<NWD"tG|2:c}Lk"p)=1cJr<bG10~#^ trs0{<d(a!*k^f_b}!$*k=ZP`(yiN%=e
u~B> RIFF  WEBPVP8    * X>m0I"!p9inPZ3g^t{m7>FU4/<Jye";5y.kR	Uua9;f)_E2/<Z{iXb
C~$s[rTHaJ!D+iNit%cp76Ut
94q:+IXIPf*tN|E)Nfu< cvta|N?V_+	R5EZz$,5 iK%O4sK\8^	,? XuyXK;74~t|]A_;U
&=oqx',S{zozrsvj=1IR;s=uJ|u4%,1w{Ub	
7W$y6Ob[z%BuH	!qSIAh74|d(& 9I_9Pj1*eUL ]z{9zG8QN&d86ojb+G1aG9h &I$#k4>ui=5jBa#~ ,GO^,R=23Y$`#2G%#&	e%,QH=OX?EPh|[@df,(a#9:M0gEs(;?4x_o|x.K[g%!;+_o3C:jE.uY1~I7]"hS?UQ]ywAn &,t_w_N{?:cD\c& KX76BQ1}v(
UQeQ[5h2|y KNY]9|7b`9Sx3gB%!a>k\t1:#x&dgb0LJ0 Z{mLx}4{
(qZ>
kOQ5(Mb/u}"od;!oc?cn\^u^mgcJz.zD;-Xf'LPk5i:&l/6qR,O@IH\+G1aFY{(b&vnvZ_^jdC-=Roej4(Zum3ii-kD)hfZ!KC0f
Z6RD%ajSsZG65?'q/{PtA.pCvoN|pw~loqI E$qCd}}9;R@5,A3S!(zKg)v=,~	6qK8Vl|c8	E.wHPvy)
%68q/hSan W/sfZHMbAD?]d,X1UGZ;]eMtIT[olY~{>C'FF a`=+u&}}?w$M'4q514!+#$_#gWAI>\]?uH2P6V.(4hcGzek.NOu, P}?;CTa><+vAF^EPV
 Td-dl Hm3+|
D"!hYA-N_!(#SG Sy9>1tSVW AM?ff[Q	};(@SZ]	e:$#Np3o)tvcfQ$,i  s$87
u3cdCML7i4o3u. =>
`i3Am[I?-.lgIZvVyn.ZU#(UR"rQ_9wWhQh86m%2M4 d'\;`oCO/W$ik-{}Baxsa<2UCB"d4>:~r[TfIT`9H3,B\3$omnt[%~sw6&4VOtC}YfYD)t .k9b0x${K)absorQ0I]e"SbvZIAC1zP3~lUF$I{cH' l?A>Y-` C4PlOIP#-E"2T'W07o'm8  2[nc	USP0r"fXsQ1"J9WeeHf trn"yRB31E)`inO{T a-#2)h|GNQ>W^OSwWLPQ'<h>+"o]n4\`pVf<'=Cw{8jd~c}W
J	s!X#Y%3uedQq&C^`o=V~&1V"j#eviaR$j+Zm-0%`TNzk ?QJ0D'qj.]d!f5p'eWd[y*< *5T((z!(]C"v:4JMmE25-8\k_%Z@fP*5$%\wX(	Ur,;HA?;9LT&f1iS[P7$v{Hv0LimSU~~f>"x{SL	J7J2`C ecOy)SeupqT$~O*<VwN+6}dl6xm.l$LbPdsacKIa>cy!2y|Tu.i+DieJG#|VUtXfU)2JOKpB-A>!J?:`??	KK.'&|Kd)w,NH_<Cg9l4r^.D|  O;'PlBe.T}/	vpsNP3C#a%M)Pi'953KdCv\}\hA`4h+80RcSWN<07-uu39Z|m0 S%j:2`Q\]}j s(#  XxER>_a\f+I__&P2&. [5	{hT0nbo@\i]f)#z4f
\
z 7y\6*)Mn3 ~V~I2""3"8-dKjX`&6()C]BB"V>P`Roa|/a@~Zlhs	oi'YP%QWkI6FJfoT@/ErjsyT{3?{< vj+4A9j.z LT$Mw<IH@b~)sj5}{1~]G!^ft-)^FzE>6gA>cn6UHgk3x?.AH/Ri1-!ITe gM`eC'NM0TBr`)1(iou2O{PPc?2	Uj8/Y@w($bA\2#6oK0c?yN`r=q$|\       Xn6SpE"i
W10V0td1D<J{=4{,QRe;!~W%s9?
X\zPxvx2?b,D ]
n9 gq*Lw^!Eq4KJ c3r*	bc%$Jc2%2&Dba&$Nj$AI]Q[rH:m\t1@q@.X=BM6tngaocJVT<r5cH:>ar:r*:(|Dt<#~!09r}qq<7u7XdM=5<[hUEb:}s5QdLD>cXoJS0yad}_=VFZHl1HB)!:MIb8lhH",
+ nGCWS>D`y{avnULKR@XqC(+<
qLDQ92E$vJ0KU\9{;)3}6k'aNr3>GZUH	7}=
p^{rn}b&TjuEgCl6)T)	?]PBB]!lQVSj W>V#=0psGhP=-z*Wt$U9?7eF	k|!C"T=- ^e?t235&$~/B10YbwL^te+yJ3z.T0 <BHf:WCYN}PkA9.V1wV_;X]zIxT/AO/9Gu#uQkC6J7&)EuLrr>ofb`AsG(!Y}5JAcp~";[|_4^kHN(H}ba0+#2zW(+kQ!5GCn3oEY;wJ#W@_`<,	KDEI(M!Fj>]`3ic]!AK8rzUljIl0}H]F<My3utCcc+ ^&HK:;a pVs&~?f/w.t\T7<vUzau4H_?       YYs8~@db7e1[[<@$$bL  Os_,}u7K&"_I>O49&L)XB'B)1DH|`q8%w1#:(QHx`2c1%7'cW)#)Xl:D4#Sfb3XglrzysJf<eh@GH%Y .rH.NV;d(!K )l/9#	U2HF`1es ZLiS")mUtH-\+WpT&\yF<"g]lHC[/Q4)5HCh-'xWBk  oeHiiz	<D,/UJWS+O1}zD^dpLU<CHF4J?9tA>PV$'rg6N|*#0>^Flb;6\64['8SMW1QACg,BBn-?}
5{KNo(F,,d((Z9!*Ulisau[U8v~	8`xRE|;?'0+yjqv U6<C JLyg]_CL	,$4RTGZWi5gEM&pzuI+9R%?:=6&?GXD
"rw/kC(*Td82*X9g	x^SUc fJPvX& CuB'9CeX}CyY<7C0*@Ef?bZXER-@J(s+s2A^IBF-XL\Xw2}2Rf\Z3[_$P<^"GpTsH+DXO3P
kp5nGK(Fyy> (>6`k2-R`86W%RzA;}
P|Ks`Mz24u	4zyCTY5.@[Qn7$BII  BcT#B>KyVP {-na+1B bZQ/wuc%wVCC={9f5Ndy].N0Y,Yx9V.nU9$<}wi. oR`vPe XX&P=5vMU]ezuR&8*(oy!]]#=^ KZ@.vsX!GN7Xs%Y*y|JI2`^RpMkr `cH*g\dY-Cb$';$P\<Z=oLBe-m2CF+gB	[ kvu3jr 3t|Tiy$}UvsFcPXNaiGR+UjG5	_1yX3j&	H]d#4{ANYl7Ztp8/f%|NIQ0	}bS|2Ad>\;v5r#o.=JUYnoYeUI>c*oC={9iI4&n>+/DK.>,>erF#VBM_.tX\21HBfrm<-p3E&K	x%f&%Jj/v{k @ aK0v78>O=)A%Y4
2Ju#1-4=fV]ZHP'8^5bKabMEto8ICAH}<#CVF&P.S"1@\JJJwHHu]>4>P<s_3"`,2_AXq-]~f8X|C$:M5g!Z%
</9$"uGMb N.}OJIN1&;fY
p(aT<V.oLk+yig",zsTS>\Ro       mS8{~ns9(YwLKv?t:O$GrdL[YWYva:h<!`s>N 8teSpI0@CtC>a f( HCqzQCp9>xs~wL1qO@'2L4KB%t'`2:dm9,	H&p#0Mq/QzC9]00c8	AE)n p7/JcW~CGr9i@MpJQ18NodbsX0bH4xIaA}u>>2q2*RT1N'0|c,c5y')Z f\qO}*/tt\v
+E`=?#)SM#8rtr2:GsG0  #Y_5[ost1H3;Pf`9e1"GpS+"t\ Jz7C)I|utJ>$$cs@p(_|u0__UbcN:CiNq*,.cXG$E4)8p'cX)5(r\KsnVK"VU]Q>$e"9J>~0GMrDdn1%(w.-`"(@)1,ED2
8H, Aykp/%RO/-3D0lQ^=0Swn	_-
4mZUro.YS!bCPm}Bqsk?zLF&N_#JTCnW0),. 9^B~$4<DDW:[y"inrm8-W`4\,rI	RYJ5U)|zUX2GW0p+	(n4'qhl!IZh"Z`0Xlk"G90*kgi/j\}@tehKTqZ.00{Wt-!Rvn+`o[!(5Kmoev:Z. EgS5>BU(<o7mh;:w k~I4GCB
'+#3DpMt*qgJ|@q qX}gebNx(uSg4	_}}7:E%ih_SX6jSBI-H7Ka3%f0	\l^TPlYm9GS]((8v:m+
RSc-^4n4kQvy9
Q64NZxiC.4O/E		Q9f~U.;2Ax6Uy\nwDH3V {ku!qoHj]>-P;s+h)K[YOl}4e-eteqieUz ,M0|Oz;JF]cI4YyYbe~1/}0xFIM?~QJVoo4ilk9Fy"N1[okVPwq uHz)0[C%;Vd<^v\Yvv pc7 19]<Bo%CE{DjWkW=,j<
lo6\H?ol{uAOgOZ.&g| s	(eO;QyP<^<R# #EMjX*sQ
xh`"if4^\0##kGCgo(>w`tH'AV-	0T
,;K3X<Pf+NLR"EWwb3N/?A5IN2,)5r(AFN|gT'X&]* Uk4^z]I}DY<qY{~9HB.CvG&0q2(/uMF~nXS"*_:!a2Ou'D,&*8yD3[yldD<z(kN|8Z-i[CcR57;;^jDO;FZ$tB1V^EiQxy4
-)dsS$wsK,D+#U\dY"<;foLcJe)"[81lSLDRMrR&wzJI\|4$fDW6'JM#L?2B*7+"FTdGd|
r~^{oM#yyEbl<Si(*t4AP".VacxG-y:3G]xp'ux
V=85a"KEp|>7W7G
PM2'N5}>S<Owr=6+Y(w,qPqM" ^50vz\m[9 ;7EC.#w%RPo{w=qg\\FU^Fb$Fq!uQDzF8XG4#R:Qq89=d  <!-- TODO(calamity): Remove this once manifest URL installs are implemented. -->
<!-- See https://crbug.com/896575 for details -->
<html>
<head>
  <link rel="manifest" href="manifest.json">
</head>
</html>
     Wn8}Wp]4-B]\;I;X,}[,ZKL$Q );nP.v)67K33CrK  \W/_!6BdHZ}XY`S4WzGrXz[R*X
	n%/(#L}>,f(li@ *,8U2y(R1 :*T7WQ.+VeFr>&&@V>w#jjq*`ZmXQ'\5$WkQpQ$BA3B0dZ16[DE^GB6XTo0'dCm>\k]Ui-Ram5I4Qwaa8"k9[*w-Bl:tX9'kZr4[,)$5ho[Oee,F<fU@glH0@s2)_z3otXJ4$,MfD7n'3b@d|!iO(VhayC6e\$s\"k&@]OnHQi ^!8_{P&.6fdYO-\:Ze-I|_u${CY|{um}VVqz;{eC>YUo
/pg9jT9
ErtR,dy*?	{6%2Pm(	GH<.f
TX#x4	Nf
1bg\0r= ugI}&e`;O'`Xa_0YJ]YCc:E)D6):W*K#6	s]OgN?(ql+.D4un:[ca4ucKo5 #570{tn +^K%0LW,c~w;	Z*Tt4T\o"hF[o;       uR]O0}8FmiBJ0\x$vgu}vhaH(9
Lz]\7i]g'=7'm).
	&;!oIclxZF7RzaliDQ	"q~\*o~Hklkx
:6JkUY**6#<];uU"]9.[bf?965i
/9*(Wk(tO-h< N)pl>*av~Z4mlN{X"'S6JR&M`L>Sq>8}'vOP?8sRF/g=j       RF_}+4{x B'$&}dY:7Zuwf$lhg|r%WgkZq!W)Hp F)$DG@"%AL[M4U(IfdR,&4C8gg$)@|!9x>yIE!w!'kcrD6(,\k	 uBhB<LaPAgagY9A3PM3o4e-XKE*iVtbFg'?8grC~%aA
:r`TE4t#(EVrswaJP2bq)Q<#uy|Txfq
wPrsp-< byR+n<k
ip{W' L25ou9=e~U<V?*VdWU5%nyozZ6	Hw:87AVJIZ" S{tp[?eE*As|8ldHUxJ/dd+U~eP*_cOKb%6*OTEz@ax^x#s/a$g:AvtbqPO*hg.Z/vWG[J?^,aKn\{LrlX\OjEt8#=qJUWK;1 8QTSu2 CT}Y~o 8M55l!88D@g7=_z	gr6Luy\K5|Y!.N;T$UHn_qOXB|V_^U,Vh{dt'5c18$8eUcX.4rZ),1g7W -/^ vZKjc\O?]Au"6TF+k=T!Y!nEFs~LifPyZ Zm:^f50F\!r2mrKapWGaun9R#|\B|"uMZ_AGa&JlS=]w[y|d7=
U{_r+ez=];B=ztaMku{5 'mYd11*&N.Yi<2B*\o;8uv%nzrc!}(  6
MouseEventCount#  ?  HA LD XE ME NFG*
KeyEventCount   ?  A xC D E;
NavigationEntryCount#  @  @  @  HA  A  A  FB\
MRUIndexP  ?   @  @  A  A  A  B  B C C xC @C @C C @C D
TouchEventCount
   @ 4F7
NumReactivationBefore   ?  ?  `@  @  A  A!
TopDomain_1080024851943145123M#
TopDomain_15689501676488870256"
TopDomain_15061790812729663598~#
TopDomain_17805263144043282746"
TopDomain_15183327860286992060
MouseEventCount_6#
TopDomain_17609869936025638318
Type_1"
TopDomain_10119661862724640164G

MRUIndex_9"
TopDomain_3206887100623121722"
TopDomain_10043033701369158400E!
TopDomain_959275671374652467 
TopDomain_87712541284966463"
TopDomain_1572676409482578135

MRUIndex_8"
TopDomain_2684509497774788840"
TopDomain_3871863902853417076"
TopDomain_13201593719927070652k
IsPinned#
TopDomain_17665177956735407683#
TopDomain_15894589896585942567"
TopDomain_11085224173626070834S
SiteEngagementScore_70B!
TopDomain_1388128116188258854t
NumReactivationBefore_6/#
TopDomain_15460036257622057721"
TopDomain_5161051873882288304"
TopDomain_7427709185199481811"
TopDomain_13012715934034554483h
TouchEventCount_1"
TopDomain_2064774450264892649
SiteEngagementScore_0:#
TopDomain_15847248848374708081
NavigationEntryCount_0 #
TopDomain_17348514064360434852#
TopDomain_15288598938443330327#
TopDomain_17454475692079618781"
TopDomain_4498139696238849296"
TopDomain_9594404622941547504"
TopDomain_9204579900384785527"
TopDomain_12525798276078776067f#
TopDomain_15655412894497687330"
TopDomain_9685155330727019174"
TopDomain_11018654186523614761Q"
TopDomain_6035613466181606704
NavigationEntryCount_2"#
TopDomain_17796737512117080128"
TopDomain_6045732738424972004"
TopDomain_11227683057626966116V
NumReactivationBefore_0)
TopDomain_11632560942001414[
SiteEngagementScore_50@"
TopDomain_5941799794948841680"
TopDomain_5841942723928569023!
TopDomain_196963497794912993
MouseEventCount_2"
TopDomain_2851264494900985422
PageTransitionIsRedirect5!
TopDomain_843676498139257074"
TopDomain_4294201111699280567"
TopDomain_9606618426864857338!
TopDomain_1153398345655265072Z"
TopDomain_10895494351168426693N"
TopDomain_10169506825395800337H"
TopDomain_13235606415688235361n"
TopDomain_7449205003113069198"
TopDomain_12138507100907984281c"
TopDomain_12128704406167545479b
NumReactivationBefore_1*"
TopDomain_4369365699833920337#
TopDomain_18429447622638145680
SiteEngagementScore_30>"
TopDomain_4804837807085259619
ShowState_16!
TopDomain_698916636646710575"
TopDomain_11164683519288964730U

MRUIndex_2#
TopDomain_17580878206960980545"
TopDomain_6935756648522340603
SiteEngagementScore_60A"
TopDomain_14596851351072705470y"
TopDomain_10921456545786979211P
NumReactivationBefore_3,"
TopDomain_1804284032727006986"
TopDomain_5203230528484920842"
TopDomain_12335924279508075969d
KeyEventCount_0
KeyEventCount_4#
TopDomain_15741269190621693221
WasRecentlyAudible
NavigationEntryCount_7'"
TopDomain_6508721319432249974!
TopDomain_236703431990620330#
TopDomain_17390321984555611993"
TopDomain_2957965146093936771"
TopDomain_8632220210146641000"
TopDomain_13208729640320280584l"
TopDomain_12386390640692202738e#
TopDomain_17811530796309643159#
TopDomain_16768701066384376478"
TopDomain_6163045271141768870"
TopDomain_2672907030994913228"
TopDomain_13115516086556974343j!
TopDomain_878847704185202492"
TopDomain_7088684986110897678"
TopDomain_4009933873399061218!
TopDomain_341490971205980837
MouseEventCount_1"
TopDomain_4764263413547323863"
TopDomain_2440596079597823666"
TopDomain_8555518466344315990"
TopDomain_8316249495056507568#
TopDomain_15966429509789767021!
TopDomain_1448229354234554080x#
TopDomain_16366079186907057253
NavigationEntryCount_3##
TopDomain_18378977400083720013"
TopDomain_8501429689397503793"
TopDomain_6337103823310205182
PageTransitionCoreType_21"
TopDomain_10187093199053808570I
KeyEventCount_3
MRUIndex_15"
TopDomain_5338723781413972714"
TopDomain_4760987115333628632
NavigationEntryCount_5%"
TopDomain_8144375594159422697#
TopDomain_15262276248633613016#
TopDomain_18300295044313409868"
TopDomain_5160451677974969231"
TopDomain_9664280485523735114!
TopDomain_1368146020981450700p!
TopDomain_876199788100362630
KeyEventCount_5	
MouseEventCount_3"
TopDomain_2968749863868578542"
TopDomain_8723982126215208982"
TopDomain_14157691472982757617u

MRUIndex_5"
TopDomain_7304754882072794192!
TopDomain_324364537650936070
MouseEventCount_5#
TopDomain_15387739340581110685"
TopDomain_3860317998083780863"
TopDomain_7350763718700977478#
TopDomain_17318491964161906161"
TopDomain_7063227438872759949"
TopDomain_1946495666138444138
SiteEngagementScore_10;#
TopDomain_15819600267779402594
PageTransitionCoreType_83
HasBeforeUnloadHandler "
TopDomain_10758121499324064194L
ShowState_27"
TopDomain_13717026609825930643q
MouseEventCount_7"
TopDomain_9605309396967163933
NumReactivationBefore_4- 
TopDomain_33819408664442396

MRUIndex_7"
TopDomain_7049109217806271285"
TopDomain_13473667061284296256o"
TopDomain_8256838480345576948
MRUIndex_12"
TopDomain_11281394909307332136X"
TopDomain_9646924245674468055"
TopDomain_13771742413608550493r
SiteEngagementScore_80C"
TopDomain_14625437354194983248z
NavigationEntryCount_6&"
TopDomain_13834769092094238000s
SiteEngagementScore_40?
NumReactivationBefore_2+"
TopDomain_12558476351114645767g#
TopDomain_16812564669986576421

MRUIndex_3"
TopDomain_11912199775964982622_
MRUIndex_10
MouseEventCount_0#
TopDomain_16079275975660711115#
TopDomain_17705640974703232252
TouchEventCount_2
MouseEventCount_4"
TopDomain_10740419527460090491K#
TopDomain_17999381730064795300#
TopDomain_16369899265487396589
IsActive#
TopDomain_16341703993826111523
SiteEngagementScore_20=#
TopDomain_18245469667301336119#
TopDomain_15921862757681270712"
TopDomain_11738965776604256531\"
TopDomain_8720606896994407571"
TopDomain_11389434805263954430Y!
TopDomain_1304085646556006376i"
TopDomain_15005136786217271573|"
TopDomain_1874056532838985632#
TopDomain_17950719759682742338"
TopDomain_7114699737129879665#
TopDomain_18337490325837093757"
TopDomain_8079398500111676442"
TopDomain_9499668011696157315"
TopDomain_14233941029653936165v#
TopDomain_17251037843225226770"
TopDomain_10901531562134450126O

MRUIndex_0
"
TopDomain_8429031694230093054#
TopDomain_17093041278158597643

MRUIndex_4"
TopDomain_9791677860763157788"
TopDomain_8494204192682713966"
TopDomain_10072413688749279773F#
TopDomain_16437285489292541054
NormalizedMRUIndex("
TopDomain_9020261517444911033
KeyEventCount_2#
TopDomain_15870042273117884100#
TopDomain_17045289118324886784!
TopDomain_510821771540594083"
TopDomain_15045547456553872263} 
PageTransitionFromAddressBar4
KeyEventCount_1!
TopDomain_1035925084514834068J"
TopDomain_3110799877618283806
ShowState_38!
TopDomain_651058769554286351
NavigationEntryCount_1!#
TopDomain_16751120787332825022#
TopDomain_16199790386872945279
HasFormEntry
MRUIndex_16"
TopDomain_5436730130443146323"
TopDomain_11954853327857560706`
TouchEventCount_0"
TopDomain_11796274831969683171]#
TopDomain_17631324395650738667!
TopDomain_752537756789258043
Type_2
PageTransitionCoreType_72
NumReactivationBefore_5.
ShowState_49
SiteEngagementScore_90D
PageTransitionCoreType_00
NavigationEntryCount_4$

MRUIndex_6"
TopDomain_2345074716881772422"
TopDomain_3177707200991458183#
TopDomain_16411198922429453306"
TopDomain_2495968728959269770"
TopDomain_12094168201145311450a"
TopDomain_2928222190293398513"
TopDomain_11873006736009776549^"
TopDomain_8944327742448415689"
TopDomain_5352397048417326769"
TopDomain_14986263851399781883{"
TopDomain_14429980498988674617w"
TopDomain_1621665845362371393"
TopDomain_9195558766026703544"
TopDomain_5011259669684447045"
TopDomain_11082551044701230453R"
TopDomain_3968615742235786342!
TopDomain_726059442646517786"
TopDomain_13216356480294047299m#
TopDomain_15487345791713004722#
TopDomain_15516523711153697558"
TopDomain_11279037034026214503W"
TopDomain_2023368772508865927

MRUIndex_1#
TopDomain_17349310390648753489
SiteEngagementScore_100<"
TopDomain_7746553357405203507"
TopDomain_11149338271801532545T#
TopDomain_15449547182571591448"
TopDomain_2311961509270792991*Type*PageTransitionCoreType*SiteEngagementScore*	ShowState<!doctype html>
<html dir="$i18n{textdirection}"
      hascustombackground="$i18n{hasCustomBackground}"
      bookmarkbarattached="$i18n{bookmarkbarattached}"
      lang="$i18n{language}"
      class="md">
<head>
<meta charset="utf-8">
<title>$i18n{title}</title>
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="chrome://resources/css/text_defaults_md.css">
<style>/* Copyright 2017 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

body {
  -webkit-font-smoothing: antialiased;
  font-size: 100%;
  margin: 0;
}

/** Typography -------------------------------------------------------------- */

.content {
  /* This is identical to the default background color. It's necessary to set it
     for the case when a theme with a background image is installed. */
  background-color: rgb(50, 54, 57);
  color: rgb(189, 193, 198);
  font-size: calc(100% - 2px);
  line-height: calc(100% + 6px);
  min-width: 240px;
}

h1 {
  color: rgb(218, 220, 224);
  font-size: calc(100% + 8px);
  font-weight: 400;
  line-height: calc(100% + 8px);
}

em {
  color: white;
  font-style: normal;
}

.learn-more-button {
  color: rgb(138, 180, 248);
  text-decoration: none;
}

/* Small font on small screens. */
@media (max-width: 240px),
       (max-height: 320px) {
  .content {
    font-size: calc(100% - 4px);
    line-height: calc(100% + 6px);
  }

  h1 {
    font-size: calc(100% + 4px);
    line-height: calc(100% + 4px);
  }
}

/** Icon -------------------------------------------------------------------- */

.icon {
  content: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNDAgMjQwIj48ZyBvcGFjaXR5PSIuOCIgZmlsbD0iI0ZGRiI+PHBhdGggZD0iTTEyMSAwQzUzLjktLjYtLjYgNTMuOSAwIDEyMWMuNiA2NS4yIDUzLjggMTE4LjQgMTE5IDExOSA2Ny4xLjYgMTIxLjYtNTMuOSAxMjEtMTIxQzIzOS40IDUzLjggMTg2LjIuNiAxMjEgMHpNOTAuNSA1OWMuMy0uOSAxLTEuNSAyLjItMS4yIDIuMi41IDE5LjkgNC4zIDE5LjkgNC4zczM2LjgtNS42IDM4LjEtNS45YzEuMS0uMiAxLjkuNCAyLjEgMS40LjEuNCA2LjMgMjEuMyAxMS43IDM5LjVINzguM0M4My45IDc5LjYgOTAuMSA2MCA5MC41IDU5em04NS45IDEwMy4zYy0uOCAxMi4yLTEwLjcgMjIuMS0yMi45IDIyLjktMTQuMy45LTI2LjEtMTAuNC0yNi4xLTI0LjUgMC0uNyAwLTEuNC4xLTIuMS0yLS43LTQuMi0xLTYuNC0xLTIuMyAwLTQuNS40LTYuNyAxLjEuMS43LjEgMS4zLjEgMiAwIDE0LjEtMTEuOCAyNS40LTI2LjEgMjQuNS0xMi4yLS44LTIyLjEtMTAuNy0yMi45LTIyLjktLjgtMTQuMiAxMC41LTI2LjEgMjQuNS0yNi4xIDEwLjIgMCAxOSA2LjMgMjIuNyAxNS4yIDIuNy0uOCA1LjUtMS4zIDguNC0xLjMgMi44IDAgNS41LjQgOC4xIDEuMiAzLjctOC45IDEyLjQtMTUuMSAyMi43LTE1LjEgMTQuMSAwIDI1LjQgMTEuOSAyNC41IDI2LjF6bTIzLjQtMzQuM0g0Mi40Yy0uMiAwLS4zLS4zLS4xLS40IDUuMi0yLjcgMzUuNC0xNy42IDc5LTE3LjYgNDMuNyAwIDczLjUgMTQuOCA3OC42IDE3LjYuMi4xLjEuNC0uMS40eiIvPjxjaXJjbGUgY3g9IjE1MS45IiBjeT0iMTYwLjgiIHI9IjE3LjQiLz48Y2lyY2xlIGN4PSI5MC4xIiBjeT0iMTYwLjgiIHI9IjE3LjQiLz48L2c+PC9zdmc+);
  height: 120px;
  width: 120px;
}

/* Medium-sized icon on medium-sized screens. */
@media (max-height: 480px),
       (max-width: 720px) {
  .icon {
    height: 72px;
    width: 72px;
  }
}

/* Very small icon on very small screens. */
@media (max-width: 720px) {
  @media (max-width: 240px),
         (max-height: 480px) {
    .icon {
      height: 48px;
      width: 48px;
    }
  }
}

/** The "Learn more" link --------------------------------------------------- */

/* By default, we only show the inline "Learn more" link. */
.content > .learn-more-button {
  display: none;
}

/* On narrow screens, we show the standalone "Learn more" link. */
@media (max-width: 720px) {
  #subtitle > .learn-more-button {
    display: none;
  }

  .content > .learn-more-button {
    display: block;
  }
}

/** Layout ------------------------------------------------------------------ */

/* Align the content, icon, and title to to the center. */
.content {
  margin-left: auto;
  margin-right: auto;
  max-width: 600px;
}

.icon {
  margin-left: auto;
  margin-right: auto;
}

h1 {
  text-align: center;
}

/* Align the two columns of bulletpoints next to each other. */
.bulletpoints {
  float: left;
}

html[dir=rtl] .bulletpoints {
  float: right;
}

.bulletpoints + .bulletpoints {
  clear: right;
}

html[dir=rtl] .bulletpoints + .bulletpoints {
  clear: left;
}

.clearer {
  clear: both;
}

/* On narrow screens, align everything to the left. */
@media (max-width: 720px) {
  .content {
    max-width: 600px !important;  /* must override the rule set by JS which
                                   * is only valid for width > 720px cases. */
    text-align: start;
  }

  .icon {
    margin-inline-start: 0;
  }

  h1 {
    text-align: start;
  }

  .bulletpoints + .bulletpoints,
  html[dir=rtl] .bulletpoints + .bulletpoints {
    clear: both;
  }
}

/** Paddings and margins ---------------------------------------------------- */

.bulletpoints ul {
  margin: 4px 0 0;
  padding-inline-start: 16px;
}

/* Margins of floating elements don't collapse. The margin for bulletpoints
 * will usually be provided by a neighboring element. */
.bulletpoints {
  margin: 0;
}

.bulletpoints + .bulletpoints {
  margin-inline-start: 40px;
}

.bulletpoints + .bulletpoints.too-wide {
  margin-inline-start: 0;
  margin-top: 1.5rem;
}

/* Wide screens. */
@media (min-width: 720px) {
  .icon,
  h1,
  #subtitle,
  .learn-more-button {
    margin-bottom: 1.5rem;
    margin-top: 1.5rem;
  }

  .content {
    margin-top: 40px;
    min-width: 240px;
    padding: 8px 48px 24px;
  }

  /* Snap the content box to the whole height on short screens. */
  @media (max-height: 480px) {
    html,
    body,
    .content {
      height: 100%;
    }

    .content {
      margin-bottom: 0;
      margin-top: 0;
      padding-bottom: 0;
      padding-top: 0;
    }

    .icon {
      margin-top: 0;
      padding-top: 32px;  /* Define the top offset through the icon's padding,
                           * otherwise the screen height would be 100% + 32px */
    }
  }

  /* Smaller vertical margins on very short screens. */
  @media (max-height: 320px) {
    h1,
    #subtitle,
    .learn-more-button {
      margin-bottom: 16px;
      margin-top: 16px;
    }

    .icon {
      margin-bottom: 16px;
    }
  }
}

/* Narrow screens */
@media (max-width: 720px) {
  .content {
    padding: 72px 32px;
    min-width: 176px;
  }

  .icon,
  h1,
  #subtitle,
  .learn-more-button {
    margin-bottom: 1.5rem;
    margin-top: 1.5rem;
  }

  /* The two columns of bulletpoints are moved under each other. */
  .bulletpoints + .bulletpoints {
    margin-inline-start: 0;
    margin-top: 1.5rem;
  }

  /* Smaller offsets on smaller screens. */
  @media (max-height: 600px) {
    .content {
      padding-top: 48px;
    }

    .icon,
    h1,
    #subtitle,
    .learn-more-button {
      margin-bottom: 1rem;
      margin-top: 1rem;
    }

    .bulletpoints + .bulletpoints {
      margin-top: 1rem;
    }
  }

  /* Small top offset on very small screens. */
  @media (max-height: 480px) {
    .content {
      padding-top: 32px;
    }
  }

  /* Undo the first and last elements margins. */
  .icon {
    margin-top: 0;
  }

  .learn-more-button {
    margin-bottom: 0;
  }
}

/* Very narrow screens. */
@media (max-width: 240px) {
  .content {
    min-width: 192px;
    padding-left: 24px;
    padding-right: 24px;
  }
}
</style>
<script>
// Until themes can clear the cache, force-reload the theme stylesheet.
document.write('<link id="incognitothemecss" rel="stylesheet" ' +
               'href="chrome://theme/css/incognito_new_tab_theme.css?' +
               Date.now() + '">');
</script>
</head>
<body>
<div class="content">
  <div class="icon" role="presentation" alt=""></div>
  <h1>$i18n{incognitoTabHeading}</h1>
  <p id="subtitle">
    <span>$i18n{incognitoTabDescription}</span>
    <a class="learn-more-button"
        href="$i18n{learnMoreLink}">$i18n{learnMore}</a>
  </p>
  <div>
    <div class="bulletpoints">$i18nRaw{incognitoTabFeatures}</div>
    <div class="bulletpoints">$i18nRaw{incognitoTabWarning}</div>
    <div class="clearer"></div>
  </div>
  <a class="learn-more-button" href="$i18n{learnMoreLink}">$i18n{learnMore}</a>
</div>
<script src="chrome://resources/js/cr.js"></script>
<script src="chrome://resources/js/util.js"></script>
<script>// Copyright 2017 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// Let the width of two lists of bulletpoints in a horizontal alignment
// determine the maximum content width.
function recomputeLayoutWidth() {
  const bulletpoints = document.querySelectorAll('.bulletpoints');
  const content = document.querySelector('.content');

  // Unless this is the first load of the Incognito NTP in this session and
  // with this font size, we already have the maximum content width determined.
  const fontSize = window.getComputedStyle(document.body).fontSize;
  let maxWidth = localStorage[fontSize] ||
      (bulletpoints[0].offsetWidth + bulletpoints[1].offsetWidth +
       40 /* margin */ + 2 /* offsetWidths may be rounded down */);

  // Save the data for quicker access when the NTP is reloaded. Note that since
  // we're in the Incognito mode, the local storage is ephemeral and the data
  // will be discarded when the session ends.
  localStorage[fontSize] = maxWidth;

  // Limit the maximum width to 600px. That might force the two lists
  // of bulletpoints under each other, in which case we must swap the left
  // and right margin.
  const MAX_ALLOWED_WIDTH = 600;
  const tooWide = maxWidth > MAX_ALLOWED_WIDTH;
  bulletpoints[1].classList.toggle('too-wide', tooWide);
  if (tooWide) {
    maxWidth = MAX_ALLOWED_WIDTH;
  }

  content.style.maxWidth = maxWidth + 'px';
}

window.addEventListener('load', recomputeLayoutWidth);

// Handle the bookmark bar, theme, and font size change requests
// from the C++ side.
const ntp = {
  /** @param {string} attached */
  setBookmarkBarAttached: function(attached) {
    document.documentElement.setAttribute('bookmarkbarattached', attached);
  },

  /** @param {!{hasCustomBackground: boolean}} themeData */
  themeChanged: function(themeData) {
    document.documentElement.setAttribute(
        'hascustombackground', themeData.hasCustomBackground);
    $('incognitothemecss').href =
        'chrome://theme/css/incognito_new_tab_theme.css?' + Date.now();
  },

  defaultFontSizeChanged: function() {
    setTimeout(recomputeLayoutWidth, 100);
  }
};
</script>
</body>
</html>
<!doctype html>
<html dir="$i18n{textdirection}" lang="$i18n{language}">
<head>
<meta charset="utf-8">
<title>$i18n{title}</title>
<link rel="stylesheet" href="chrome://resources/css/text_defaults_md.css">
<style>/* Copyright 2014 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file.
 *
 * Incognito and guest mode NTP shared CSS. */

body {
  -webkit-font-smoothing: antialiased;
  font-size: 85%;
}

h1 {
  font-size: 200%;
  font-weight: 400;
  margin-bottom: .77em;
}

p {
  line-height: 1.5;
  margin: .588em 0;
  text-align: start;
}

a {
  color: rgb(51, 103, 214);
}

a:hover {
  text-decoration: underline;
}

/* 'Learn More' button styled like a Material Design text button.
 * TODO(edwardjung): Switch styled links to actual text buttons. */
.learn-more-button {
  color: rgb(66, 133, 244);
  display: inline-block;
  font-size: 92.8%;
  font-weight: 500;
  margin-top: 1.98em;
  padding: 10.5px 12px;
  text-decoration: none;
  text-transform: uppercase;
}

.content {
  box-sizing: border-box;
  margin: 3.5em auto 0;
  max-width: 480px;
  min-width: 240px;
  padding: 30px 35px;
  text-align: center;
}

html[hascustombackground='true'] .content {
  border-radius: 2px;
  box-shadow: 0 4px 6px 1px rgba(0, 0, 0, 0.4);
}

.content > span {
  display: block;
}

@media (max-width:700px) {
  body {
    margin: 1em 2em 2em;
  }
}

@media (max-width:400px) {
  body {
    margin: 3em 1.5em 2em;
  }

  /* Adjustment for narrow screen to prevent horizontal scrollbar. */
  .content {
    padding: 16px 8px;
  }
}

@media (max-height:480px) and (max-width:400px) {
  .content {
    margin: auto;
  }
}
</style>
</head>
<body>
<div class="content">
  <h1>$i18n{guestTabHeading}</h1>
  <p>$i18n{guestTabDescription}</p>
  <a class="learn-more-button" href="$i18n{learnMoreLink}">$i18n{learnMore}</a>
</div>
</body>
</html>
/* Copyright 2013 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

html {
  background-attachment: fixed;
  background-color: $i18n{colorBackground};
  background-position: $i18n{backgroundBarDetached};
  background-repeat: $i18n{backgroundTiling};
  height: 100%;
  overflow: auto;
}

html[hascustombackground='true'] {
  background-image: url(chrome://theme/IDR_THEME_NTP_BACKGROUND?$i18n{themeId});
}

html[bookmarkbarattached='true'] {
  background-position: $i18n{backgroundBarAttached};
}

#attribution-img {
  content: url(chrome://theme/IDR_THEME_NTP_ATTRIBUTION?$i18n{themeId});
}
<!doctype html>
<html class="starting-up" dir="$i18n{textdirection}"
    bookmarkbarattached="$i18n{bookmarkbarattached}" lang="$i18n{language}">
<head>
<meta charset="utf-8">
<title>$i18n{title}</title>
<!-- Don't scale the viewport in either portrait or landscape mode.
     Note that this means apps will be reflowed when rotated (like iPad).
     If we wanted to maintain position we could remove 'maximum-scale' so
     that we'd zoom out in portrait mode, but then there would be a bunch
     of unusable space at the bottom.
-->
<meta name="viewport"
      content="user-scalable=no, width=device-width, maximum-scale=1.0">

<!-- It's important that this be the first script loaded. -->
<script>// Copyright (c) 2012 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

/**
 * @fileoverview
 * Logging info for benchmarking purposes. Should be the first js file included.
 */

/* Stack of events that has been logged. */
const eventLog = [];

/**
 * Logs an event.
 * @param {string} name The name of the event (can be any string).
 * @param {boolean=} opt_shouldLogTime If true, the event is used for
 *     benchmarking and the time is logged. Otherwise, just push the event on
 *     the event stack.
 */
function logEvent(name, opt_shouldLogTime) {
  if (opt_shouldLogTime) {
    chrome.send('metricsHandler:logEventTime', [name]);
  }
  eventLog.push([name, Date.now()]);
}

logEvent('Tab.NewTabScriptStart', true);
window.addEventListener('load', function(e) {
  logEvent('Tab.NewTabOnload', true);
});
document.addEventListener('DOMContentLoaded', function(e) {
  logEvent('Tab.NewTabDOMContentLoaded', true);
});
</script>

<link rel="stylesheet" href="chrome://resources/css/text_defaults.css">
<style>/* Copyright (c) 2012 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

.bubble {
  position: absolute;
  white-space: normal;
  /* Height is dynamic, width fixed. */
  width: 300px;
  z-index: 9999;
}

.bubble-content {
  color: black;
  line-height: 150%;
  margin: 1px;
  padding: 8px 11px 12px;
  position: relative;
  z-index: 3;
}

/* When the close button is there, we need more padding on the right of the
 * bubble. */
.bubble-close:not([hidden]) ~ .bubble-content {
  padding-inline-end: 22px;
}

.bubble-close {
  height: 16px;
  position: absolute;
  right: 6px;
  top: 6px;
  width: 16px;
  z-index: 4;
}

html[dir='rtl'] .bubble-close {
  left: 6px;
  right: auto;
}

.bubble-close {
  background-image: -webkit-image-set(
      url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAiElEQVR42r2RsQrDMAxEBRdl8SDcX8lQPGg1GBI6lvz/h7QyRRXV0qUULwfvwZ1tenw5PxToRPWMC52eA9+WDnlh3HFQ/xBQl86NFYJqeGflkiogrOvVlIFhqURFVho3x1moGAa3deMs+LS30CAhBN5nNxeT5hbJ1zwmji2k+aF6NENIPf/hs54f0sZFUVAMigAAAABJRU5ErkJggg==) 1x);
}

.bubble-close:hover {
  background-image: -webkit-image-set(
      url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAqUlEQVR4XqWRMQqEMBBF/1E8Ra6x6V3FRnS9QbCxtJg6Z7CzE9lTiIXXyUb3C8EULixDIMM8Zt4kcDfxM5A45U+cgeXnC1tREgkzAgob3hiq3CUHvGLG4FTQoSgxQGDrzN8WTLBGnx2IVDksen9GH7Z9hA5E6uxABMJyCHDMCEGHzugLQPPlBCBNGq+5YtpnGw1Bv+te15ypljTpVzdak5Opy+z+qf//zQ+Lg+07ay5KsgAAAABJRU5ErkJggg==) 1x);
}

.bubble-close:active {
  background-image: -webkit-image-set(
      url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAQklEQVR4AWP4TwBSTQGDHcMZIIYAKA9VwRkwtINJgyCaCTAlCBaKAoQ+hFmoCqBKENKkK8C0gpAjCXuTyICiQ2QBAPSwyG3ByZlCAAAAAElFTkSuQmCC) 1x);
}

.bubble-shadow {
  bottom: 0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
  z-index: 1;
}

.bubble-arrow {
  box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.15);
  height: 15px;
  position: absolute;
  transform: rotate(45deg);
  width: 15px;
  z-index: 2;
}

.bubble-content,
.bubble-arrow {
  background: white;
}

.bubble-shadow,
.bubble-arrow {
  border: 1px solid rgba(0, 0, 0, 0.3);
}

.bubble-shadow,
.bubble-content {
  border-radius: 6px;
  box-sizing: border-box;
}

.auto-close-bubble {
  position: fixed;
}
</style>
<style>/* Copyright (c) 2012 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

.expandable-bubble {
  -webkit-border-image: url(chrome://theme/IDR_APP_NOTIFICATION_SMALL_BUBBLE)
                        5 5 7 6 stretch;
  -webkit-box-sizing: border-box;
  border-width: 5px 5px 7px 6px;
  color: #444;
  cursor: pointer;
  display: inline-block;
  font-size: 12px;
  position: absolute;
  user-select: none;
  z-index: 1;
}

.expandable-bubble::after {
  bottom: -1px;
  content: url(chrome://theme/IDR_APP_NOTIFICATION_NUB);
  display: block;
  height: 7px;
  position: absolute;
  right: 5px;  /* TODO(finnur): Need to handle RTL properly. */
  width: 9px;
}

.expandable-bubble > .expandable-bubble-contents > .expandable-bubble-title {
  display: inline-block;
  margin-left: 1px;
  margin-top : -3px;
  overflow: hidden;
  white-space: nowrap;
}

.expandable-bubble[masked] > .expandable-bubble-contents >
    .expandable-bubble-title::after {
  content: url(chrome://theme/IDR_APP_NOTIFICATION_NUB_MASK);
  display: block;
  height: 15px;
  overflow: hidden;
  position: absolute;
  right: 0;
  top: 0;
  width: 12px;
}

.expandable-bubble[expanded] > .expandable-bubble-contents >
    .expandable-bubble-title {
  font-size: 13px;
  margin-bottom: 3px;
  margin-left: 0;
}

.expandable-bubble-close {
  height: 16px;
  position: absolute;
  right: 0;
  top: 0;
  width: 16px;
  z-index: 2;
}

.expandable-bubble[expanded] {
  padding: 3px;
  z-index: 3;  /* One higher then the close button on an unexpanded bubble. */
}

.expandable-bubble[expanded] > .expandable-bubble-close {
  z-index: 4;
}

.expandable-bubble-close {
  background-image: -webkit-image-set(
      url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAiElEQVR42r2RsQrDMAxEBRdl8SDcX8lQPGg1GBI6lvz/h7QyRRXV0qUULwfvwZ1tenw5PxToRPWMC52eA9+WDnlh3HFQ/xBQl86NFYJqeGflkiogrOvVlIFhqURFVho3x1moGAa3deMs+LS30CAhBN5nNxeT5hbJ1zwmji2k+aF6NENIPf/hs54f0sZFUVAMigAAAABJRU5ErkJggg==) 1x);
}

.expandable-bubble-close:hover {
  background-image: -webkit-image-set(
      url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAqUlEQVR4XqWRMQqEMBBF/1E8Ra6x6V3FRnS9QbCxtJg6Z7CzE9lTiIXXyUb3C8EULixDIMM8Zt4kcDfxM5A45U+cgeXnC1tREgkzAgob3hiq3CUHvGLG4FTQoSgxQGDrzN8WTLBGnx2IVDksen9GH7Z9hA5E6uxABMJyCHDMCEGHzugLQPPlBCBNGq+5YtpnGw1Bv+te15ypljTpVzdak5Opy+z+qf//zQ+Lg+07ay5KsgAAAABJRU5ErkJggg==) 1x);
}

.expandable-bubble-close:active {
  background-image: -webkit-image-set(
      url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAQklEQVR4AWP4TwBSTQGDHcMZIIYAKA9VwRkwtINJgyCaCTAlCBaKAoQ+hFmoCqBKENKkK8C0gpAjCXuTyICiQ2QBAPSwyG3ByZlCAAAAAElFTkSuQmCC) 1x);
}
</style>
<style>/* Copyright (c) 2012 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

cr-menu {
  -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, .50);
  background: white;
  border-radius: 2px;
  color: black;
  cursor: default;
  left: 0;
  margin: 0;
  outline: 1px solid rgba(0, 0, 0, 0.2);
  padding: 8px 0;
  position: fixed;
  white-space: nowrap;
  z-index: 3;
}

cr-menu:not(.decorated) {
  display: none;
}

cr-menu > * {
  box-sizing: border-box;
  display: block;
  margin: 0;
  text-align: start;
  width: 100%;
}

cr-menu > :not(hr) {
  -webkit-appearance: none;
  background: transparent;
  border: 0;
  color: black;
  font: inherit;
  line-height: 18px;
  outline: none;
  overflow: hidden;
  padding: 0 19px;
  text-overflow: ellipsis;
}

cr-menu > hr {
  background: -webkit-linear-gradient(left,
                                      rgba(0, 0, 0, .10),
                                      rgba(0, 0, 0, .02) 96%);
  border: 0;
  height: 1px;
  margin: 8px 0;
}

cr-menu > [disabled] {
  color: rgba(0, 0, 0, .3);
}

cr-menu > [hidden] {
  display: none;
}

cr-menu > :not(hr):-webkit-any([selected], :active) {
  background-color: rgba(0, 0, 0, .06);
}

cr-menu > [checked]::before {
  content: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAQAAABKmM6bAAAAPUlEQVR4AWNAA8YMgugC7xiUGICixkgC/0FCSkCGMVzgHUijEphRDhGA6BAEc/5DBRBmIAQQgneRBP5jQAAe7CCchpa/PQAAAABJRU5ErkJggg==);
  display: inline-block;
  height: 9px;
  margin: 0 5px;
  width: 9px;
}

cr-menu > [checked] {
  padding-inline-start: 0;
}

cr-menu > [selected][checked]:active::before {
  content: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAQAAABKmM6bAAAAQklEQVR4Xl3LQQ0AIAwDwFmYBSxMHGqxgIVSmjSEpZ/ulgb+FLLDxggkywNcGixlICZJZQr05FAHDCRPDCLhEph6DuGWaFS/FhbPAAAAAElFTkSuQmCC);
}

/* TODO(zvorygin) menu > [shortcutText]::after - this selector is much better,
 * but it's buggy in current webkit revision, so I have to use [showShortcuts].
 */
cr-menu[showShortcuts] > ::after {
  color: #999;
  content: attr(shortcutText);
  float: right;
  padding-inline-start: 30px;
}
</style>
<style>/* Copyright (c) 2012 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

/* NOTE: If you are using the drop-down style, you must first call
 * MenuButton.createDropDownArrows() to initialize the CSS canvases that
 * contain the arrow images. */

button.menu-button.drop-down {
  background: white url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9IiNjMGMzYzYiIHdpZHRoPSI2IiBoZWlnaHQ9IjMiIHZpZXdib3g9IjAgMCA2IDMiPgogIDxwYXRoIGQ9Ik0wIDAgTDYgMCBMMyAzIiB3aWR0aD0iNiIgaGVpZ2h0PSIzIi8+Cjwvc3ZnPgo=) no-repeat center 4px;
  border: 1px solid rgb(192, 195, 198);
  border-radius: 2px;
  height: 12px;
  margin: 0 5px;
  padding: 0;
  position: relative;
  top: 1px;
  width: 12px;
}

button.menu-button.drop-down:hover {
  background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9IiMwMDAiIHdpZHRoPSI2IiBoZWlnaHQ9IjMiIHZpZXdib3g9IjAgMCA2IDMiPgogIDxwYXRoIGQ9Ik0wIDAgTDYgMCBMMyAzIiB3aWR0aD0iNiIgaGVpZ2h0PSIzIi8+Cjwvc3ZnPgo=);
  border-color: rgb(48, 57, 66);
}

button.menu-button.drop-down[menu-shown],
button.menu-button.drop-down:focus {
  background-color: rgb(48, 57, 66);
  background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9IiNmZmYiIHdpZHRoPSI2IiBoZWlnaHQ9IjMiIHZpZXdib3g9IjAgMCA2IDMiPgogIDxwYXRoIGQ9Ik0wIDAgTDYgMCBMMyAzIiB3aWR0aD0iNiIgaGVpZ2h0PSIzIi8+Cjwvc3ZnPgo=);
  border-color: rgb(48, 57, 66);
}

button.menu-button.using-mouse {
  outline: none;
}
</style>
<style>/* Copyright (c) 2012 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

.trash {
  -webkit-appearance: none;
  background: none;
  border: none;
  cursor: pointer;
  display: inline-block;
  outline: none;
  padding: 0;
  position: relative;
  width: 30px;
}

.trash > span {
  display: inline-block;
}

.trash > .can,
.trash > .lid {
  background: url(chrome://resources/images/trash.png) 0 0 no-repeat;
  left: 8px;
  position: absolute;
  right: 8px;
  top: 2px;
}

.trash > .lid {
  height: 6px;
  transform-origin: -7% 100%;
  transition: transform 150ms;
  width: 14px;
}

html[dir='rtl'] .trash > .lid {
  transform-origin: 107% 100%;
}

.trash:-webkit-any(:focus, :hover, .open) > .lid {
  transform: rotate(-45deg);
  transition: transform 250ms;
}

html[dir='rtl'] .trash:-webkit-any(:focus, :hover, .open) > .lid {
  transform: rotate(45deg);
}

.trash > .can {
  background-position: -1px -4px;
  height: 12px;
  /* The margins match the background position offsets. */
  margin-left: 1px;
  /* The right margin is one greater due to a shadow on the trash image. */
  margin-right: 2px;
  margin-top: 4px;
  width: 11px;
}
</style>
<style>/* Copyright (c) 2012 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

/* This file defines styles for form controls. The order of rule blocks is
 * important as there are some rules with equal specificity that rely on order
 * as a tiebreaker. These are marked with OVERRIDE. */

/* Copyright 2015 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be
 * found in the LICENSE file. */

[is='action-link'] {
  cursor: pointer;
  display: inline-block;
  text-decoration: none;
}

[is='action-link']:hover {
  text-decoration: underline;
}

[is='action-link']:active {
  color: rgb(5, 37, 119);
  text-decoration: underline;
}

[i